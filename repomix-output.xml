This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/workflows/playwright.yml
.gitignore
.husky/pre-commit
cannarewards-engine.php
composer.json
docs/ADR/001-service-oriented-architecture.md
docs/ADR/002-event-driven-communication.md
docs/ADR/003-psr4-autoloader-and-namespacing.md
docs/ADR/004-data-contracts-and-taxonomy.md
docs/ADR/007-Formalizing-Internal-Data-Contracts-with-DTOs-and-Value-Objects.md
docs/ADR/008-Formalizing-Observability-and-debugging.md
docs/ADR/009-decoupling-http-logic-with-responders
docs/Contributing.md
docs/Data_taxonomy/data_taxonomy.md
docs/Data_taxonomy/Seeddata.md
docs/openapi spec/notayaml.md
docs/Project genesis/project_genesis.md
includes/canna-core-functions.php
includes/CannaRewards/Admin/AchievementMetabox.php
includes/CannaRewards/Admin/AdminMenu.php
includes/CannaRewards/Admin/CustomFieldMetabox.php
includes/CannaRewards/Admin/ProductMetabox.php
includes/CannaRewards/Admin/TriggerMetabox.php
includes/CannaRewards/Admin/UserProfile.php
includes/CannaRewards/Api/AdminController.php
includes/CannaRewards/Api/ApiResponse.php
includes/CannaRewards/Api/AuthController.php
includes/CannaRewards/Api/CatalogController.php
includes/CannaRewards/Api/ClaimController.php
includes/CannaRewards/Api/DashboardController.php
includes/CannaRewards/Api/HistoryController.php
includes/CannaRewards/Api/OrdersController.php
includes/CannaRewards/Api/PageController.php
includes/CannaRewards/Api/ProfileController.php
includes/CannaRewards/Api/RedeemController.php
includes/CannaRewards/Api/ReferralController.php
includes/CannaRewards/Api/RulesController.php
includes/CannaRewards/Api/UnauthenticatedDataController.php
includes/CannaRewards/CannaRewardsEngine.php
includes/CannaRewards/Commands/CreateUserCommand.php
includes/CannaRewards/Commands/CreateUserCommandHandler.php
includes/CannaRewards/Commands/GrantPointsCommand.php
includes/CannaRewards/Commands/GrantPointsCommandHandler.php
includes/CannaRewards/Commands/ProcessProductScanCommand.php
includes/CannaRewards/Commands/ProcessProductScanCommandHandler.php
includes/CannaRewards/Commands/ProcessUnauthenticatedClaimCommand.php
includes/CannaRewards/Commands/ProcessUnauthenticatedClaimCommandHandler.php
includes/CannaRewards/Commands/RedeemRewardCommand.php
includes/CannaRewards/Commands/RedeemRewardCommandHandler.php
includes/CannaRewards/Commands/RegisterWithTokenCommand.php
includes/CannaRewards/Commands/RegisterWithTokenCommandHandler.php
includes/CannaRewards/Commands/UpdateProfileCommand.php
includes/CannaRewards/Commands/UpdateProfileCommandHandler.php
includes/CannaRewards/Domain/ValueObjects/EmailAddress.php
includes/CannaRewards/Domain/ValueObjects/UserId.php
includes/CannaRewards/DTO/FullProfileDTO.php
includes/CannaRewards/DTO/OrderDTO.php
includes/CannaRewards/DTO/RankDTO.php
includes/CannaRewards/DTO/SessionUserDTO.php
includes/CannaRewards/DTO/ShippingAddressDTO.php
includes/CannaRewards/Includes/DB.php
includes/CannaRewards/Includes/Event.php
includes/CannaRewards/Includes/Integrations.php
includes/CannaRewards/Policies/PolicyInterface.php
includes/CannaRewards/Policies/UserAccountIsUniquePolicy.php
includes/CannaRewards/Policies/UserCanAffordRedemptionPolicy.php
includes/CannaRewards/Repositories/AchievementRepository.php
includes/CannaRewards/Repositories/ActionLogRepository.php
includes/CannaRewards/Repositories/OrderRepository.php
includes/CannaRewards/Repositories/ProductRepository.php
includes/CannaRewards/Repositories/RewardCodeRepository.php
includes/CannaRewards/Repositories/UserRepository.php
includes/CannaRewards/Services/ActionLogService.php
includes/CannaRewards/Services/CDPService.php
includes/CannaRewards/Services/ConfigService.php
includes/CannaRewards/Services/ContentService.php
includes/CannaRewards/Services/ContextBuilderService.php
includes/CannaRewards/Services/EconomyService.php
includes/CannaRewards/Services/EventFactory.php
includes/CannaRewards/Services/GamificationService.php
includes/CannaRewards/Services/RankService.php
includes/CannaRewards/Services/ReferralService.php
includes/CannaRewards/Services/RuleConditionRegistryService.php
includes/CannaRewards/Services/RulesEngineService.php
includes/CannaRewards/Services/UserService.php
includes/class-canna-cdp-handler.php
includes/class-canna-custom-fields.php
includes/container.php
package.json
phpcs.xml.dist
playwright.config.js
README.MD
schemas/entities/user_snapshot.v1.json
schemas/events/product_scanned.v1.json
tests-api/api-contract-validator.js
tests-api/economy.spec.js
tests-api/healthcheck.spec.js
tests-api/onboarding.spec.js
tests-api/test-helper.php
tests-examples/demo-todo-app.spec.js
tests/example.spec.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".github/workflows/playwright.yml">
name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      run: npx playwright test
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
</file>

<file path=".gitignore">
# Playwright
node_modules/
/test-results/
/playwright-report/
/blob-report/
/playwright/.cache/
</file>

<file path="docs/ADR/001-service-oriented-architecture.md">
# ADR 001: Architectural Choice - Service-Oriented Monolith

**Date:** 2024-05-23

**Status:** Accepted

## Context

The initial codebase had business logic (for points, achievements, referrals) tightly coupled within the API controller classes (`Canna_Rewards_Controller`, etc.). This made adding new features or modifying existing ones "cumbersome," as a single change required editing multiple files and understanding a wide range of implicit dependencies. The architecture was brittle and did not have a clear separation of concerns.

## Decision

We will refactor the backend into a **Service-Oriented Architecture (SOA)** within a single WordPress plugin (a "well-organized monolith").

This involves creating a new `/services` directory. Each service will be a PHP class responsible for a single, distinct business domain:
-   `EconomyService`: Manages all logic for points and redemptions.
-   `GamificationService`: Manages all logic for achievements.
-   `ReferralService`: Manages all logic for the referral program.
-   And so on.

The API controllers in `/includes/api/` will be refactored to be "lean." Their only responsibility is to handle the HTTP request/response cycle and delegate all business logic to the appropriate service.

## Consequences

**Positive:**
-   **High Cohesion / Loose Coupling:** Logic is now grouped by business domain, making it easier to find, understand, and maintain.
-   **Increased Testability:** Each service can be instantiated and tested in isolation, improving code quality and reliability.
-   **Improved Developer Velocity:** Adding new features is simplified. For example, a "Product Reviews" feature would involve creating a new, self-contained `ReviewService` without modifying the core economic or gamification logic.

**Negative:**
-   Introduces a slightly higher level of abstraction than a simple controller-based model.
-   Requires discipline to maintain the separation of concerns and prevent services from becoming overly dependent on each other.

**Rejected Alternative: Microservices**
A full microservices architecture was considered but rejected due to the immense operational complexity (multiple deployments, databases, network latency) which is not justified at the current scale of the project. This SOA monolith provides 80% of the benefits with 10% of the complexity.
</file>

<file path="docs/ADR/002-event-driven-communication.md">
# ADR 002: Inter-Service Communication - Event-Driven Model

**Date:** 2024-05-23

**Status:** Accepted

## Context

With the move to a Service-Oriented Architecture (ADR 001), we need a defined pattern for how services communicate. A direct-call approach (e.g., `EconomyService` directly calling `new GamificationService()`) would re-introduce tight coupling and create a tangled web of dependencies between services.

## Decision

We will implement an **Event-Driven Architecture (EDA)** for inter-service communication. This will be facilitated by a simple, static `Event` broadcaster class (implementing the Observer pattern).

-   **Broadcasting:** Services will not call each other directly. Instead, after completing their core logic, they will broadcast a past-tense event, such as `Event::broadcast('product_scanned', $payload)`. The broadcaster knows nothing about who is listening.
-   **Listening:** Services that need to react to an event will subscribe to it in their constructor using `Event::listen('product_scanned', [$this, 'handler_method'])`.

The `RulesEngineService` will be deprecated, and its orchestration responsibilities will be distributed to these autonomous listeners.

## Consequences

**Positive:**
-   **Ultimate Decoupling:** Services are completely decoupled. The `EconomyService` has no knowledge of the `GamificationService` or `ReferralService`.
-   **Extensibility:** Adding new, cross-cutting logic is incredibly cheap and safe. A new service (e.g., `FraudDetectionService`) can simply listen for existing events without requiring any changes to the core services.
-   **Architectural Purity:** The codebase becomes a direct reflection of the business processes. Logic is clean, isolated, and easy to trace from event to listener.
-   **Foundation for Asynchronicity:** This pattern is a prerequisite for moving to a more scalable, asynchronous queue-based system in the future.

**Negative:**
-   **Increased Indirection:** The control flow is less explicit. To understand what happens after a scan, a developer must look for the `product_scanned` event broadcast and then find all the registered listeners for that event. This requires a bit more discipline to trace.
</file>

<file path="docs/ADR/003-psr4-autoloader-and-namespacing.md">
# ADR 003: Code Loading - Composer PSR-4 Autoloader

**Date:** 2024-05-23

**Status:** Accepted

## Context

The initial codebase used a long, manually maintained list of `require_once` statements in the main plugin file. This is a fragile, error-prone, and outdated method for loading PHP files. It created a hidden dependency on file load order and increased the cognitive overhead for developers.

## Decision

We will completely remove the manual `require_once` system and adopt the industry-standard **PSR-4 autoloader managed by Composer.**

1.  **Namespacing:** All classes will be moved into a root `CannaRewards` namespace.
2.  **Directory Structure:** All class files will be reorganized into a PSR-4 compliant directory structure under `includes/CannaRewards/`.
3.  **File Naming:** All files will be renamed to match their class names exactly (e.g., `class EconomyService` will live in `includes/CannaRewards/Services/EconomyService.php`).
4.  **`composer.json`:** The `autoload` directive will be configured to map the `CannaRewards\` namespace to the `includes/CannaRewards/` directory.
5.  **Bootstrap:** The main plugin file will be gutted and replaced with a single call to `require_once 'vendor/autoload.php';`.

## Consequences

**Positive:**
-   **Modern Standard:** Aligns the project with modern PHP development best practices.
-   **Eliminates Load Order Errors:** The autoloader automatically resolves dependencies, removing an entire class of potential fatal errors.
-   **Improved Developer Experience:** Developers no longer need to manage a long list of includes. New classes are automatically available for use after running `composer dump-autoload`.
-   **Code Clarity:** Namespaces prevent conflicts with other plugins and make the code's structure explicit and easy to understand.

**Negative:**
-   Requires a one-time, meticulous effort to rename and move all existing class files.
-   Adds Composer as a hard dependency for the project's development.
</file>

<file path="docs/ADR/004-data-contracts-and-taxonomy.md">
# ADR 004: Data Contracts - OpenAPI and Data Taxonomy

**Date:** 2024-05-23

**Status:** Accepted

## Context

The communication contract between the frontend PWA, the backend API, and the external Customer Data Platform (CDP) was not formally defined. This leads to ambiguity, potential for inconsistent data, and difficulty in parallel development.

## Decision

We will adopt a strict "contract-first" approach for all data interfaces, formalized in two key documents:

1.  **The API Contract (`openapi.yaml`):**
    *   An OpenAPI 3.0 specification will be the single source of truth for the backend's REST API.
    *   It will define every endpoint, its parameters, and its exact request/response schemas.
    *   This enables automated documentation, client/server code generation, and API testing.

2.  **The Data Taxonomy & Tracking Plan:**
    *   A human-readable document (e.g., in Notion) that defines the complete schema for all events sent to the CDP.
    *   It will define standardized, reusable objects (`user_snapshot`, `product_snapshot`, `event_context`) to ensure all analytical data is consistent and richly contextual.
    *   All new tracking requests must be formalized in this document *before* implementation.

## Consequences

**Positive:**
-   **Enables Parallel Development:** Frontend and backend teams can work simultaneously against the shared OpenAPI contract.
-   **Single Source of Truth:** Eliminates ambiguity. The contracts, not the code, are the ultimate authority on how the systems communicate.
-   **High-fidelity Data:** The Data Taxonomy ensures that our most valuable asset‚Äîour customer data‚Äîis clean, consistent, and structured for maximum utility by AI and marketing automation platforms.
-   **Improved Onboarding:** New developers can understand the entire data flow of the application by reading these two documents.

**Negative:**
-   Adds a layer of process. Development of a new endpoint now requires an upfront investment in defining its contract. This is a deliberate trade-off in favor of long-term quality and maintainability.
</file>

<file path="docs/ADR/007-Formalizing-Internal-Data-Contracts-with-DTOs-and-Value-Objects.md">
ADR 007: Formalizing Internal Data Contracts with DTOs and Value Objects
Status: Proposed
Context:
Currently, data passed between internal layers of the application (e.g., from a Service to a Controller, or from a Repository to a Service) is primarily in the form of associative arrays. This is a common source of bugs. A typo in an array key ('points_balanc') is not caught until runtime. Furthermore, primitive types like string and int do not carry any business context (e.g., is this int a UserId or a ProductId?). This leads to scattered validation logic and makes the code harder to reason about.
Decision:
We will implement two patterns to create strong, internal data contracts:
Value Objects: For core, primitive-like business concepts, we will create small, immutable classes that validate themselves upon creation. An EmailAddress class, for instance, cannot be instantiated with a malformed string. A UserId cannot be created with a negative integer. This makes invalid states unrepresentable.
Data Transfer Objects (DTOs): For all structured data moving between application layers (especially data returned from services), we will use simple, public-property DTO classes. Instead of a service returning a complex array, it will return a UserProfileDTO object. This provides IDE autocompletion, static analysis benefits, and serves as self-documenting code.
Consequences:
Positive:
Eliminates an entire class of bugs: Typos in data keys and passing of invalid primitive types are caught at creation time or by static analysis, not in production.
Massively Improved Developer Experience: IDE autocompletion makes the code faster and more enjoyable to write.
Self-Documenting: The DTO classes themselves become the definitive, always-up-to-date documentation for the application's internal data structures.
Negative:
Increased Boilerplate: This requires writing more small classes, which can feel verbose for a simple application. This is a trade-off for long-term stability and clarity.
</file>

<file path="docs/ADR/008-Formalizing-Observability-and-debugging.md">
ADR 008: Formalizing Observability and Debugging
Status: Proposed
Context:
The current debugging workflow relies on error_log() and manual inspection. This is inefficient and provides insufficient context to diagnose issues, especially in a production environment. When an error occurs, it's difficult to know which user was affected, what data they submitted, or the sequence of events that led to the failure.
Decision:
We will implement a three-tiered observability strategy to provide a professional-grade debugging experience.
Local Development: Xdebug. We will adopt Xdebug as the standard for local development. This enables interactive, step-through debugging, allowing developers to pause code execution and inspect the full application state at any point. This replaces the inefficient var_dump(); die(); workflow.
Structured Logging: Monolog. All error_log() calls will be replaced with a centralized LoggerService built on the Monolog library. All logs will be written as structured JSON, including rich context (e.g., user_id, request data, exception traces). This makes logs searchable, filterable, and machine-readable.
Production Surveillance: Sentry. We will integrate an error tracking service (like Sentry) into the production environment. This will automatically capture all unhandled exceptions, group them, and provide a rich dashboard with the full context needed to diagnose and resolve production bugs before users report them.
Consequences:
Positive:
Drastically Reduced Debugging Time: Step-debugging with Xdebug can reduce the time to find the root cause of a local bug by an order of magnitude.
Actionable Production Alerts: Sentry provides immediate, context-rich alerts for production failures, turning unknown problems into well-defined tasks.
Improved System Visibility: Structured logs provide a clear, searchable history of application events, crucial for understanding complex user interactions.
Negative:
Initial Setup Cost: Each of these tools requires a one-time setup and configuration investment.
Minor Performance Overhead: Production logging and error tracking add a small amount of overhead to each request. This is a standard and acceptable cost for production visibility.
</file>

<file path="docs/ADR/009-decoupling-http-logic-with-responders">
ADR 009: Decoupling HTTP Logic with Responders
Status: Proposed
Context:
Currently, API controllers are responsible for creating WP_REST_Response and WP_Error objects. This couples the application's business logic outcomes to the specifics of the HTTP layer (e.g., status codes, headers). This leads to minor inconsistencies and makes the controllers harder to test in isolation.
Decision:
We will implement the Responder Pattern. Controllers will no longer return WordPress response objects. Instead, they will return simple, dedicated "Responder" objects that represent a specific outcome (e.g., ResourceCreatedResponder, ValidationFailedResponder, NotFoundResponder). A thin middleware layer in the REST API bootstrap will be responsible for taking these Responder objects and converting them into the final WP_REST_Response.
Consequences:
Positive:
Perfect API Consistency: A NotFoundResponder will always generate the exact same 404 Not Found response, with the same JSON structure, regardless of which controller returned it. This strengthens the API contract.
Decoupled and Testable Controllers: Controllers now only contain application logic. They are no longer concerned with HTTP status codes, making them simpler and easier to unit test.
Clearer Application Flow: The return type of a controller method explicitly states the possible outcomes of the action.
Negative:
Increased Indirection: This adds another layer of abstraction between the controller and the final HTTP response.
</file>

<file path="docs/Contributing.md">
# CannaRewards Contribution Guidelines

**Version:** 1.0
**Status:** `LOCKED-IN`

## üöÄ Welcome

Thank you for contributing to the CannaRewards platform. This document is the single source of truth for our development workflow, coding standards, and architectural principles. Adherence to these guidelines is mandatory for all contributions to ensure the long-term health, quality, and maintainability of the codebase.

## üèõÔ∏è Core Architectural Principles

Before writing any code, it is essential to understand the architectural philosophy that governs this project. All contributions will be evaluated against these principles. The "why" behind these decisions is documented in our **Architectural Decision Records (ADRs)** located in `/docs/adr`.

1.  **Service-Oriented Monolith (ADR-001):** The backend is a "well-organized monolith," not a distributed system. All business logic is encapsulated in distinct, single-responsibility services (e.g., `EconomyService`, `GamificationService`). Controllers are thin and stateless.
2.  **Event-Driven Communication (ADR-002):** Services are fully decoupled and communicate asynchronously via a central `Event` broadcaster. Services **do not** call each other directly. They listen for events and react to them.
3.  **Contracts First (ADR-003):** All data interfaces are defined before implementation.
    -   The **API Contract (`openapi.yaml`)** is the immutable blueprint for the REST API.
    -   The **Data Taxonomy (Notion)** is the immutable blueprint for all CDP events.
    -   **Any change to an API or a CDP event must be proposed and approved in these documents *before* a single line of code is written.**

## ‚öôÔ∏è The Development Workflow: A Step-by-Step Guide

We follow a structured workflow to ensure consistency and quality.

### Step 1: The Ticket

-   All work must begin with a ticket in our project management system (e.g., Jira, Linear, Trello).
-   A ticket must have a clear title, a detailed description of the user story or bug, and explicit **Acceptance Criteria**.

### Step 2: The Branch

-   All work must be done on a feature branch created from the `develop` branch.
-   **Branch Naming Convention:** Branches must be named using the format `[type]/[ticket-id]-[short-description]`.
    -   `feat/CR-123-wishlist-api`
    -   `fix/CR-124-cors-issue-on-claim`
    -   `chore/CR-125-update-dependencies`
-   The `main` and `develop` branches are protected. Direct pushes are disabled.

### Step 3: The Code

-   **Code Style & Quality:** Code style is non-negotiable and is automatically enforced by a **Husky pre-commit hook**.
    -   **Frontend:** ESLint and Prettier are used.
    -   **Backend:** PHPCS with the WordPress Coding Standards rule set is used.
    -   **Commits that do not pass linting will be automatically blocked.**
-   **In-Code Documentation:** All public classes and methods **must** have a complete PHPDoc or JSDoc block explaining their purpose, parameters, and return values.
-   **Testing:** All new business logic added to a Service **must** be accompanied by a corresponding unit test (PHPUnit for backend). All new user-facing flows on the frontend **must** be accompanied by a corresponding End-to-End (E2E) test (Cypress/Playwright).

### Step 4: The Pull Request (PR)

The Pull Request is our primary quality gate.

-   All feature branches must be merged into `develop` via a PR.
-   **PR Title:** The PR title must follow the [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) specification. This is mandatory as it is used to automate changelogs.
    -   `feat: Implement Wishlist API endpoints`
    -   `fix: Resolve fatal error in GamificationService`
    -   `docs: Update OpenAPI spec for the new Dashboard endpoint`
-   **PR Description:** The PR description must be filled out using our template:
    -   **Link to Ticket:** A mandatory link to the corresponding project management ticket.
    -   **Summary of Changes:** A clear, concise explanation of what was built or fixed.
    -   **Testing Instructions:** A step-by-step guide for the reviewer on how to manually verify the changes in a staging environment.
-   **Automated Checks (CI):** A PR cannot be merged until all automated checks (linting, tests, project build) have passed. The "Merge" button will be disabled.
-   **Code Review:** All PRs must be reviewed and approved by at least one other team member. For solo developers, this means performing a thorough self-review, stepping through every line of code as if you were another person.

### Step 5: The Merge & Deploy

-   Once a PR is approved and all checks have passed, it can be merged into `develop`.
-   A merge to `develop` automatically triggers a deployment to the **Staging** environment.
-   Releases to production are done by creating a new PR from `develop` into `main`. A merge to `main` automatically triggers a deployment to the **Production** environment.

## ü™µ Logging & Debugging

-   **Backend:** Use the standard `error_log()` function for debugging. Do not leave `var_dump()` or `echo` statements in committed code.
-   **Frontend:** Use `console.log()`, `console.warn()`, and `console.error()` appropriately. Remove all debugging logs before submitting a PR unless they are providing a valuable, intentional warning to other developers.

By adhering to these rules, we ensure that the CannaRewards platform remains a clean, stable, and professional codebase that is a pleasure to work on.
</file>

<file path="docs/Data_taxonomy/data_taxonomy.md">
User snapshot

| Property Path | Data Type | Description | Example | Source/Notes |
| :--- | :--- | :--- | :--- | :--- |
| **identity** | *(Object)* | Core, immutable identifiers for the user. | | |
| `identity.user_id` | Integer | The unique WordPress ID for the user. | `123` | `wp_users.ID` |
| `identity.email` | String | The user's email address. | `jane.doe@example.com` | `wp_users.user_email` |
| `identity.first_name` | String | The user's first name. | `Jane` | `wp_usermeta.first_name`. Nullable. |
| `identity.is_guest` | Boolean | True if the user is not authenticated. | `false` | For future use |
| `identity.created_at` | Timestamp | ISO 8601 timestamp (UTC) of user registration. | `2024-05-21T10:00:00Z` | `wp_users.user_registered` |
| **economy** | *(Object)* | Data related to the user's standing in the points economy. | | |
| `economy.points_balance` | Integer | The user's current spendable point balance. | `1850` | `_canna_points_balance` |
| `economy.lifetime_points`| Integer | The user's total accumulated points, used for ranking. | `6100` | `_canna_lifetime_points` |
| `economy.points_spent_total` | Integer | **Calculated.** Cumulative total of all points the user has redeemed. | `4250` | `SUM from log` |
| `economy.currency_name` | String | The brand's configured name for points. | `Buds` | From `ConfigService`. |
| **status** | *(Object)* | Data related to the user's current status and rank. | | |
| `status.rank_key` | String | The machine-readable key for the user's current rank. | `gold` | `_canna_current_rank_key` |
| `status.rank_name` | String | The human-readable name of the user's current rank. | `Gold` | From `Rank` CPT. |
| `status.rank_multiplier`| Number | The point multiplier associated with the user's current rank. | `1.5` | From `Rank` CPT meta. |
| `status.status_name` | String | The brand's configured name for ranks. | `Status` | From `ConfigService`. |
| **engagement** | *(Object)* | **Calculated** metrics describing the user's activity level. | | |
| `engagement.total_scans` | Integer | **Calculated.** The total number of successful product scans. | `12` | `COUNT from action_log where action=scan` |
| `engagement.total_redemptions` | Integer | **Calculated.** The total number of successful reward redemptions. | `2` | `COUNT from action_log where action=redeem` |
| `engagement.total_achievements_unlocked` | Integer | **Calculated.** The total count of unlocked achievements. | `5` | `COUNT from user_achievements table` |
| `engagement.days_since_signup`| Integer | **Calculated.** Days since `identity.created_at`. | `90` | `(NOW - created_at)` |
| `engagement.days_since_last_session`| Integer | **Calculated.** Days since the user's last `user_session_started` event. | `1` | `(NOW - last_session_timestamp)` |
| `engagement.days_since_last_scan`| Integer | **Calculated.** Days since the user's last `user_completed_scan` event. | `5` | `(NOW - last_scan_timestamp)` |
| `engagement.days_since_last_redemption`| Integer | **Calculated.** Days since the user's last `user_reward_redeemed` event. | `25` | `(NOW - last_redemption_timestamp)`|
| `engagement.is_dormant` | Boolean | **Calculated.** True if `days_since_last_session` > 30 (configurable). | `false` | |
| `engagement.is_power_user` | Boolean | **Calculated.** True if user meets configured criteria (e.g., top 10% of lifetime_points). | `true` | |
| **profile_data** | *(Object)* | Zero-party data explicitly provided by the user. | | |
| `profile_data.phone_number`| String | The user's phone number. | `+15551234567` | `wp_usermeta.phone_number`. Stored in E.164 format. |
| `profile_data.custom_*` | Varies | All saved values for configured Custom Fields, prefixed with `custom_`. | `Sativa` | Key is `custom_[meta_key]`. |
| **compliance_and_contact**| *(Object)* | Data related to user consent and legal compliance. | | |
| `compliance_and_contact.is_age_verified`| Boolean | True if user checked the "I am 21+" box during registration. | `true` | `_age_gate_confirmed_at` exists |
| `compliance_and_contact.age_verified_at`| Timestamp | ISO 8601 of when the age was verified. | `2024-05-21T10:00:00Z` | `_age_gate_confirmed_at` |
| `compliance_and_contact.has_marketing_consent`| Boolean | True if the user opted-in to marketing communications. | `true` | `wp_usermeta.marketing_consent` |
| `compliance_and_contact.marketing_consent_updated_at`| Timestamp | ISO 8601 of the last consent change. | `2024-05-21T10:00:00Z` | Meta field update timestamp |
| **referral_data** | *(Object)* | Data related to the user's participation in the referral program. | | |
| `referral_data.referral_code`| String | The user's personal referral code to share. | `JANE1A2B` | `_canna_referral_code` |
| `referral_data.referred_by_user_id`| Integer | The ID of the user who referred them, if any. | `456` | `_canna_referred_by_user_id`. Nullable. |
| `referral_data.total_referrals_completed`| Integer | **Calculated.** The number of new users they referred who completed their first scan. | `3` | `COUNT from action_log where action=referral_converted` |

product_snapshot

| Property Path | Data Type | Description | Example |
| :--- | :--- | :--- | :--- |
| **identity** | *(Object)* | Core, immutable identifiers for the product. | |
| `identity.product_id` | Integer | The unique WooCommerce ID for the product. | `45` |
| `identity.sku` | String | The product's Stock Keeping Unit. | `BD-VAPE-1G` |
| `identity.product_name` | String | The full name of the product. | `Blue Dream 1g Vape` |
| **economy** | *(Object)*| Data related to the product's value in the loyalty economy. | |
| `economy.points_award`| Integer | Points awarded for scanning this product. | `400` |
| `economy.points_cost` | Integer | Points required to redeem this product. | `5000` |
| `economy.msrp` | Number | Manufacturer's Suggested Retail Price. | `45.00` |
| **taxonomy** | *(Object)*| Classifications and categories for the product. | |
| `taxonomy.product_line`| String | The brand's internal product family (from Category). | `Signature Series` |
| `taxonomy.product_form`| String | Standardized physical format (from Attribute). | `Vape Cartridge` |
| `taxonomy.strain_name` | String | Common name of the strain (from Attribute). | `Blue Dream` |
| `taxonomy.strain_type` | String | Standardized genetic profile (from Attribute). | `Sativa` |
| `taxonomy.tags` | Array | Array of all associated product tags. | `["effect-energetic", "flavor-sweet", "new-release"]`|
| **attributes** | *(Object)*| Specific, objective data about the product. | |
| `attributes.potency_thc_percent`| Number | Percentage of THC. | `88.5` |
| `attributes.potency_cbd_percent`| Number | Percentage of CBD. | `0.8` |
| `attributes.dominant_terpene`| String | The primary terpene. | `Myrcene` |
| **merchandising** | *(Object)*| Flags used for dynamic UI presentation in the PWA. | |
| `merchandising.is_featured`| Boolean | True if the product is marked as featured. | `false` |
| `merchandising.is_new` | Boolean | **Calculated.** True if current date is before `new_until` date. | `true` |
| `merchandising.is_limited` | Boolean | True if `redemption_limit` is set and low. | `false` |
| `merchandising.is_digital` | Boolean | True if the product is a digital good. | `false` |

event_context

| Property Path | Data Type | Description | Example |
| :--- | :--- | :--- | :--- |
| **time** | *(Object)*| All data related to when the event occurred. | |
| `time.timestamp_utc` | Timestamp | ISO 8601 timestamp of the event in UTC. | `2024-05-22T18:35:12Z` |
| `time.timestamp_local` | Timestamp | ISO 8601 with timezone offset of the user. | `2024-05-22T11:35:12-07:00` |
| `time.day_of_week_local` | String | The day of the week in the user's local timezone. | `Wednesday` |
| `time.hour_of_day_local` | Integer | The hour of the event in the user's local timezone (0-23). | `11` |
| `time.is_weekend` | Boolean | True if the event occurred on a weekend. | `false` |
| **device** | *(Object)*| All data related to the device that initiated the event. | |
| `device.device_type` | String | Inferred from User-Agent. | `mobile` |
| `device.os` | String | Inferred from User-Agent. | `iOS` |
| `device.browser` | String | Inferred from User-Agent. | `Safari` |
| `device.user_agent` | String | Full User-Agent string. | `Mozilla/5.0...` |
| **location** | *(Object)*| All geographic data related to the event. | |
| `location.ip_address` | String | The IP address of the request. | `216.3.128.12` |
| `location.geo_city` | String | City derived from IP lookup. | `Los Angeles` |
| `location.geo_region` | String | State/Region derived from IP lookup. | `California` |
| `location.geo_country` | String | Country derived from IP lookup. | `USA` |

shipping_details

| Property Path | Data Type | Description |
| :--- | :--- | :--- |
| `shipping_details.first_name`| String | First name for the shipment. |
| `shipping_details.last_name`| String | Last name for the shipment. |
| `shipping_details.address_1`| String | Primary address line. |
| `shipping_details.city` | String | City for the shipment. |
| `shipping_details.state` | String | State/Region for the shipment. |
| `shipping_details.postcode` | String | Postal code for the shipment. |
</file>

<file path="docs/Data_taxonomy/Seeddata.md">
-- CannaRewards Seed Data
-- This script populates a fresh database with essential data for local development.
-- Import this file into your WordPress database using a tool like Adminer.

-- Clear existing loyalty data to ensure a clean slate
DELETE FROM wp_usermeta WHERE meta_key LIKE '_canna_%';
TRUNCATE TABLE wp_canna_achievements;
TRUNCATE TABLE wp_canna_user_achievements;
TRUNCATE TABLE wp_canna_user_action_log;
TRUNCATE TABLE wp_canna_reward_codes;
DELETE FROM wp_posts WHERE post_type IN ('canna_rank', 'canna_achievement', 'canna_custom_field', 'canna_trigger');
DELETE FROM wp_postmeta WHERE post_id NOT IN (SELECT ID FROM wp_posts);


-- RANKS
-- Note: Post IDs (first value) may need to be adjusted if you have existing content.
INSERT INTO `wp_posts` (`ID`, `post_author`, `post_date`, `post_date_gmt`, `post_content`, `post_title`, `post_excerpt`, `post_status`, `comment_status`, `ping_status`, `post_password`, `post_name`, `to_ping`, `pinged`, `post_modified`, `post_modified_gmt`, `post_content_filtered`, `post_parent`, `guid`, `menu_order`, `post_type`, `post_mime_type`, `comment_count`) VALUES
(1001, 1, NOW(), NOW(), '', 'Bronze', '', 'publish', 'closed', 'closed', '', 'bronze', '', '', NOW(), NOW(), '', 0, 'http://your-site.local/?post_type=canna_rank&#038;p=1001', 0, 'canna_rank', '', 0),
(1002, 1, NOW(), NOW(), '', 'Silver', '', 'publish', 'closed', 'closed', '', 'silver', '', '', NOW(), NOW(), '', 0, 'http://your-site.local/?post_type=canna_rank&#038;p=1002', 0, 'canna_rank', '', 0),
(1003, 1, NOW(), NOW(), '', 'Gold', '', 'publish', 'closed', 'closed', '', 'gold', '', '', NOW(), NOW(), '', 0, 'http://your-site.local/?post_type=canna_rank&#038;p=1003', 0, 'canna_rank', '', 0);

INSERT INTO `wp_postmeta` (`post_id`, `meta_key`, `meta_value`) VALUES
(1001, 'points_required', '1000'),
(1001, 'point_multiplier', '1.2'),
(1001, 'benefits', 'Access to Bronze-tier rewards'),
(1002, 'points_required', '5000'),
(1002, 'point_multiplier', '1.5'),
(1002, 'benefits', 'Early access to new drops\r\nExclusive merch'),
(1003, 'points_required', '10000'),
(1003, 'point_multiplier', '2.0'),
(1003, 'benefits', '2x points on all scans\r\nPriority support');


-- ACHIEVEMENTS (Example)
INSERT INTO `wp_posts` (`ID`, `post_title`, `post_name`, `post_type`, `post_status`) VALUES (1004, 'First Scan', 'first_scan', 'canna_achievement', 'publish');
INSERT INTO `wp_postmeta` (`post_id`, `meta_key`, `meta_value`) VALUES
(1004, 'achievement_key', 'first_scan'),
(1004, 'points_reward', '100'),
(1004, 'rarity', 'common'),
(1004, 'trigger_event', 'product_scanned'),
(1004, 'trigger_count', '1'),
(1004, 'conditions', '');


-- TRIGGERS (Example)
INSERT INTO `wp_posts` (`ID`, `post_title`, `post_name`, `post_type`, `post_status`) VALUES (1005, 'Referrer Conversion Bonus', 'referrer-conversion-bonus', 'canna_trigger', 'publish');
INSERT INTO `wp_postmeta` (`post_id`, `meta_key`, `meta_value`) VALUES
(1005, 'event_key', 'referral_converted'),
(1005, 'action_type', 'grant_points'),
(1005, 'action_value', '500');

-- Note: This seed file does not create sample users or products, as those are better created
-- through the WordPress admin UI for a more realistic testing environment.

-- END OF SEED DATA
</file>

<file path="docs/Project genesis/project_genesis.md">
Of course. Understood.

Here is the `PROJECT_GENESIS.md` document, rewritten to be purely analytical, objective, and devoid of figurative language.

---

### **`PROJECT_GENESIS.md` (Analytical Edition)**

**Status:** `LOCKED-IN`
**Version:** 2.0.0
**Purpose:** This document specifies the strategic and operational parameters of the CannaRewards platform.

---

## 1. Business Model & Market Position

**System:** A white-label B2B2C loyalty and data collection platform.
**Client:** Cannabis CPG brands.
**Revenue Model:** Flat-rate monthly subscription fee.
**Service Deliverable:** A technology and service package composed of a Progressive Web App (PWA), backend management, and marketing automation operation. The primary function is to convert physical product packaging into a D2C data channel.

**Target Client Profile (ICP):**
-   **Revenue:** $500,000 to $4,000,000 USD monthly.
-   **Market Rank:** Approximately #10 to #75 by revenue in their state.
-   **Operational Characteristics:** Independent, founder-led CPG brands with demonstrated product-market fit. These entities typically lack dedicated in-house data science, CRM, or software engineering departments.
-   **Non-Target:** Multi-State Operators (MSOs) are excluded due to structural and operational misalignment with the DFY service model.

**Problem Statement:**
Cannabis CPG brands lack a direct data link to end-consumers due to the three-tier distribution system (producer -> distributor -> retailer). This results in zero first-party data regarding consumer demographics or behavior.

**Solution:** The platform establishes this data link by incentivizing consumers to scan an on-pack QR code, enabling direct data capture and communication.

**Long-Term Objective:** To become the dominant D2C intelligence platform for independent cannabis brands, creating a proprietary dataset on consumer behavior that provides a competitive advantage against larger operators.

---

## 2. Go-to-Market & Sales Process

**Pricing Model:**
-   **Rate:** A single, fixed price of $4,000 USD per month.
-   **Scope:** Includes all software features, QR code generation, customer profile storage, and DFY service hours for campaign management.
-   **Client Responsibility:** The client is responsible for the Cost of Goods Sold (COGS) for all physical reward merchandise.

**Sales Process:**
-   **Method:** A multi-channel outreach ("C-Suite Blitz") targeting C-level executives.
-   **Core Asset:** A non-functional, visually accurate, and client-branded PWA demo, customized via URL parameters.
-   **Value Proposition:** The sales process is a quantitative exercise focused on demonstrating projected ROI. An ROI Scorecard is used to model the financial return based on the client's specific business metrics, justifying the monthly fee as a revenue-generating activity.

---

## 3. User Acquisition Funnel

**Key Performance Indicator (KPI):** Achieve and sustain a >10% adoption rate (scans per unit sold).

**Physical Asset:** An on-pack, die-cut holographic sticker ("Authenticity Seal") with a direct call-to-action (`SCAN TO STACK`) and a value proposition (`First scan unlocks free gear`).

**Onboarding Workflow:** A sequential process designed to maximize conversion by front-loading value and delaying data input friction.
1.  **Scan:** User scans the QR code.
2.  **Claim:** PWA displays a free physical product.
3.  **Ship:** A modal collects the minimum data required for both account creation and physical shipment (Name, Address, Email, Terms).
4.  **Confirm:** A `claim-unauthenticated` API endpoint executes three actions: creates the user account, generates a zero-dollar WooCommerce order for the gift, and dispatches a magic link email for account activation.
5.  **Activate:** User clicks the magic link to log in, completing the loop.

---

## 4. User Retention & Engagement

**Initial Engagement ("Welcome Streak"):** A predefined, high-value reward schedule for a user's first three scans to establish a behavioral pattern.
-   **Scan 1:** 1x Physical Product + Base Points.
-   **Scan 2:** 2x Point Multiplier.
-   **Scan 3:** 1x Achievement Unlock + Bonus Points.

**Long-Term Engagement (The Wishlist/Goal System):**
-   The primary long-term retention mechanic is a user-defined "Active Goal" selected from their Wishlist. This goal is persistently displayed on the user's dashboard with a progress bar, providing a clear objective for point accumulation.

---

## 5. Points & Rewards Economy

**Point Issuance (Earning):**
-   **Primary Rule:** 10 Points awarded per $1 of the product's MSRP. This requires an `msrp` data field in the client's Product Information Management (PIM) system.
-   **Secondary Rule:** Fixed point amounts awarded via the Achievement and Trigger systems.

**Point Redemption (Spending):**
-   **Primary Rule:** The point cost of a reward is pegged to its hard Cost of Goods Sold (COGS) to the client.
-   **Target Peg:** 1 Point ‚âà $0.01 of COGS.

**Economic Model:** The system is calibrated to provide a 7-10% value-back to the end-consumer. This rate is designed to be highly competitive to drive adoption and retention.

---

## 6. Competitive Positioning

The platform is positioned as a new market category to make direct competitors irrelevant.
-   **Not** a simple authentication tool (e.g., Cannverify).
-   **Not** a complex, self-service enterprise platform (e.g., Batch).
-   **Is** a "Done-For-You Customer Intelligence Platform" targeting the specific operational and financial constraints of the mid-market.

---

## 7. Technology Architecture

The system is a decoupled, three-part stack.
-   **Backend:** A headless WordPress installation utilizing a Service-Oriented, Event-Driven architecture. It functions as a backend-as-a-service (BaaS) for the PWA.
-   **Frontend:** A Next.js Progressive Web App (PWA) focused on performance and user experience, deployed on a global edge network (Vercel).
-   **Customer Data Platform (CDP):** Customer.io is the designated system for ingesting the enriched event stream from the backend. It handles all user segmentation, marketing automation workflows, and AI-driven personalization.
</file>

<file path="includes/CannaRewards/Admin/CustomFieldMetabox.php">
<?php
namespace CannaRewards\Admin;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Defines the metabox for the CannaRewards Custom Field CPT.
 */
class CustomFieldMetabox {

    public function __construct() {
        add_action('add_meta_boxes', [$this, 'add_metabox']);
        add_action('save_post_canna_custom_field', [$this, 'save_data']);
    }

    public function add_metabox() {
        add_meta_box(
            'canna_custom_field_details',
            __('Field Configuration', 'canna-rewards'),
            [$this, 'render_metabox'],
            'canna_custom_field',
            'normal',
            'high'
        );
    }

    public function render_metabox($post) {
        wp_nonce_field('canna_save_custom_field_data', 'canna_custom_field_nonce');
        
        $meta_key = get_post_meta($post->ID, 'meta_key', true);
        $field_type = get_post_meta($post->ID, 'field_type', true);
        $options = get_post_meta($post->ID, 'options', true);
        $display_location = (array) get_post_meta($post->ID, 'display_location', true);

        ?>
        <p>The <strong>Field Label</strong> is the post title above. This will be shown to the user in the PWA.</p>
        <hr>
        <table class="form-table">
            <tbody>
                <tr>
                    <th scope="row"><label for="meta_key">Meta Key</label></th>
                    <td>
                        <input type="text" id="meta_key" name="meta_key" value="<?php echo esc_attr($meta_key); ?>" class="regular-text" required />
                        <p class="description">The machine-readable key saved in the database (e.g., favorite_strain_type). Should be lowercase with underscores.</p>
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="field_type">Field Type</label></th>
                    <td>
                        <select id="field_type" name="field_type">
                            <option value="text" <?php selected($field_type, 'text'); ?>>Text</option>
                            <option value="date" <?php selected($field_type, 'date'); ?>>Date</option>
                            <option value="dropdown" <?php selected($field_type, 'dropdown'); ?>>Dropdown</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="options">Options</label></th>
                    <td>
                        <textarea id="options" name="options" rows="3" class="large-text" placeholder="Red&#x0a;Green&#x0a;Blue"><?php echo esc_textarea($options); ?></textarea>
                        <p class="description">For "Dropdown" type only. Enter one option per line.</p>
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label>Display Location</label></th>
                    <td>
                        <fieldset>
                            <label><input type="checkbox" name="display_location[]" value="edit_profile" <?php checked(in_array('edit_profile', $display_location, true)); ?>> Edit Profile Modal</label><br>
                            <label><input type="checkbox" name="display_location[]" value="registration" <?php checked(in_array('registration', $display_location, true)); ?>> Registration Form</label>
                        </fieldset>
                    </td>
                </tr>
            </tbody>
        </table>
        <?php
    }

    public function save_data($post_id) {
        if (!isset($_POST['canna_custom_field_nonce']) || !wp_verify_nonce($_POST['canna_custom_field_nonce'], 'canna_save_custom_field_data')) {
            return;
        }
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
            return;
        }
        if (get_post_type($post_id) !== 'canna_custom_field' || !current_user_can('edit_post', $post_id)) {
            return;
        }

        update_post_meta($post_id, 'meta_key', isset($_POST['meta_key']) ? sanitize_key($_POST['meta_key']) : '');
        update_post_meta($post_id, 'field_type', isset($_POST['field_type']) ? sanitize_text_field($_POST['field_type']) : 'text');
        update_post_meta($post_id, 'options', isset($_POST['options']) ? sanitize_textarea_field($_POST['options']) : '');
        update_post_meta($post_id, 'display_location', isset($_POST['display_location']) ? array_map('sanitize_text_field', (array) $_POST['display_location']) : []);
    }
}
</file>

<file path="includes/CannaRewards/Admin/ProductMetabox.php">
<?php
namespace CannaRewards\Admin;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Handles the custom metabox for CannaRewards product settings.
 */
class ProductMetabox {

    public static function init() {
        add_action('add_meta_boxes', [self::class, 'add_metabox']);
        add_action('save_post_product', [self::class, 'save_metabox_data']);
    }

    public static function add_metabox() {
        add_meta_box(
            'canna_product_settings_metabox',
            'CannaRewards Product Settings',
            [self::class, 'render_metabox_html'],
            'product',
            'normal',
            'high'
        );
    }

    public static function render_metabox_html($post) {
        wp_nonce_field('canna_product_settings_save', 'canna_product_settings_nonce');

        $points_award = get_post_meta($post->ID, 'points_award', true);
        $points_cost = get_post_meta($post->ID, 'points_cost', true);
        $required_rank_slug = get_post_meta($post->ID, '_required_rank', true);
        $marketing_snippet = get_post_meta($post->ID, 'marketing_snippet', true);

        $ranks = get_posts([
            'post_type' => 'canna_rank',
            'posts_per_page' => -1,
            'orderby' => 'meta_value_num',
            'meta_key' => 'points_required',
            'order' => 'ASC',
        ]);
        ?>
        <table class="form-table">
            <tbody>
                <tr>
                    <th><label for="canna_points_award">Points Awarded (on scan)</label></th>
                    <td>
                        <input type="number" id="canna_points_award" name="canna_points_award" value="<?php echo esc_attr($points_award); ?>" class="short" />
                        <p class="description">Enter the number of base points a user receives for scanning this product's QR code.</p>
                    </td>
                </tr>
                <tr>
                    <th><label for="canna_points_cost">Points Cost (for redemption)</label></th>
                    <td>
                        <input type="number" id="canna_points_cost" name="canna_points_cost" value="<?php echo esc_attr($points_cost); ?>" class="short" />
                        <p class="description">Enter the number of points required to redeem this item. Leave blank if this product cannot be redeemed.</p>
                    </td>
                </tr>
                <tr>
                    <th><label for="canna_required_rank">Required Rank (for redemption)</label></th>
                    <td>
                        <select id="canna_required_rank" name="canna_required_rank">
                            <option value="">‚Äî No Rank Required ‚Äî</option>
                            <?php foreach ($ranks as $rank) : ?>
                                <option value="<?php echo esc_attr($rank->post_name); ?>" <?php selected($required_rank_slug, $rank->post_name); ?>>
                                    <?php echo esc_html($rank->post_title); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                        <p class="description">Select the minimum rank a user must have to see and redeem this reward.</p>
                    </td>
                </tr>
                <tr>
                    <th><label for="canna_marketing_snippet">Marketing Snippet</label></th>
                    <td>
                        <textarea id="canna_marketing_snippet" name="canna_marketing_snippet" rows="3" class="large-text"><?php echo esc_textarea($marketing_snippet); ?></textarea>
                        <p class="description">A short, pre-approved marketing line for this product. This is sent to Customer.io on scan events.</p>
                    </td>
                </tr>
            </tbody>
        </table>
        <?php
    }

    public static function save_metabox_data($post_id) {
        if (!isset($_POST['canna_product_settings_nonce']) || !wp_verify_nonce($_POST['canna_product_settings_nonce'], 'canna_product_settings_save')) {
            return;
        }
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
            return;
        }
        if (!current_user_can('edit_post', $post_id)) {
            return;
        }

        $fields_to_save = [
            'canna_points_award' => 'points_award',
            'canna_points_cost' => 'points_cost',
            'canna_required_rank' => '_required_rank',
            'canna_marketing_snippet' => 'marketing_snippet',
        ];

        foreach ($fields_to_save as $post_key => $meta_key) {
            if (isset($_POST[$post_key])) {
                $value = sanitize_text_field(wp_unslash($_POST[$post_key]));
                update_post_meta($post_id, $meta_key, $value);
            }
        }
    }
}
</file>

<file path="includes/CannaRewards/Admin/TriggerMetabox.php">
<?php
namespace CannaRewards\Admin;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Defines the metabox for the CannaRewards Trigger CPT.
 *
 * @package CannaRewards
 */
class TriggerMetabox {

    public function __construct() {
        add_action('add_meta_boxes', [$this, 'add_metabox']);
        add_action('save_post_canna_trigger', [$this, 'save_data']);
    }

    public function add_metabox() {
        add_meta_box(
            'canna_trigger_details',
            __('Trigger Rules', 'canna-rewards'),
            [$this, 'render_metabox'],
            'canna_trigger', 
            'normal', 
            'high'
        );
    }

    public function render_metabox($post) {
        wp_nonce_field('canna_save_trigger_data', 'canna_trigger_nonce');
        
        $event_key = get_post_meta($post->ID, 'event_key', true);
        $action_type = get_post_meta($post->ID, 'action_type', true);
        $action_value = get_post_meta($post->ID, 'action_value', true);
        ?>
        <p>Use the trigger title above to give this rule a descriptive name (e.g., "Referrer Conversion Bonus").</p>
        <hr>
        <table class="form-table">
            <tbody>
                <tr>
                    <th scope="row"><label for="event_key">IF this event happens...</label></th>
                    <td>
                        <select id="event_key" name="event_key" required>
                            <option value="">-- Select Event --</option>
                            <option value="referral_invitee_signed_up" <?php selected($event_key, 'referral_invitee_signed_up'); ?>>Referral Invitee Signs Up</option>
                            <option value="referral_converted" <?php selected($event_key, 'referral_converted'); ?>>Referral is Converted (First Scan)</option>
                            <option value="user_rank_changed" <?php selected($event_key, 'user_rank_changed'); ?>>User Rank Changes</option>
                        </select>
                        <p class="description">This is the event that will cause this action to run.</p>
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="action_type">THEN perform this action...</label></th>
                    <td>
                        <select id="action_type" name="action_type" required>
                            <option value="">-- Select Action --</option>
                            <option value="grant_points" <?php selected($action_type, 'grant_points'); ?>>Grant Points</option>
                            <!-- Future actions like 'grant_product' can be added here -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="action_value">With this value...</label></th>
                    <td>
                        <input type="text" id="action_value" name="action_value" value="<?php echo esc_attr($action_value); ?>" class="regular-text" />
                        <p class="description">For "Grant Points", this is the number of points (e.g., 500).</p>
                    </td>
                </tr>
            </tbody>
        </table>
        <?php
    }

    public function save_data($post_id) {
        if (!isset($_POST['canna_trigger_nonce']) || !wp_verify_nonce($_POST['canna_trigger_nonce'], 'canna_save_trigger_data')) return;
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;
        if (get_post_type($post_id) !== 'canna_trigger' || !current_user_can('edit_post', $post_id)) return;

        update_post_meta($post_id, 'event_key', isset($_POST['event_key']) ? sanitize_text_field($_POST['event_key']) : '');
        update_post_meta($post_id, 'action_type', isset($_POST['action_type']) ? sanitize_text_field($_POST['action_type']) : '');
        update_post_meta($post_id, 'action_value', isset($_POST['action_value']) ? sanitize_text_field($_POST['action_value']) : '');
    }
}
</file>

<file path="includes/CannaRewards/Admin/UserProfile.php">
<?php
namespace CannaRewards\Admin;

use WP_User;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Handles custom fields on the WordPress User Profile screen.
 */
class UserProfile {

    public static function init() {
        add_action('show_user_profile', [self::class, 'add_custom_fields']);
        add_action('edit_user_profile', [self::class, 'add_custom_fields']);
        add_action('personal_options_update', [self::class, 'save_custom_fields']);
        add_action('edit_user_profile_update', [self::class, 'save_custom_fields']);
    }

    public static function add_custom_fields(WP_User $user) {
        ?>
        <h2>CannaRewards Custom Fields</h2>
        <table class="form-table" id="cannarewards-custom-fields">
            <tr>
                <th><label for="phone_number">Phone Number</label></th>
                <td><input type="text" id="phone_number" name="phone_number" value="<?php echo esc_attr(get_user_meta($user->ID, 'phone_number', true)); ?>" class="regular-text" /></td>
            </tr>
            <tr>
                <th><label for="marketing_consent">Marketing Consent</label></th>
                <td>
                    <input type="checkbox" id="marketing_consent" name="marketing_consent" value="1" <?php checked(1, get_user_meta($user->ID, 'marketing_consent', true)); ?> />
                    <span class="description">User agreed to receive marketing communications.</span>
                </td>
            </tr>
        </table>
        
        <h3>Shipping Address</h3>
        <table class="form-table" id="cannarewards-shipping-fields">
             <tr>
                <th><label for="shipping_first_name">First Name</label></th>
                <td><input type="text" name="shipping_first_name" id="shipping_first_name" value="<?php echo esc_attr(get_user_meta($user->ID, 'shipping_first_name', true)); ?>" class="regular-text"></td>
            </tr>
            <tr>
                <th><label for="shipping_last_name">Last Name</label></th>
                <td><input type="text" name="shipping_last_name" id="shipping_last_name" value="<?php echo esc_attr(get_user_meta($user->ID, 'shipping_last_name', true)); ?>" class="regular-text"></td>
            </tr>
            <tr>
                <th><label for="shipping_address_1">Address Line 1</label></th>
                <td><input type="text" name="shipping_address_1" id="shipping_address_1" value="<?php echo esc_attr(get_user_meta($user->ID, 'shipping_address_1', true)); ?>" class="regular-text"></td>
            </tr>
            <tr>
                <th><label for="shipping_city">City</label></th>
                <td><input type="text" name="shipping_city" id="shipping_city" value="<?php echo esc_attr(get_user_meta($user->ID, 'shipping_city', true)); ?>" class="regular-text"></td>
            </tr>
            <tr>
                <th><label for="shipping_state">State</label></th>
                <td><input type="text" name="shipping_state" id="shipping_state" value="<?php echo esc_attr(get_user_meta($user->ID, 'shipping_state', true)); ?>" class="regular-text"></td>
            </tr>
            <tr>
                <th><label for="shipping_postcode">ZIP / Postal Code</label></th>
                <td><input type="text" name="shipping_postcode" id="shipping_postcode" value="<?php echo esc_attr(get_user_meta($user->ID, 'shipping_postcode', true)); ?>" class="regular-text"></td>
            </tr>
        </table>
        <?php
    }

    public static function save_custom_fields($user_id) {
        if (!current_user_can('edit_user', $user_id)) {
            return;
        }

        $meta_to_save = [
            'phone_number', 
            'shipping_first_name', 
            'shipping_last_name', 
            'shipping_address_1', 
            'shipping_city', 
            'shipping_state', 
            'shipping_postcode'
        ];

        foreach ($meta_to_save as $key) {
            if (isset($_POST[$key])) {
                update_user_meta($user_id, $key, sanitize_text_field($_POST[$key]));
            }
        }

        $marketing_consent = isset($_POST['marketing_consent']) ? 1 : 0;
        update_user_meta($user_id, 'marketing_consent', $marketing_consent);
    }
}
</file>

<file path="includes/CannaRewards/Api/AdminController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use WP_REST_Response;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Handles Admin & Debug API Endpoints
 */
class AdminController {
    
    /**
     * Registers all admin-only REST API routes.
     */
    public static function register_routes() {
        $base = 'rewards/v1'; // These are internal, so keeping v1 is fine for now.
        $permission_admin = function () {
            return current_user_can('manage_options');
        };
        
        register_rest_route($base, '/generate-codes', [
            'methods' => 'POST',
            'callback' => [__CLASS__, 'generate_codes'],
            'permission_callback' => $permission_admin
        ]);
        register_rest_route($base, '/debug-log', [
            'methods' => 'GET',
            'callback' => [__CLASS__, 'debug_view_log'],
            'permission_callback' => $permission_admin
        ]);
    }

    /**
     * Generates a batch of reward codes.
     */
    public static function generate_codes(WP_REST_Request $request) {
        global $wpdb;
        $params = $request->get_json_params();
        $sku = sanitize_text_field($params['sku'] ?? 'DEFAULT-SKU');
        $quantity = (int)($params['quantity'] ?? 10);
        $generated_codes = [];

        // Note: The 'points' column is deprecated in the new schema.
        // This function would need to be updated if used.
        for ($i = 0; $i < $quantity; $i++) {
            $new_code = strtoupper($sku) . '-' . wp_generate_password(12, false);
            $wpdb->insert(
                $wpdb->prefix . 'canna_reward_codes',
                ['code' => $new_code, 'sku' => $sku]
            );
            $generated_codes[] = $new_code;
        }

        return new WP_REST_Response([
            'success' => true,
            'message' => "$quantity codes generated for SKU: $sku",
            'codes' => $generated_codes
        ], 200);
    }

    /**
     * A debug endpoint to view the new action log.
     */
    public static function debug_view_log(WP_REST_Request $request) {
        global $wpdb;
        $results = $wpdb->get_results("SELECT * FROM {$wpdb->prefix}canna_user_action_log ORDER BY log_id DESC LIMIT 100");

        if ($wpdb->last_error) {
            return new WP_REST_Response([
                'error' => 'Database Error',
                'message' => $wpdb->last_error
            ], 500);
        }
        return new WP_REST_Response($results, 200);
    }
}
</file>

<file path="includes/CannaRewards/Api/ApiResponse.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Response;
use WP_Error;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * API Response Formatter
 *
 * A final, static utility class that is the single source of truth for creating
 * consistent WP_REST_Response objects. This ensures all API output, both success
 * and error, has a predictable and standardized structure.
 */
final class ApiResponse {

    /**
     * Creates a standardized success response.
     *
     * @param array $data The data payload to be included.
     * @param int $status The HTTP status code (e.g., 200 OK, 201 Created).
     * @return WP_REST_Response
     */
    public static function success(array $data, int $status = 200): WP_REST_Response {
        return new WP_REST_Response([
            'success' => true,
            'data'    => $data,
        ], $status);
    }

    /**
     * Creates a standardized error response.
     *
     * @param string $message A human-readable error message.
     * @param string $code A machine-readable error code (e.g., 'invalid_code').
     * @param int $status The HTTP status code (e.g., 400, 404, 500).
     * @return WP_Error  <-- THIS IS THE FIX. It now correctly returns a WP_Error object.
     */
    public static function error(string $message, string $code, int $status = 400): WP_Error {
        // The WordPress REST server knows how to automatically convert a WP_Error
        // object into a proper JSON error response. This is the correct way.
        return new WP_Error($code, $message, ['status' => $status]);
    }

    /**
     * Helper for a generic "Not Found" error.
     *
     * @param string $message The specific message for what was not found.
     * @return WP_Error
     */
    public static function not_found(string $message = 'The requested resource could not be found.'): WP_Error {
        return self::error($message, 'not_found', 404);
    }

    /**
     * Helper for a generic "Forbidden" or authorization error.
     *
     * @param string $message The reason for the failure.
     * @return WP_Error
     */
    public static function forbidden(string $message = 'You do not have permission to perform this action.'): WP_Error {
        return self::error($message, 'forbidden', 403);
    }

    /**
     * Helper for a generic "Bad Request" or validation error.
     *
     * @param string $message The reason for the failure.
     * @return WP_Error
     */
    public static function bad_request(string $message = 'The request was malformed or is missing required parameters.'): WP_Error {
        return self::error($message, 'bad_request', 400);
    }
}
</file>

<file path="includes/CannaRewards/Api/DashboardController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use CannaRewards\Services\UserService;
use Exception;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Dashboard Controller (V2)
 * Gathers and serves all dynamically calculated data for the main user dashboard.
 */
class DashboardController {
    private $user_service;

    public function __construct(UserService $user_service) {
        $this->user_service = $user_service;
    }

    /**
     * Callback for GET /v2/users/me/dashboard.
     */
    public function get_dashboard_data( WP_REST_Request $request ) {
        $user_id = get_current_user_id();
        if ($user_id <= 0) {
            return ApiResponse::forbidden('User not authenticated.');
        }

        try {
            // The UserService now orchestrates all the data gathering.
            $dashboard_data = $this->user_service->get_user_dashboard_data($user_id);
            return ApiResponse::success($dashboard_data);
        } catch ( Exception $e ) {
            // Log the actual error for better debugging in production.
            error_log('Dashboard data retrieval failed: ' . $e->getMessage());
            return ApiResponse::error('Could not retrieve dashboard data.', 'dashboard_error', 500);
        }
    }
}
</file>

<file path="includes/CannaRewards/Api/PageController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use Exception;
use CannaRewards\Services\ContentService;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Page Service Controller (V2)
 */
class PageController {
    private $content_service;

    public function __construct() {
        $this->content_service = new ContentService();
    }

    /**
     * Callback for GET /v2/pages/{slug}.
     */
    public function get_page( WP_REST_Request $request ) {
        $slug = $request->get_param( 'slug' );
        if ( empty( $slug ) ) {
            return new WP_Error( 'bad_request', 'Page slug is required.', [ 'status' => 400 ] );
        }

        try {
            $page_data = $this->content_service->get_page_by_slug( $slug );
            if ( is_null( $page_data ) ) {
                return new WP_Error( 'not_found', 'The requested page could not be found.', [ 'status' => 404 ] );
            }
            return new WP_REST_Response( $page_data, 200 );
        } catch ( Exception $e ) {
            return new WP_Error( 'page_error', 'Could not retrieve page content.', [ 'status' => 500 ] );
        }
    }
}
</file>

<file path="includes/CannaRewards/Api/RulesController.php">
<?php
namespace CannaRewards\Api;

use CannaRewards\Services\RuleConditionRegistryService;

final class RulesController {
    private RuleConditionRegistryService $registry;

    public function __construct(RuleConditionRegistryService $registry) {
        $this->registry = $registry;
    }

    /**
     * API callback to get the list of all available rule builder conditions.
     * This is used to populate the UI in the WordPress admin.
     */
    public function get_conditions(): \WP_REST_Response {
        $conditions = $this->registry->getConditions();
        return new \WP_REST_Response($conditions, 200);
    }
}
</file>

<file path="includes/CannaRewards/Api/UnauthenticatedDataController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Unauthenticated Data Controller
 * Provides public endpoints for data needed before a user is logged in.
 * This class is intentionally self-contained and does not use the DI container
 * to ensure it remains operational even during major refactoring.
 */
class UnauthenticatedDataController {

    /**
     * Formats a product for a simple, public API response.
     */
    private function format_product_preview( $product_id ): ?array {
        if ( ! $product_id || ! function_exists('wc_get_product') ) {
            return null;
        }
        $product = wc_get_product($product_id);
        if ( ! $product ) {
            return null;
        }

        $image_id = $product->get_image_id();
        $image_url = $image_id ? wp_get_attachment_image_url($image_id, 'woocommerce_thumbnail') : wc_placeholder_img_src();

        return [
            'id'    => $product->get_id(),
            'name'  => $product->get_name(),
            'image' => $image_url,
        ];
    }

    /**
     * Gets the preview data for the first-scan welcome reward.
     */
    public function get_welcome_reward_preview( WP_REST_Request $request ): WP_REST_Response {
        $options = get_option('canna_rewards_options', []);
        $product_id = !empty($options['welcome_reward_product']) ? (int) $options['welcome_reward_product'] : 0;
        
        if ($product_id === 0) {
            $error = new WP_Error('not_configured', 'The welcome reward has not been configured in Brand Settings.', ['status' => 404]);
            return rest_ensure_response($error);
        }
        
        $preview_data = $this->format_product_preview($product_id);
        
        if ( is_null($preview_data) ) {
            $error = new WP_Error('not_found', 'Welcome reward product could not be found.', ['status' => 404]);
            return rest_ensure_response($error);
        }

        return new WP_REST_Response($preview_data, 200);
    }

    /**
     * Gets the preview data for the referral sign-up gift.
     */
    public function get_referral_gift_preview( WP_REST_Request $request ): WP_REST_Response {
        $options = get_option('canna_rewards_options', []);
        $product_id = !empty($options['referral_signup_gift']) ? (int) $options['referral_signup_gift'] : 0;

        if ($product_id === 0) {
            $error = new WP_Error('not_configured', 'The referral gift has not been configured in Brand Settings.', ['status' => 404]);
            return rest_ensure_response($error);
        }

        $preview_data = $this->format_product_preview($product_id);

        if ( is_null($preview_data) ) {
            $error = new WP_Error('not_found', 'Referral gift product could not be found.', ['status' => 404]);
            return rest_ensure_response($error);
        }
        
        $preview_data['isReferralGift'] = true;
        
        return new WP_REST_Response($preview_data, 200);
    }
}
</file>

<file path="includes/CannaRewards/Commands/GrantPointsCommand.php">
<?php
namespace CannaRewards\Commands;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Command DTO for granting points to a user.
 */
final class GrantPointsCommand {
    public int $user_id;
    public int $base_points;
    public string $description;
    public float $temp_multiplier;

    public function __construct(
        int $user_id,
        int $base_points,
        string $description,
        float $temp_multiplier = 1.0
    ) {
        $this->user_id = $user_id;
        $this->base_points = $base_points;
        $this->description = $description;
        $this->temp_multiplier = $temp_multiplier;
    }
}
</file>

<file path="includes/CannaRewards/Commands/GrantPointsCommandHandler.php">
<?php
namespace CannaRewards\Commands;

use CannaRewards\Repositories\UserRepository;
use CannaRewards\Services\ActionLogService;
use CannaRewards\Services\EconomyService;
use CannaRewards\Services\RankService;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Handles the logic for the GrantPointsCommand.
 */
final class GrantPointsCommandHandler {
    private UserRepository $userRepository;
    private ActionLogService $actionLogService;
    private RankService $rankService;
    private EconomyService $economyService;

    public function __construct(
        UserRepository $userRepository,
        ActionLogService $actionLogService,
        RankService $rankService
    ) {
        $this->userRepository = $userRepository;
        $this->actionLogService = $actionLogService;
        $this->rankService = $rankService;
    }

    /**
     * This setter is used by the DI container to resolve a circular dependency.
     * The handler needs the EconomyService to check for rank transitions,
     * and the EconomyService needs this handler.
     */
    public function setEconomyService(EconomyService $economyService): void {
        $this->economyService = $economyService;
    }

    /**
     * Executes the point-granting logic.
     * This logic is identical to the old EconomyService::grant_points method.
     */
    public function handle(GrantPointsCommand $command): array {
        $user_rank_dto    = $this->rankService->getUserRank($command->user_id);
        $rank_multiplier  = $this->getRankMultiplier($user_rank_dto->key);
        $final_multiplier = max( $rank_multiplier, $command->temp_multiplier );
        $points_to_grant  = floor( $command->base_points * $final_multiplier );

        $current_balance     = $this->userRepository->getPointsBalance($command->user_id);
        $new_balance         = $current_balance + $points_to_grant;
        
        $lifetime_points     = $this->userRepository->getLifetimePoints($command->user_id);
        $new_lifetime_points = $lifetime_points + $points_to_grant;

        // Persist the new data
        $this->userRepository->savePointsAndRank($command->user_id, $new_balance, $new_lifetime_points, $user_rank_dto->key);

        $log_meta_data = [
            'description'        => $command->description,
            'points_change'      => $points_to_grant,
            'new_balance'        => $new_balance,
            'base_points'        => $command->base_points,
            'multiplier_applied' => $final_multiplier > 1.0 ? $final_multiplier : null,
        ];
        $this->actionLogService->record( $command->user_id, 'points_granted', 0, $log_meta_data );

        // After granting points, check if the user's rank has changed.
        $this->economyService->check_and_apply_rank_transition($command->user_id);

        return [
            'points_earned'      => $points_to_grant,
            'new_points_balance' => $new_balance,
        ];
    }

    /**
     * Temporary helper to get a multiplier from a rank key.
     */
    private function getRankMultiplier(string $rankKey): float {
        $rank_post = get_page_by_path($rankKey, OBJECT, 'canna_rank');
        if ($rank_post) {
            $multiplier = get_post_meta($rank_post->ID, 'point_multiplier', true);
            return !empty($multiplier) ? (float) $multiplier : 1.0;
        }
        return 1.0;
    }
}
</file>

<file path="includes/CannaRewards/Commands/ProcessProductScanCommand.php">
<?php
namespace CannaRewards\Commands;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Command DTO for processing a product scan.
 */
final class ProcessProductScanCommand {
    public $user_id;
    public $code;

    public function __construct(int $user_id, string $code) {
        $this->user_id = $user_id;
        $this->code = $code;
    }
}
</file>

<file path="includes/CannaRewards/Commands/ProcessUnauthenticatedClaimCommand.php">
<?php
namespace CannaRewards\Commands;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Command DTO for an unauthenticated user attempting to claim a code.
 */
final class ProcessUnauthenticatedClaimCommand {
    public $code;

    public function __construct(string $code) {
        $this->code = $code;
    }
}
</file>

<file path="includes/CannaRewards/Commands/ProcessUnauthenticatedClaimCommandHandler.php">
<?php
namespace CannaRewards\Commands;

use CannaRewards\Repositories\RewardCodeRepository;
use CannaRewards\Repositories\ProductRepository;
use Exception;

final class ProcessUnauthenticatedClaimCommandHandler {
    private $reward_code_repository;
    private $product_repository;

    public function __construct(
        RewardCodeRepository $reward_code_repository,
        ProductRepository $product_repository
    ) {
        $this->reward_code_repository = $reward_code_repository;
        $this->product_repository = $product_repository;
    }

    public function handle(ProcessUnauthenticatedClaimCommand $command): array {
        $code_data = $this->reward_code_repository->findValidCode($command->code);
        if (!$code_data) {
            throw new Exception('This code is invalid or has already been used.');
        }

        $product_id = $this->product_repository->findIdBySku($code_data->sku);
        if (!$product_id) {
            throw new Exception('The product associated with this code could not be found.');
        }

        $registration_token = bin2hex(random_bytes(32));
        set_transient('reg_token_' . $registration_token, $command->code, 15 * MINUTE_IN_SECONDS);
        
        $options = get_option('canna_rewards_options', []);
        $welcome_reward_id = !empty($options['welcome_reward_product']) ? (int) $options['welcome_reward_product'] : 0;
        $product = $welcome_reward_id ? wc_get_product($welcome_reward_id) : null;

        return [
            'status'             => 'registration_required',
            'registration_token' => $registration_token,
            'reward_preview'     => [
                'id' => $product ? $product->get_id() : 0,
                'name' => $product ? $product->get_name() : 'Welcome Gift',
                'image' => $product ? wp_get_attachment_image_url($product->get_image_id(), 'woocommerce_thumbnail') : wc_placeholder_img_src(),
            ]
        ];
    }
}
</file>

<file path="includes/CannaRewards/Commands/RedeemRewardCommand.php">
<?php
namespace CannaRewards\Commands;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

final class RedeemRewardCommand {
    public $user_id;
    public $product_id;
    public $shipping_details;

    public function __construct(int $user_id, int $product_id, array $shipping_details = []) {
        $this->user_id = $user_id;
        $this->product_id = $product_id;
        $this->shipping_details = $shipping_details;
    }
}
</file>

<file path="includes/CannaRewards/Commands/UpdateProfileCommand.php">
<?php
namespace CannaRewards\Commands;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Command DTO for updating a user's profile.
 */
final class UpdateProfileCommand {
    public $user_id;
    public $data;

    public function __construct(int $user_id, array $data) {
        $this->user_id = $user_id;
        $this->data = $data;
    }
}
</file>

<file path="includes/CannaRewards/Commands/UpdateProfileCommandHandler.php">
<?php
namespace CannaRewards\Commands;

use CannaRewards\Commands\UpdateProfileCommand;
use CannaRewards\Repositories\UserRepository;
use CannaRewards\Services\ActionLogService;
use CannaRewards\Services\CDPService;
use Exception;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Handler for updating a user's profile.
 */
final class UpdateProfileCommandHandler {
    private $action_log_service;
    private $cdp_service;
    private $user_repository;

    public function __construct(
        ActionLogService $action_log_service,
        CDPService $cdp_service,
        UserRepository $user_repository
    ) {
        $this->action_log_service = $action_log_service;
        $this->cdp_service = $cdp_service;
        $this->user_repository = $user_repository;
    }

    /**
     * @throws Exception
     */
    public function handle(UpdateProfileCommand $command): void {
        $user_id = $command->user_id;
        $data = $command->data;
        $changed_fields = [];

        $core_user_data = ['ID' => $user_id];
        if (isset($data['firstName'])) {
            $core_user_data['first_name'] = sanitize_text_field($data['firstName']);
            $changed_fields[] = 'firstName';
        }
        if (isset($data['lastName'])) {
            $core_user_data['last_name'] = sanitize_text_field($data['lastName']);
            $changed_fields[] = 'lastName';
        }
        if (count($core_user_data) > 1) {
            $result = wp_update_user($core_user_data);
            if (is_wp_error($result)) {
                throw new Exception('Could not update user core data.');
            }
        }

        if (isset($data['phone_number'])) {
            update_user_meta($user_id, 'phone_number', sanitize_text_field($data['phone_number']));
            $changed_fields[] = 'phone_number';
        }

        if (isset($data['custom_fields']) && is_array($data['custom_fields'])) {
            // In a full implementation, we'd fetch definitions from a CustomFieldRepository
            // to validate the keys and values before saving.
            foreach ($data['custom_fields'] as $key => $value) {
                update_user_meta($user_id, sanitize_key($key), sanitize_text_field($value));
                $changed_fields[] = 'custom_' . sanitize_key($key);
            }
        }

        if (!empty($changed_fields)) {
            $log_meta_data = ['changed_fields' => $changed_fields];
            $this->action_log_service->record($user_id, 'profile_updated', 0, $log_meta_data);
            $this->cdp_service->track($user_id, 'user_profile_updated', $log_meta_data);
        }
    }
}
</file>

<file path="includes/CannaRewards/Domain/ValueObjects/EmailAddress.php">
<?php
namespace CannaRewards\Domain\ValueObjects;

use InvalidArgumentException;

// A Value Object that guarantees it holds a validly formatted email string.
final class EmailAddress {
    private string $value;

    public function __construct(string $email) {
        if (!is_email($email)) {
            throw new InvalidArgumentException("Invalid email address provided.");
        }
        $this->value = strtolower(trim($email));
    }

    public function __toString(): string {
        return $this->value;
    }
}
</file>

<file path="includes/CannaRewards/Domain/ValueObjects/UserId.php">
<?php
namespace CannaRewards\Domain\ValueObjects;

use InvalidArgumentException;

// A Value Object that guarantees a user ID is a positive integer.
final class UserId {
    private int $value;

    public function __construct(int $id) {
        if ($id <= 0) {
            throw new InvalidArgumentException("User ID must be a positive integer. Received: {$id}");
        }
        $this->value = $id;
    }

    public function toInt(): int {
        return $this->value;
    }
}
</file>

<file path="includes/CannaRewards/DTO/FullProfileDTO.php">
<?php
namespace CannaRewards\DTO;

// Represents the complete user profile data for the /users/me/profile endpoint.
final class FullProfileDTO {
    public ?string $lastName;
    public ?string $phone_number;
    public ?string $referral_code;
    public ShippingAddressDTO $shipping_address;
    public array $unlocked_achievement_keys = [];
    public object $custom_fields;
}
</file>

<file path="includes/CannaRewards/DTO/OrderDTO.php">
<?php
namespace CannaRewards\DTO;

// Represents a single redeemed order for API responses.
final class OrderDTO {
    public int $orderId;
    public string $date; // Will be in 'YYYY-MM-DD' format
    public string $status;
    public string $items;
    public string $imageUrl;
}
</file>

<file path="includes/CannaRewards/DTO/RankDTO.php">
<?php
namespace CannaRewards\DTO;

// A simple, public-property DTO for rank data.
final class RankDTO {
    public string $key;
    public string $name;
}
</file>

<file path="includes/CannaRewards/DTO/SessionUserDTO.php">
<?php
namespace CannaRewards\DTO;

// The DTO for the user session. It contains another DTO.
final class SessionUserDTO {
    public int $id;
    public ?string $firstName;
    public ?string $lastName;
    public string $email;
    public int $points_balance;
    public RankDTO $rank; // Type-hinting the nested DTO
    public array $shipping;
    public ?string $referral_code;
    public int $onboarding_quest_step;
    public object $feature_flags;
}
</file>

<file path="includes/CannaRewards/DTO/ShippingAddressDTO.php">
<?php
namespace CannaRewards\DTO;

// Represents a user's shipping address for API responses.
final class ShippingAddressDTO {
    public ?string $first_name;
    public ?string $last_name;
    public ?string $address_1;
    public ?string $city;
    public ?string $state;
    public ?string $postcode;
}
</file>

<file path="includes/CannaRewards/Policies/PolicyInterface.php">
<?php
namespace CannaRewards\Policies;

/**
 * Defines the contract for a business rule check that runs before a command is handled.
 * The check method should throw a domain-specific exception on failure.
 */
interface PolicyInterface {
    public function check($command): void;
}
</file>

<file path="includes/CannaRewards/Policies/UserAccountIsUniquePolicy.php">
<?php
namespace CannaRewards\Policies;

use CannaRewards\Commands\CreateUserCommand;
use Exception;

class UserAccountIsUniquePolicy implements PolicyInterface {
    public function check($command): void {
        // This policy only applies to the CreateUserCommand.
        if (!$command instanceof CreateUserCommand) {
            return;
        }

        $email_string = (string) $command->email;

        if (email_exists($email_string)) {
            // 409 Conflict is the correct HTTP status for a duplicate resource.
            throw new Exception('An account with that email already exists.', 409);
        }
    }
}
</file>

<file path="includes/CannaRewards/Policies/UserCanAffordRedemptionPolicy.php">
<?php
namespace CannaRewards\Policies;

use CannaRewards\Commands\RedeemRewardCommand;
use CannaRewards\Repositories\ProductRepository;
use CannaRewards\Repositories\UserRepository;
use Exception;

class UserCanAffordRedemptionPolicy implements PolicyInterface {
    private $product_repository;
    private $user_repository;

    public function __construct(ProductRepository $product_repo, UserRepository $user_repo) {
        $this->product_repository = $product_repo;
        $this->user_repository = $user_repo;
    }

    public function check($command): void {
        // This policy only cares about the RedeemRewardCommand.
        if (!$command instanceof RedeemRewardCommand) {
            return;
        }
        
        // Ignore free claims for the purpose of this policy.
        $options = get_option('canna_rewards_options', []);
        $welcome_reward_id = !empty($options['welcome_reward_product']) ? (int) $options['welcome_reward_product'] : 0;
        if ($command->product_id === $welcome_reward_id) {
            // A more robust check for first-scan might be needed, but for now this is fine.
            return;
        }

        $points_cost = $this->product_repository->getPointsCost($command->product_id);
        $current_balance = $this->user_repository->getPointsBalance($command->user_id);

        if ($current_balance < $points_cost) {
            // 402 Payment Required is the semantically correct HTTP code for insufficient funds/points.
            throw new Exception('Insufficient points.', 402);
        }
    }
}
</file>

<file path="includes/CannaRewards/Repositories/AchievementRepository.php">
<?php
namespace CannaRewards\Repositories;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Achievement Repository
 *
 * Handles all data access for achievement definitions and user progress.
 */
class AchievementRepository {
    private static $request_cache = [];

    /**
     * Retrieves all active achievements that are triggered by a specific event.
     * Caches results for the duration of a single request to prevent duplicate queries.
     */
    public function findByTriggerEvent(string $event_name): array {
        if (isset(self::$request_cache[$event_name])) {
            return self::$request_cache[$event_name];
        }

        global $wpdb;
        $table_name = $wpdb->prefix . 'canna_achievements';
        
        $results = $wpdb->get_results($wpdb->prepare(
            "SELECT * FROM {$table_name} WHERE is_active = 1 AND trigger_event = %s",
            $event_name
        ));

        self::$request_cache[$event_name] = $results;
        return $results;
    }

    /**
     * Gets an array of achievement keys a user has already unlocked.
     */
    public function getUnlockedKeysForUser(int $user_id): array {
        global $wpdb;
        $table_name = $wpdb->prefix . 'canna_user_achievements';
        
        return $wpdb->get_col($wpdb->prepare(
            "SELECT achievement_key FROM {$table_name} WHERE user_id = %d",
            $user_id
        ));
    }

    /**
     * Persists an unlocked achievement for a user.
     */
    public function saveUnlockedAchievement(int $user_id, string $achievement_key): void {
        global $wpdb;
        $table_name = $wpdb->prefix . 'canna_user_achievements';
        
        $wpdb->insert($table_name, [
            'user_id'         => $user_id,
            'achievement_key' => $achievement_key,
            'unlocked_at'     => current_time('mysql', 1)
        ]);
    }
}
</file>

<file path="includes/CannaRewards/Repositories/ActionLogRepository.php">
<?php
namespace CannaRewards\Repositories;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Action Log Repository
 *
 * Handles all data access logic for the user action log table.
 */
class ActionLogRepository {

    /**
     * Counts the number of times a user has performed a specific action.
     */
    public function countUserActions(int $user_id, string $action_type): int {
        global $wpdb;
        $table_name = $wpdb->prefix . 'canna_user_action_log';

        return (int) $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(log_id) FROM {$table_name} WHERE user_id = %d AND action_type = %s",
            $user_id,
            $action_type
        ));
    }
}
</file>

<file path="includes/CannaRewards/Repositories/ProductRepository.php">
<?php
namespace CannaRewards\Repositories;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Product Repository
 *
 * Handles data access for WooCommerce products.
 */
class ProductRepository {

    /**
     * Finds a product ID by its SKU.
     */
    public function findIdBySku(string $sku): ?int {
        $product_id = wc_get_product_id_by_sku($sku);
        return $product_id > 0 ? $product_id : null;
    }

    /**
     * Gets the base points awarded for scanning a product.
     */
    public function getPointsAward(int $product_id): int {
        return (int) get_post_meta($product_id, 'points_award', true);
    }

    /**
     * Gets the points cost for redeeming a product.
     */
    public function getPointsCost(int $product_id): int {
        return (int) get_post_meta($product_id, 'points_cost', true);
    }
    
    /**
     * Gets the required rank slug for redeeming a product.
     */
    public function getRequiredRank(int $product_id): ?string {
        $rank = get_post_meta($product_id, '_required_rank', true);
        return empty($rank) ? null : $rank;
    }
}
</file>

<file path="includes/CannaRewards/Repositories/RewardCodeRepository.php">
<?php
namespace CannaRewards\Repositories;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Reward Code Repository
 *
 * Handles all data access for reward QR codes.
 */
class RewardCodeRepository {

    /**
     * Finds a valid, unused reward code.
     *
     * @return object|null The code data object or null if not found.
     */
    public function findValidCode(string $code_to_claim): ?object {
        global $wpdb;
        $table_name = $wpdb->prefix . 'canna_reward_codes';
        
        return $wpdb->get_row($wpdb->prepare(
            "SELECT id, sku FROM {$table_name} WHERE code = %s AND is_used = 0",
            $code_to_claim
        ));
    }

    /**
     * Marks a reward code as used by a specific user.
     */
    public function markCodeAsUsed(int $code_id, int $user_id): void {
        global $wpdb;
        $table_name = $wpdb->prefix . 'canna_reward_codes';
        
        $wpdb->update(
            $table_name,
            [
                'is_used'    => 1,
                'user_id'    => $user_id,
                'claimed_at' => current_time('mysql', 1)
            ],
            ['id' => $code_id]
        );
    }
}
</file>

<file path="includes/CannaRewards/Services/ContentService.php">
<?php
namespace CannaRewards\Services;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Content Service
 *
 * Handles fetching and formatting of standard WordPress content like pages.
 */
class ContentService {

    /**
     * Retrieves a WordPress page by its slug and formats it for the API.
     *
     * @param string $slug The slug of the page to retrieve.
     * @return array|null An array with page data or null if not found.
     */
    public function get_page_by_slug( string $slug ): ?array {
        // Use the core WordPress function to find the page post object.
        $page = get_page_by_path( $slug, OBJECT, 'page' );

        if ( ! $page ) {
            return null; // Return null if no page is found.
        }

        // Apply 'the_content' filter to process shortcodes and other formatting.
        $content = apply_filters( 'the_content', $page->post_content );
        
        // Remove extra paragraphs that WordPress sometimes adds around content.
        $content = str_replace( ']]>', ']]&gt;', $content );

        // Return a clean, formatted array for the API response.
        return [
            'title'   => $page->post_title,
            'content' => $content,
        ];
    }
}
</file>

<file path="includes/CannaRewards/Services/EventFactory.php">
<?php
namespace CannaRewards\Services;

use JsonSchema\Validator;
use Exception;

final class EventFactory {
    private ContextBuilderService $contextBuilder;
    private Validator $validator;
    private string $schemaPath;

    public function __construct(ContextBuilderService $contextBuilder) {
        $this->contextBuilder = $contextBuilder;
        $this->validator = new Validator();
        $this->schemaPath = CANNA_PLUGIN_DIR . 'schemas/';
    }

    /**
     * Creates a fully-formed and validated 'product_scanned' event payload.
     */
    public function createProductScannedEvent(int $userId, \WP_Post $productPost, bool $isFirstScan): array {
        $payload = $this->contextBuilder->build_event_context($userId, $productPost);
        $payload['is_first_scan'] = $isFirstScan;

        $this->validate('events/product_scanned.v1', $payload);

        return $payload;
    }

    /**
     * Validates a payload against a given JSON schema.
     * Throws a fatal exception if validation fails.
     */
    private function validate(string $schemaName, array $payload): void {
        $schemaFilePath = $this->schemaPath . $schemaName . '.json';
        if (!file_exists($schemaFilePath)) {
            throw new Exception("Schema file not found: {$schemaFilePath}");
        }

        $schema = (object)['$ref' => 'file://' . $schemaFilePath];
        $dataToValidate = json_decode(json_encode($payload)); // Deep convert to object

        $this->validator->validate($dataToValidate, $schema);

        if (!$this->validator->isValid()) {
            $errors = [];
            foreach ($this->validator->getErrors() as $error) {
                $errors[] = "[{$error['property']}] {$error['message']}";
            }
            // This is a developer error and should be fatal.
            throw new Exception("Event Validation Failed for {$schemaName}: " . implode(', ', $errors));
        }
    }
}
</file>

<file path="includes/CannaRewards/Services/RankService.php">
<?php
namespace CannaRewards\Services;

use CannaRewards\Repositories\UserRepository;
use CannaRewards\DTO\RankDTO;
use WP_Query;

final class RankService {
    private UserRepository $userRepository;
    private ?array $rankStructureCache = null;

    public function __construct(UserRepository $userRepository) {
        $this->userRepository = $userRepository;
    }

    /**
     * Gets the rank data for a specific user.
     *
     * @param int $userId The ID of the user.
     * @return RankDTO The user's current rank as a DTO.
     */
    public function getUserRank(int $userId): RankDTO {
        $lifetimePoints = $this->userRepository->getLifetimePoints($userId);
        $ranks = $this->getRankStructure();

        // Ranks are sorted high to low, so the first match is the correct one.
        foreach ($ranks as $rank) {
            if ($lifetimePoints >= $rank->points) {
                // To maintain object consistency, we should return a DTO that includes the multiplier.
                // We'll add this logic later. For now, we return the base DTO.
                return $rank;
            }
        }

        // This should theoretically never be hit if a 'member' rank with 0 points exists.
        $memberRank = new RankDTO();
        $memberRank->key = 'member';
        $memberRank->name = 'Member';
        $memberRank->points = 0; // Explicitly set points for the fallback.
        return $memberRank;
    }

    /**
     * Gets the entire rank structure for the application, sorted high to low by points.
     *
     * @return RankDTO[] An array of RankDTO objects.
     */
    public function getRankStructure(): array {
        if ($this->rankStructureCache !== null) {
            return $this->rankStructureCache;
        }

        $cachedRanks = get_transient('canna_rank_structure_dtos');
        if (is_array($cachedRanks)) {
            $this->rankStructureCache = $cachedRanks;
            return $this->rankStructureCache;
        }

        $ranks = [];
        $args = [
            'post_type'      => 'canna_rank',
            'posts_per_page' => -1,
            'meta_key'       => 'points_required',
            'orderby'        => 'meta_value_num',
            'order'          => 'DESC',
        ];
        $rankPosts = new WP_Query($args);

        if ($rankPosts->have_posts()) {
            while ($rankPosts->have_posts()) {
                $rankPosts->the_post();
                $postId = get_the_ID();
                $dto = new RankDTO();
                $dto->key = get_post_field('post_name', $postId);
                $dto->name = get_the_title();
                $dto->points = (int) get_post_meta($postId, 'points_required', true);
                // In the future, we would also add the multiplier here:
                // $dto->multiplier = (float) get_post_meta($postId, 'point_multiplier', true);
                $ranks[] = $dto;
            }
        }
        wp_reset_postdata();

        // Manually add the base 'Member' rank to ensure it always exists.
        $memberRank = new RankDTO();
        $memberRank->key = 'member';
        $memberRank->name = 'Member';
        $memberRank->points = 0;
        $ranks[] = $memberRank;

        // Sort again to ensure member rank is correctly placed if other ranks have 0 points.
        usort($ranks, fn($a, $b) => $b->points <=> $a->points);
        
        // Remove duplicate ranks (if 'member' was added manually and also exists as a CPT)
        $uniqueRanks = [];
        foreach ($ranks as $rank) {
            $uniqueRanks[$rank->key] = $rank;
        }
        $ranks = array_values($uniqueRanks);


        set_transient('canna_rank_structure_dtos', $ranks, 12 * HOUR_IN_SECONDS);
        $this->rankStructureCache = $ranks;

        return $this->rankStructureCache;
    }
}
</file>

<file path="includes/CannaRewards/Services/RuleConditionRegistryService.php">
<?php
namespace CannaRewards\Services;

// This service is the single source of truth for what rules can be built in the UI.
final class RuleConditionRegistryService {
    private array $conditions = [];

    public function __construct() {
        $this->registerDefaultConditions();
    }

    /**
     * Registers a new condition that can be used in the rule builder UI.
     *
     * @param string $key The dot-notation path to the data in the event context.
     * @param string $label The human-readable label shown in the UI dropdown.
     * @param array $operators The operators valid for this data type (e.g., ['is', 'is_not']).
     * @param string $inputType The type of input to render in the UI ('text', 'number', 'select').
     * @param array $options For 'select' inputs, the available choices.
     */
    public function register(string $key, string $label, array $operators, string $inputType = 'text', array $options = []): void {
        $this->conditions[$key] = [
            'key' => $key,
            'label' => $label,
            'operators' => $operators,
            'inputType' => $inputType,
            'options' => $options,
        ];
    }

    /**
     * @return array A list of all registered rule conditions.
     */
    public function getConditions(): array {
        return array_values($this->conditions);
    }

    /**
     * This is where we define the entire "dictionary" of possible rules.
     * To add a new rule to the UI, a developer only needs to add it here.
     */
    private function registerDefaultConditions(): void {
        $this->register(
            'product_snapshot.taxonomy.strain_type',
            'Product Strain Type',
            ['is', 'is_not'],
            'select',
            ['Sativa', 'Indica', 'Hybrid']
        );

        $this->register(
            'user_snapshot.engagement.total_scans',
            "User's Total Scans",
            ['is', 'is_not', '>', '<'],
            'number'
        );
        
        $this->register(
            'user_snapshot.status.rank_key',
            "User's Rank",
            ['is', 'is_not'],
            'select',
            // In a real system, we'd get these from the RankService, but this is fine for now.
            ['member' => 'Member', 'bronze' => 'Bronze', 'silver' => 'Silver', 'gold' => 'Gold']
        );
    }
}
</file>

<file path="includes/class-canna-cdp-handler.php">
<?php
/**
 * Canna CDP (Customer Data Platform) Handler
 *
 * This class serves as a centralized gateway for all communication with the
 * third-party CDP (e.g., Customer.io). It is responsible for formatting
 * and sending enriched user and event data.
 *
 * @package CannaRewards
 */

if (!defined('WPINC')) { die; }

class Canna_CDP_Handler {

    /**
     * Sends an event to the CDP for a specific user.
     *
     * This is the primary method for tracking user actions. It identifies the user
     * in the CDP and sends an event with an enriched data payload.
     *
     * @param int    $user_id     The WordPress user ID.
     * @param string $event_name  The name of the event (e.g., 'user_acquired', 'product_scanned').
     * @param array  $event_data  An associative array of data related to the event.
     */
    public static function send_event($user_id, $event_name, $event_data = []) {
        $user = get_userdata($user_id);
        if (!$user) {
            return; // Don't proceed if the user doesn't exist.
        }

        // In a real implementation, this is where you would get your API keys.
        // $site_id = get_option('customer_io_site_id');
        // $api_key = get_option('customer_io_api_key');
        // if (empty($site_id) || empty($api_key)) {
        //     error_log("CannaRewards CDP Handler: Customer.io API credentials are not set.");
        //     return;
        // }

        $payload = [
            'name' => $event_name,
            'data' => $event_data,
        ];

        // For now, we will log the event to the debug log instead of making a real API call.
        // This allows us to develop and test the event structure without needing live credentials.
        error_log('[CannaRewards CDP Event] User ID: ' . $user_id . ' | Event: ' . $event_name . ' | Payload: ' . json_encode($payload));

        /*
        // --- REAL IMPLEMENTATION EXAMPLE ---
        $api_url = "https://track.customer.io/api/v1/customers/{$user->user_email}/events";

        $response = wp_remote_post($api_url, [
            'method'    => 'POST',
            'headers'   => [
                'Authorization' => 'Basic ' . base64_encode("$site_id:$api_key"),
                'Content-Type'  => 'application/json',
            ],
            'body'      => json_encode($payload),
            'timeout'   => 15,
        ]);

        if (is_wp_error($response)) {
            error_log('CannaRewards CDP Handler: Failed to send event to Customer.io. WP_Error: ' . $response->get_error_message());
        }
        // --- END REAL IMPLEMENTATION EXAMPLE ---
        */
    }
}
</file>

<file path="includes/class-canna-custom-fields.php">
<?php
/**
 * Handles the registration of custom meta fields for CPTs.
 *
 * @package CannaRewards
 */

if (!defined('WPINC')) { die; }

class Canna_Custom_Fields {

    /**
     * Initializes the class by hooking into the 'init' action.
     */
    public static function init() {
        add_action('init', [self::class, 'register_meta_fields']);
    }

    /**
     * Registers all custom meta fields for the plugin.
     * This ensures they are properly exposed to the REST API.
     */
    public static function register_meta_fields() {
        // Meta fields for 'product' post type (WooCommerce)
        register_post_meta('product', 'points_cost', [
            'type'              => 'integer',
            'description'       => 'The cost of the reward in points.',
            'single'            => true,
            'show_in_rest'      => true,
            'auth_callback'     => 'absint' // Sanitize as integer
        ]);

        register_post_meta('product', '_required_rank', [
            'type'              => 'string',
            'description'       => 'The rank slug required to redeem this reward.',
            'single'            => true,
            'show_in_rest'      => true,
            'sanitize_callback' => 'sanitize_key' // Sanitize as a slug
        ]);

        register_post_meta('product', 'marketing_snippet', [
            'type'              => 'string',
            'description'       => 'A short marketing description for use in CDP events.',
            'single'            => true,
            'show_in_rest'      => true,
            'sanitize_callback' => 'sanitize_text_field'
        ]);

        // Meta fields for 'canna_rank' post type
        register_post_meta('canna_rank', 'point_multiplier', [
            'type'              => 'number',
            'description'       => 'The point multiplier for this rank (e.g., 1.5 for 1.5x points).',
            'single'            => true,
            'show_in_rest'      => true,
            'sanitize_callback' => 'floatval' // Sanitize as a float
        ]);
    }
}
</file>

<file path="phpcs.xml.dist">
<?xml version="1.0"?>
<ruleset name="CannaRewards Engine Coding Standards">
    <description>A custom ruleset for the CannaRewards Engine plugin based on WordPress Coding Standards.</description>
    
    <!-- What to scan -->
    <file>./</file>
    
    <!-- Exclude files we don't control or aren't PHP -->
    <exclude-pattern>*/vendor/*</exclude-pattern>
    <exclude-pattern>*/node_modules/*</exclude-pattern>
    <exclude-pattern>*/\.husky/*</exclude-pattern>
    
    <!-- Configure PHPCS to use the WordPress rules -->
    <rule ref="WordPress">
        <exclude name="WordPress.Files.FileName.InvalidClassFileName"/>
    </rule>
    
    <!-- Check for PHP cross-version compatibility -->
    <config name="testVersion" value="7.4-"/>
    <rule ref="PHPCompatibilityWP"/>

    <!-- Set some default options for the command line -->
    <arg name="colors"/>
    <arg value="s"/>
</ruleset>
</file>

<file path="playwright.config.js">
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests-api',
  reporter: 'list',
  use: {
    baseURL: 'http://cannarewards-api.local', // Make sure this is your correct Local site URL
  },
});
</file>

<file path="README.MD">
# CannaRewards Engine

## üöÄ Overview

This is the headless WordPress backend for the CannaRewards D2C Intelligence Platform. It is a custom plugin that provides all necessary API endpoints, a service-oriented business logic layer, and an administrative interface for managing the platform.

## üìã Prerequisites

- A WordPress installation (developed with LocalWP).
- WooCommerce plugin installed and active.
- PHP >= 7.4
- Composer for PHP dependency management.
- Node.js >= 18 (for development tooling like Husky).

## ‚öôÔ∏è Local Development Setup

1.  **Clone the repository:**
    Clone this project directly into your WordPress site's `/wp-content/plugins/` directory.
    ```bash
    git clone [your-repo-url] cannarewards-engine
    ```

2.  **Install PHP Dependencies:**
    Navigate into the plugin directory and run Composer.
    ```bash
    cd cannarewards-engine
    composer install
    ```

3.  **Install Node.js Dev Dependencies:**
    This is required for the pre-commit hooks to work.
    ```bash
    npm install
    ```

4.  **Activate the Plugin:**
    Log in to your WordPress admin dashboard, go to "Plugins", and activate the "CannaRewards Engine" plugin.

5.  **Run the Database Migration:**
    Deactivate and then Reactivate the plugin one time. This will trigger the `activate()` method in `class-canna-db.php` and create the necessary custom database tables.

## üèóÔ∏è Architecture

This project follows a service-oriented architecture to ensure a clean separation of concerns and maintainability.

-   **`/services`**: Contains all core business logic (e.g., `EconomyService`, `GamificationService`). These services are the "brains" of the operation.
-   **`/includes/api`**: Contains the lean REST API controllers. Their only job is to handle incoming requests, call the appropriate service, and format the response.
-   **`/admin`**: Contains the classes for building the WordPress admin UI (metaboxes, settings pages, etc.).
-   **Data Contracts:** The definitive API contract (`openapi.yaml`) and Data Taxonomy are maintained in the central "Living Blueprint" document.

## üß™ Running Linters

This project uses PHP_CodeSniffer with the WordPress Coding Standards to enforce code quality. This is run automatically on every commit via a Husky pre-commit hook.

To run the linter manually:
```bash
./vendor/bin/phpcs
</file>

<file path="schemas/entities/user_snapshot.v1.json">
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "User Snapshot v1",
  "type": "object",
  "properties": {
    "identity": {
      "type": "object",
      "properties": {
        "user_id": { "type": "integer" },
        "email": { "type": "string", "format": "email" },
        "first_name": { "type": ["string", "null"] },
        "created_at": { "type": "string" }
      },
      "required": ["user_id", "email", "created_at"]
    },
    "economy": {
      "type": "object",
      "properties": {
        "points_balance": { "type": "integer" },
        "lifetime_points": { "type": "integer" }
      },
      "required": ["points_balance", "lifetime_points"]
    },
    "status": {
      "type": "object",
      "properties": {
        "rank_key": { "type": "string" },
        "rank_name": { "type": "string" }
      },
      "required": ["rank_key", "rank_name"]
    },
    "engagement": {
      "type": "object",
      "properties": {
        "total_scans": { "type": "integer" }
      },
      "required": ["total_scans"]
    }
  },
  "required": ["identity", "economy", "status", "engagement"]
}
</file>

<file path="schemas/events/product_scanned.v1.json">
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Product Scanned v1",
  "type": "object",
  "properties": {
    "user_snapshot": {
      "$ref": "file://../entities/user_snapshot.v1.json"
    },
    "product_snapshot": {
      "type": ["object", "null"]
    },
    "event_context": {
      "type": "object"
    },
    "is_first_scan": {
      "type": "boolean"
    }
  },
  "required": ["user_snapshot", "product_snapshot", "event_context", "is_first_scan"]
}
</file>

<file path="tests-api/api-contract-validator.js">
import Ajv from 'ajv';
import addFormats from 'ajv-formats';
import yaml from 'js-yaml';
import fs from 'fs';
import path from 'path';

// Load and parse the OpenAPI spec ONCE at startup.
const specPath = path.resolve(__dirname, '../docs/openapi spec/notayaml.md');
const spec = yaml.load(fs.readFileSync(specPath, 'utf8'));

// --- THIS IS THE FIX ---
// We add `{ strict: false }` to tell the validator to ignore non-standard
// keywords like "example" that are common in OpenAPI specs.
const ajv = new Ajv({ strict: false, allErrors: true });
addFormats(ajv); // For formats like 'email', 'uri', etc.

/**
 * A helper function to resolve local $ref pointers in a schema against the main OpenAPI spec.
 * This is necessary for validating complex objects.
 * @param {object} schema - The schema object that may contain $refs.
 * @param {object} openApiSpec - The entire parsed OpenAPI specification.
 * @returns {object} A schema with all $refs resolved.
 */
function resolveRefs(schema, openApiSpec) {
    if (!schema || typeof schema !== 'object') {
        return schema;
    }

    if (schema.$ref) {
        const refPath = schema.$ref.replace('#/components/', '').split('/');
        let resolved = openApiSpec.components;
        refPath.forEach(p => { resolved = resolved[p]; });
        return resolveRefs(resolved, openApiSpec); // Recursively resolve refs in the referenced component
    }

    const newSchema = Array.isArray(schema) ? [] : {};
    for (const key in schema) {
        newSchema[key] = resolveRefs(schema[key], openApiSpec);
    }
    return newSchema;
}

/**
 * Validates an API response against the OpenAPI specification.
 * @param {import('@playwright/test').APIResponse} response - The response object from a Playwright request.
 * @param {string} endpointPath - The OpenAPI path template (e.g., '/actions/redeem').
 * @param {string} method - The HTTP method in lowercase (e.g., 'post').
 */
export async function validateApiContract(response, endpointPath, method) {
    const responseBody = await response.json();
    const statusCode = response.status().toString();

    const pathSpec = spec.paths[endpointPath];
    if (!pathSpec) {
        throw new Error(`[API Contract] Path "${endpointPath}" not found in OpenAPI spec.`);
    }

    const methodSpec = pathSpec[method.toLowerCase()];
    if (!methodSpec) {
        throw new Error(`[API Contract] Method "${method}" not found for path "${endpointPath}" in OpenAPI spec.`);
    }

    const responseSpec = methodSpec.responses[statusCode];
    if (!responseSpec) {
        throw new Error(`[API Contract] Response for status code "${statusCode}" not found for "${method} ${endpointPath}" in spec.`);
    }

    const schema = responseSpec.content?.['application/json']?.schema;
    if (!schema) {
        // If the spec defines no response body for this status code, we pass.
        if (responseBody === null || Object.keys(responseBody).length === 0) {
            return true;
        }
        throw new Error(`[API Contract] No application/json schema found for status ${statusCode} at "${method} ${endpointPath}", but a response body was received.`);
    }

    const resolvedSchema = resolveRefs(schema, spec);
    const validate = ajv.compile(resolvedSchema);
    const valid = validate(responseBody);

    if (!valid) {
        const errorDetails = JSON.stringify(validate.errors, null, 2);
        throw new Error(`[API Contract] Validation FAILED for "${method} ${endpointPath}" [${statusCode}]:\n${errorDetails}\nReceived Body:\n${JSON.stringify(responseBody, null, 2)}`);
    }

    return true; // Assertion passed
}
</file>

<file path="tests-api/healthcheck.spec.js">
import { test, expect } from '@playwright/test';

test('The WordPress REST API should be responsive', async ({ request }) => {
  // Act: Make a GET request to the root of the REST API
  const response = await request.get('/wp-json/');

  // Assert: The request should be successful
  expect(response.ok()).toBeTruthy();

  // Assert: The response body should have a 'name' property
  const body = await response.json();
  expect(body).toHaveProperty('name');
});
</file>

<file path="tests-api/test-helper.php">
<?php
/**
 * A helper script for Playwright tests to manipulate the database state.
 *
 * WARNING: THIS FILE SHOULD BE DELETED OR SECURED BEFORE GOING TO PRODUCTION.
 * It provides direct, unauthenticated access to modify database records.
 */

// Bootstrap WordPress to get access to its functions and database.
require_once dirname(__DIR__, 4) . '/wp-load.php';

// Set the response content type to JSON.
header('Content-Type: application/json');

// Get the requested action from the POST data.
$action = $_POST['action'] ?? '';

// Globalize the WordPress database object.
global $wpdb;

// Handle the requested action.
switch ($action) {

    /**
     * Resets a specific QR code to an unused state.
     * Deletes any existing entry for the code and re-inserts it as fresh.
     */
    case 'reset_qr_code':
        $code = sanitize_text_field($_POST['code'] ?? '');
        if (empty($code)) {
            echo json_encode(['success' => false, 'message' => 'Code parameter is missing.']);
            exit;
        }

        // Delete the code if it exists.
        $wpdb->delete($wpdb->prefix . 'canna_reward_codes', ['code' => $code]);

        // Re-insert the code as a fresh, unused entry linked to our test SKU.
        $wpdb->insert($wpdb->prefix . 'canna_reward_codes', [
            'code' => $code,
            'sku'  => 'PWT-001', // SKU for the 'Playwright Scan Product'
        ]);

        echo json_encode(['success' => true, 'message' => "Code {$code} has been reset."]);
        break;

    /**
     * Resets a test user's state.
     * Deletes all of their orders and sets their point balance to a specific amount.
     */
    case 'reset_user_by_email':
        $email = sanitize_email($_POST['email'] ?? '');
        if (empty($email)) {
            echo json_encode(['success' => false, 'message' => 'Email parameter is missing.']);
            exit;
        }

        $user = get_user_by('email', $email);
        if ($user) {
            // Delete all existing WooCommerce orders for this user to ensure a clean slate.
            if (class_exists('WooCommerce')) {
                $orders = wc_get_orders(['customer' => $email]);
                foreach ($orders as $order) {
                    $order->delete(true); // `true` bypasses the trash.
                }
            }

            // Set their points balance to a specific amount (defaults to 0).
            $points = isset($_POST['points_balance']) ? absint($_POST['points_balance']) : 0;
            update_user_meta($user->ID, '_canna_points_balance', $points);

            echo json_encode(['success' => true, 'message' => "User {$email} has been reset with {$points} points."]);
        } else {
            // If user doesn't exist, just return success so the test can proceed to create it.
            echo json_encode(['success' => true, 'message' => "User {$email} not found, proceeding."]);
        }
        break;

    /**
     * Default case for an unknown action.
     */
    default:
        // Set a 400 Bad Request status code.
        http_response_code(400);
        echo json_encode(['success' => false, 'message' => 'Invalid or missing action parameter.']);
        break;
}

// Exit cleanly.
exit;
</file>

<file path="tests-examples/demo-todo-app.spec.js">
// @ts-check
import { test, expect } from '@playwright/test';

test.beforeEach(async ({ page }) => {
  await page.goto('https://demo.playwright.dev/todomvc');
});

const TODO_ITEMS = [
  'buy some cheese',
  'feed the cat',
  'book a doctors appointment'
];

test.describe('New Todo', () => {
  test('should allow me to add todo items', async ({ page }) => {
    // create a new todo locator
    const newTodo = page.getByPlaceholder('What needs to be done?');

    // Create 1st todo.
    await newTodo.fill(TODO_ITEMS[0]);
    await newTodo.press('Enter');

    // Make sure the list only has one todo item.
    await expect(page.getByTestId('todo-title')).toHaveText([
      TODO_ITEMS[0]
    ]);

    // Create 2nd todo.
    await newTodo.fill(TODO_ITEMS[1]);
    await newTodo.press('Enter');

    // Make sure the list now has two todo items.
    await expect(page.getByTestId('todo-title')).toHaveText([
      TODO_ITEMS[0],
      TODO_ITEMS[1]
    ]);

    await checkNumberOfTodosInLocalStorage(page, 2);
  });

  test('should clear text input field when an item is added', async ({ page }) => {
    // create a new todo locator
    const newTodo = page.getByPlaceholder('What needs to be done?');

    // Create one todo item.
    await newTodo.fill(TODO_ITEMS[0]);
    await newTodo.press('Enter');

    // Check that input is empty.
    await expect(newTodo).toBeEmpty();
    await checkNumberOfTodosInLocalStorage(page, 1);
  });

  test('should append new items to the bottom of the list', async ({ page }) => {
    // Create 3 items.
    await createDefaultTodos(page);

    // create a todo count locator
    const todoCount = page.getByTestId('todo-count')
  
    // Check test using different methods.
    await expect(page.getByText('3 items left')).toBeVisible();
    await expect(todoCount).toHaveText('3 items left');
    await expect(todoCount).toContainText('3');
    await expect(todoCount).toHaveText(/3/);

    // Check all items in one call.
    await expect(page.getByTestId('todo-title')).toHaveText(TODO_ITEMS);
    await checkNumberOfTodosInLocalStorage(page, 3);
  });
});

test.describe('Mark all as completed', () => {
  test.beforeEach(async ({ page }) => {
    await createDefaultTodos(page);
    await checkNumberOfTodosInLocalStorage(page, 3);
  });

  test.afterEach(async ({ page }) => {
    await checkNumberOfTodosInLocalStorage(page, 3);
  });

  test('should allow me to mark all items as completed', async ({ page }) => {
    // Complete all todos.
    await page.getByLabel('Mark all as complete').check();

    // Ensure all todos have 'completed' class.
    await expect(page.getByTestId('todo-item')).toHaveClass(['completed', 'completed', 'completed']);
    await checkNumberOfCompletedTodosInLocalStorage(page, 3);
  });

  test('should allow me to clear the complete state of all items', async ({ page }) => {
    const toggleAll = page.getByLabel('Mark all as complete');
    // Check and then immediately uncheck.
    await toggleAll.check();
    await toggleAll.uncheck();

    // Should be no completed classes.
    await expect(page.getByTestId('todo-item')).toHaveClass(['', '', '']);
  });

  test('complete all checkbox should update state when items are completed / cleared', async ({ page }) => {
    const toggleAll = page.getByLabel('Mark all as complete');
    await toggleAll.check();
    await expect(toggleAll).toBeChecked();
    await checkNumberOfCompletedTodosInLocalStorage(page, 3);

    // Uncheck first todo.
    const firstTodo = page.getByTestId('todo-item').nth(0);
    await firstTodo.getByRole('checkbox').uncheck();

    // Reuse toggleAll locator and make sure its not checked.
    await expect(toggleAll).not.toBeChecked();

    await firstTodo.getByRole('checkbox').check();
    await checkNumberOfCompletedTodosInLocalStorage(page, 3);

    // Assert the toggle all is checked again.
    await expect(toggleAll).toBeChecked();
  });
});

test.describe('Item', () => {

  test('should allow me to mark items as complete', async ({ page }) => {
    // create a new todo locator
    const newTodo = page.getByPlaceholder('What needs to be done?');

    // Create two items.
    for (const item of TODO_ITEMS.slice(0, 2)) {
      await newTodo.fill(item);
      await newTodo.press('Enter');
    }

    // Check first item.
    const firstTodo = page.getByTestId('todo-item').nth(0);
    await firstTodo.getByRole('checkbox').check();
    await expect(firstTodo).toHaveClass('completed');

    // Check second item.
    const secondTodo = page.getByTestId('todo-item').nth(1);
    await expect(secondTodo).not.toHaveClass('completed');
    await secondTodo.getByRole('checkbox').check();

    // Assert completed class.
    await expect(firstTodo).toHaveClass('completed');
    await expect(secondTodo).toHaveClass('completed');
  });

  test('should allow me to un-mark items as complete', async ({ page }) => {
     // create a new todo locator
     const newTodo = page.getByPlaceholder('What needs to be done?');

    // Create two items.
    for (const item of TODO_ITEMS.slice(0, 2)) {
      await newTodo.fill(item);
      await newTodo.press('Enter');
    }

    const firstTodo = page.getByTestId('todo-item').nth(0);
    const secondTodo = page.getByTestId('todo-item').nth(1);
    const firstTodoCheckbox = firstTodo.getByRole('checkbox');

    await firstTodoCheckbox.check();
    await expect(firstTodo).toHaveClass('completed');
    await expect(secondTodo).not.toHaveClass('completed');
    await checkNumberOfCompletedTodosInLocalStorage(page, 1);

    await firstTodoCheckbox.uncheck();
    await expect(firstTodo).not.toHaveClass('completed');
    await expect(secondTodo).not.toHaveClass('completed');
    await checkNumberOfCompletedTodosInLocalStorage(page, 0);
  });

  test('should allow me to edit an item', async ({ page }) => {
    await createDefaultTodos(page);

    const todoItems = page.getByTestId('todo-item');
    const secondTodo = todoItems.nth(1);
    await secondTodo.dblclick();
    await expect(secondTodo.getByRole('textbox', { name: 'Edit' })).toHaveValue(TODO_ITEMS[1]);
    await secondTodo.getByRole('textbox', { name: 'Edit' }).fill('buy some sausages');
    await secondTodo.getByRole('textbox', { name: 'Edit' }).press('Enter');

    // Explicitly assert the new text value.
    await expect(todoItems).toHaveText([
      TODO_ITEMS[0],
      'buy some sausages',
      TODO_ITEMS[2]
    ]);
    await checkTodosInLocalStorage(page, 'buy some sausages');
  });
});

test.describe('Editing', () => {
  test.beforeEach(async ({ page }) => {
    await createDefaultTodos(page);
    await checkNumberOfTodosInLocalStorage(page, 3);
  });

  test('should hide other controls when editing', async ({ page }) => {
    const todoItem = page.getByTestId('todo-item').nth(1);
    await todoItem.dblclick();
    await expect(todoItem.getByRole('checkbox')).not.toBeVisible();
    await expect(todoItem.locator('label', {
      hasText: TODO_ITEMS[1],
    })).not.toBeVisible();
    await checkNumberOfTodosInLocalStorage(page, 3);
  });

  test('should save edits on blur', async ({ page }) => {
    const todoItems = page.getByTestId('todo-item');
    await todoItems.nth(1).dblclick();
    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).fill('buy some sausages');
    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).dispatchEvent('blur');

    await expect(todoItems).toHaveText([
      TODO_ITEMS[0],
      'buy some sausages',
      TODO_ITEMS[2],
    ]);
    await checkTodosInLocalStorage(page, 'buy some sausages');
  });

  test('should trim entered text', async ({ page }) => {
    const todoItems = page.getByTestId('todo-item');
    await todoItems.nth(1).dblclick();
    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).fill('    buy some sausages    ');
    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).press('Enter');

    await expect(todoItems).toHaveText([
      TODO_ITEMS[0],
      'buy some sausages',
      TODO_ITEMS[2],
    ]);
    await checkTodosInLocalStorage(page, 'buy some sausages');
  });

  test('should remove the item if an empty text string was entered', async ({ page }) => {
    const todoItems = page.getByTestId('todo-item');
    await todoItems.nth(1).dblclick();
    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).fill('');
    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).press('Enter');

    await expect(todoItems).toHaveText([
      TODO_ITEMS[0],
      TODO_ITEMS[2],
    ]);
  });

  test('should cancel edits on escape', async ({ page }) => {
    const todoItems = page.getByTestId('todo-item');
    await todoItems.nth(1).dblclick();
    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).fill('buy some sausages');
    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).press('Escape');
    await expect(todoItems).toHaveText(TODO_ITEMS);
  });
});

test.describe('Counter', () => {
  test('should display the current number of todo items', async ({ page }) => {
    // create a new todo locator
    const newTodo = page.getByPlaceholder('What needs to be done?');

    // create a todo count locator
    const todoCount = page.getByTestId('todo-count')

    await newTodo.fill(TODO_ITEMS[0]);
    await newTodo.press('Enter');
    await expect(todoCount).toContainText('1');

    await newTodo.fill(TODO_ITEMS[1]);
    await newTodo.press('Enter');
    await expect(todoCount).toContainText('2');

    await checkNumberOfTodosInLocalStorage(page, 2);
  });
});

test.describe('Clear completed button', () => {
  test.beforeEach(async ({ page }) => {
    await createDefaultTodos(page);
  });

  test('should display the correct text', async ({ page }) => {
    await page.locator('.todo-list li .toggle').first().check();
    await expect(page.getByRole('button', { name: 'Clear completed' })).toBeVisible();
  });

  test('should remove completed items when clicked', async ({ page }) => {
    const todoItems = page.getByTestId('todo-item');
    await todoItems.nth(1).getByRole('checkbox').check();
    await page.getByRole('button', { name: 'Clear completed' }).click();
    await expect(todoItems).toHaveCount(2);
    await expect(todoItems).toHaveText([TODO_ITEMS[0], TODO_ITEMS[2]]);
  });

  test('should be hidden when there are no items that are completed', async ({ page }) => {
    await page.locator('.todo-list li .toggle').first().check();
    await page.getByRole('button', { name: 'Clear completed' }).click();
    await expect(page.getByRole('button', { name: 'Clear completed' })).toBeHidden();
  });
});

test.describe('Persistence', () => {
  test('should persist its data', async ({ page }) => {
    // create a new todo locator
    const newTodo = page.getByPlaceholder('What needs to be done?');

    for (const item of TODO_ITEMS.slice(0, 2)) {
      await newTodo.fill(item);
      await newTodo.press('Enter');
    }

    const todoItems = page.getByTestId('todo-item');
    const firstTodoCheck = todoItems.nth(0).getByRole('checkbox');
    await firstTodoCheck.check();
    await expect(todoItems).toHaveText([TODO_ITEMS[0], TODO_ITEMS[1]]);
    await expect(firstTodoCheck).toBeChecked();
    await expect(todoItems).toHaveClass(['completed', '']);

    // Ensure there is 1 completed item.
    await checkNumberOfCompletedTodosInLocalStorage(page, 1);

    // Now reload.
    await page.reload();
    await expect(todoItems).toHaveText([TODO_ITEMS[0], TODO_ITEMS[1]]);
    await expect(firstTodoCheck).toBeChecked();
    await expect(todoItems).toHaveClass(['completed', '']);
  });
});

test.describe('Routing', () => {
  test.beforeEach(async ({ page }) => {
    await createDefaultTodos(page);
    // make sure the app had a chance to save updated todos in storage
    // before navigating to a new view, otherwise the items can get lost :(
    // in some frameworks like Durandal
    await checkTodosInLocalStorage(page, TODO_ITEMS[0]);
  });

  test('should allow me to display active items', async ({ page }) => {
    const todoItem = page.getByTestId('todo-item');
    await page.getByTestId('todo-item').nth(1).getByRole('checkbox').check();
    
    await checkNumberOfCompletedTodosInLocalStorage(page, 1);
    await page.getByRole('link', { name: 'Active' }).click();
    await expect(todoItem).toHaveCount(2);
    await expect(todoItem).toHaveText([TODO_ITEMS[0], TODO_ITEMS[2]]);
  });

  test('should respect the back button', async ({ page }) => {
    const todoItem = page.getByTestId('todo-item');
    await page.getByTestId('todo-item').nth(1).getByRole('checkbox').check();

    await checkNumberOfCompletedTodosInLocalStorage(page, 1);

    await test.step('Showing all items', async () => {
      await page.getByRole('link', { name: 'All' }).click();
      await expect(todoItem).toHaveCount(3);
    });

    await test.step('Showing active items', async () => {
      await page.getByRole('link', { name: 'Active' }).click();
    });

    await test.step('Showing completed items', async () => {
      await page.getByRole('link', { name: 'Completed' }).click();
    });

    await expect(todoItem).toHaveCount(1);
    await page.goBack();
    await expect(todoItem).toHaveCount(2);
    await page.goBack();
    await expect(todoItem).toHaveCount(3);
  });

  test('should allow me to display completed items', async ({ page }) => {
    await page.getByTestId('todo-item').nth(1).getByRole('checkbox').check();
    await checkNumberOfCompletedTodosInLocalStorage(page, 1);
    await page.getByRole('link', { name: 'Completed' }).click();
    await expect(page.getByTestId('todo-item')).toHaveCount(1);
  });

  test('should allow me to display all items', async ({ page }) => {
    await page.getByTestId('todo-item').nth(1).getByRole('checkbox').check();
    await checkNumberOfCompletedTodosInLocalStorage(page, 1);
    await page.getByRole('link', { name: 'Active' }).click();
    await page.getByRole('link', { name: 'Completed' }).click();
    await page.getByRole('link', { name: 'All' }).click();
    await expect(page.getByTestId('todo-item')).toHaveCount(3);
  });

  test('should highlight the currently applied filter', async ({ page }) => {
    await expect(page.getByRole('link', { name: 'All' })).toHaveClass('selected');

    //create locators for active and completed links
    const activeLink = page.getByRole('link', { name: 'Active' });
    const completedLink = page.getByRole('link', { name: 'Completed' });
    await activeLink.click();

    // Page change - active items.
    await expect(activeLink).toHaveClass('selected');
    await completedLink.click();

    // Page change - completed items.
    await expect(completedLink).toHaveClass('selected');
  });
});

async function createDefaultTodos(page) {
  // create a new todo locator
  const newTodo = page.getByPlaceholder('What needs to be done?');

  for (const item of TODO_ITEMS) {
    await newTodo.fill(item);
    await newTodo.press('Enter');
  }
}

/**
 * @param {import('@playwright/test').Page} page
 * @param {number} expected
 */
 async function checkNumberOfTodosInLocalStorage(page, expected) {
  return await page.waitForFunction(e => {
    return JSON.parse(localStorage['react-todos']).length === e;
  }, expected);
}

/**
 * @param {import('@playwright/test').Page} page
 * @param {number} expected
 */
 async function checkNumberOfCompletedTodosInLocalStorage(page, expected) {
  return await page.waitForFunction(e => {
    return JSON.parse(localStorage['react-todos']).filter(i => i.completed).length === e;
  }, expected);
}

/**
 * @param {import('@playwright/test').Page} page
 * @param {string} title
 */
async function checkTodosInLocalStorage(page, title) {
  return await page.waitForFunction(t => {
    return JSON.parse(localStorage['react-todos']).map(i => i.title).includes(t);
  }, title);
}
</file>

<file path="tests/example.spec.js">
// @ts-check
import { test, expect } from '@playwright/test';

test('has title', async ({ page }) => {
  await page.goto('https://playwright.dev/');

  // Expect a title "to contain" a substring.
  await expect(page).toHaveTitle(/Playwright/);
});

test('get started link', async ({ page }) => {
  await page.goto('https://playwright.dev/');

  // Click the get started link.
  await page.getByRole('link', { name: 'Get started' }).click();

  // Expects page to have a heading with the name of Installation.
  await expect(page.getByRole('heading', { name: 'Installation' })).toBeVisible();
});
</file>

<file path=".husky/pre-commit">
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "Running PHP CodeSniffer..."
composer lint
</file>

<file path="docs/openapi spec/notayaml.md">
openapi: 3.0.3
info:
  title: CannaRewards API
  description: |-
    The official API contract for the CannaRewards v2 platform. 
    This API is designed with a service-oriented, event-driven backend to power a headless PWA. 
    It provides a comprehensive suite of endpoints for managing users, economy, gamification, and content.
  version: 2.0.0
  contact:
    name: API Support
    url: https://yourwebsite.com/support
    email: dev@yourdomain.com

servers:
  - url: https://your-backend-domain.com/wp-json/rewards/v2
    description: Production Server
  - url: http://cannarewards-api.local/wp-json/rewards/v2
    description: Local Development Server

tags:
  - name: App & Session
    description: Endpoints for core application configuration and lightweight session management.
  - name: User Profile & Data
    description: Endpoints for fetching and updating detailed user profile information.
  - name: Economy
    description: Endpoints related to the points economy, rewards catalog, and wishlisting.
  - name: Actions
    description: Primary endpoints that trigger core user actions and business events.
  - name: Authentication
    description: Endpoints for user registration, login, and password management.
  - name: Pages
    description: Endpoints for retrieving general WordPress content.

#--------------------------------
# Reusable Components
#--------------------------------
components:
  schemas:
    # --- Model Schemas ---
    Rank:
      type: object
      description: "Represents a single rank or tier in the loyalty program."
      properties:
        key: 
          type: string
          example: "gold"
          description: "The unique, machine-readable key for the rank."
        name: 
          type: string
          example: "Gold"
          description: "The human-readable name of the rank."
        points_required: 
          type: integer
          format: int64
          example: 5000
          description: "The lifetime points required to achieve this rank."
        point_multiplier: 
          type: number
          format: float
          example: 1.5
          description: "The point earning multiplier for this rank."
        benefits: 
          type: array
          items: 
            type: string
          example: ["Early access to new rewards", "Exclusive merch"]
          description: "A list of perks for this rank."

    Achievement:
      type: object
      description: "Represents the definition of a single achievement."
      properties:
        title: 
          type: string
          example: "Sativa Specialist"
        description: 
          type: string
          example: "Scan 5 different Sativa products."
        rarity: 
          type: string
          enum: [common, uncommon, rare, epic, legendary]
          example: "rare"
        icon_url: 
          type: string
          format: uri
          nullable: true
          description: "URL for the achievement's icon image."
    
    RewardProduct:
      type: object
      description: "A simplified representation of a WooCommerce product that can be redeemed with points."
      properties:
        id: 
          type: integer
          example: 82
        name: 
          type: string
          example: "Limited Edition Hoodie"
        points_cost: 
          type: integer
          example: 4500
        image_url: 
          type: string
          format: uri
          nullable: true
        tags: 
          type: array
          items: 
            type: string
          example: ["limited", "new"]

    Order:
      type: object
      description: "Represents a single redeemed order."
      properties:
        orderId:
          type: integer
        date:
          type: string
          format: date
        status:
          type: string
        items:
          type: string
        imageUrl:
          type: string
          format: uri

    SessionUser:
      type: object
      description: "A lightweight object representing the core data for an authenticated user's session."
      properties:
        id: 
          type: integer
          example: 123
        firstName: 
          type: string
          example: "Jane"
          nullable: true
        email: 
          type: string
          format: email
        points_balance: 
          type: integer
          example: 1250
        rank:
          type: object
          properties:
            key: { type: string, example: "silver" }
            name: { type: string, example: "Silver" }
        onboarding_quest_step: 
          type: integer
          example: 2
        feature_flags: 
          type: object
          description: "Flags for A/B testing frontend features."
          example: {"dashboard_version": "B"}

    ShippingAddress:
      type: object
      description: "A standard shipping address object."
      required: [first_name, last_name, address_1, city, state, postcode]
      properties:
        first_name: { type: string, example: "Jane" }
        last_name: { type: string, example: "Doe" }
        address_1: { type: string, example: "123 Main St" }
        city: { type: string, example: "Anytown" }
        state: { type: string, example: "CA" }
        postcode: { type: string, example: "90210" }

    CustomFieldDefinition:
      type: object
      description: "The schema for a single dynamically defined custom field."
      properties:
        key: { type: string, example: "favorite_strain_type", description: "The meta key for the field." }
        label: { type: string, example: "Favorite Strain Type", description: "The human-readable label." }
        type: { type: string, enum: [text, date, dropdown], description: "The type of form input to render." }
        options: { type: array, items: { type: string }, example: ["Sativa", "Indica", "Hybrid"], description: "Options for dropdown type." }
        display: { type: array, items: { type: string }, example: ["edit_profile", "registration"], description: "Where in the UI this field should appear." }

    # --- Request Body Schemas ---
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "jane.doe@example.com" }
        password: { type: string, format: password, example: "Str0ngP@ssw0rd!" }
    
    RegisterRequest:
      type: object
      required: [email, password, firstName, agreedToTerms]
      properties:
        email: { type: string, format: email }
        password: { type: string, format: password, minLength: 8 }
        firstName: { type: string }
        lastName: { type: string }
        phone: { type: string, description: "Optional phone number." }
        agreedToTerms: { type: boolean, description: "Must be true to register." }
        agreedToMarketing: { type: boolean }
        referralCode: { type: string, description: "Optional referral code from another user." }
        claimCode: { type: string, description: "Optional QR code from a product scan during unauthenticated registration." }

    # --- Generic Response Schemas ---
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object

    # --- Error Schemas ---
    Error:
      type: object
      required: [message]
      properties:
        code: { type: string, example: "rest_unauthorized" }
        message: { type: string, example: "Authentication is required." }
        data: { type: object, properties: { status: { type: integer, example: 401 } } }

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "A JWT obtained from the /auth/login endpoint."

  responses:
    UnauthorizedError:
      description: Authentication information is missing or invalid (401).
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    ForbiddenError:
      description: The authenticated user does not have permission to perform this action (403).
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    NotFoundError:
      description: The requested resource was not found (404).
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    BadRequestError:
      description: The request was malformed or missing required parameters (400).
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    ConflictError:
      description: The request could not be completed due to a conflict with the current state of the resource (409).
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    CreatedSuccess:
      description: The resource was created successfully (201).
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/SuccessResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      userId: { type: integer }

#--------------------------------
# Paths (API Endpoints)
#--------------------------------
paths:
  # App & Session
  /app/config:
    get:
      tags: [App & Session]
      summary: Get App Configuration
      description: Fetches all static, global configuration for the application. This data changes infrequently and should be cached heavily by the client for the duration of a session.
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: Successful response containing all application configuration.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          settings:
                            type: object
                            description: "Brand personality and theme settings."
                          all_ranks:
                            type: object
                            description: "A dictionary of all available ranks, keyed by rank key."
                            additionalProperties:
                              $ref: '#/components/schemas/Rank'
                          all_achievements:
                            type: object
                            description: "A dictionary of all available achievements, keyed by achievement key."
                            additionalProperties:
                              $ref: '#/components/schemas/Achievement'
        '401': { $ref: '#/components/responses/UnauthorizedError' }

  /users/me/session:
    get:
      tags: [App & Session]
      summary: Get Session Data
      description: A lightweight 'heartbeat' endpoint. Verifies the user's token and returns the minimal data needed to render the authenticated app shell.
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/SessionUser'
        '401': { $ref: '#/components/responses/UnauthorizedError' }

  /users/me/orders:
    get:
      tags: [User Profile & Data]
      summary: Get User's Redeemed Orders
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          orders:
                            type: array
                            items:
                              $ref: '#/components/schemas/Order'
        '401': { $ref: '#/components/responses/UnauthorizedError' }

  # User Profile & Data
  /users/me/dashboard:
    get:
      tags: [User Profile & Data]
      summary: Get Dashboard Data
      description: Fetches the dynamic, personalized data and UI suggestions for the main user dashboard.
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  lifetime_points: { type: integer }
                  active_goal_id: { type: integer, nullable: true }
                  wishlist_count: { type: integer }
                  achievements_in_progress: { type: object }
                  ui_suggestions: { type: array, items: { type: object } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }

  /users/me/profile:
    get:
      tags: [User Profile & Data]
      summary: Get Full Profile Data
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  lastName: { type: string, nullable: true }
                  phone_number: { type: string, nullable: true }
                  referral_code: { type: string, nullable: true }
                  shipping_address: { $ref: '#/components/schemas/ShippingAddress' }
                  unlocked_achievement_keys: { type: array, items: { type: string } }
                  custom_fields:
                    type: object
                    properties:
                      definitions: { type: array, items: { $ref: '#/components/schemas/CustomFieldDefinition' } }
                      values: { type: object }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
    post:
      tags: [User Profile & Data]
      summary: Update Profile Data
      security: [ { bearerAuth: [] } ]
      requestBody:
        description: A payload containing only the fields to be updated.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstName: { type: string }
                lastName: { type: string }
                phone_number: { type: string }
                custom_fields:
                  type: object
                  example: { "favorite_strain_type": "Indica" }
      responses:
        '200':
          description: Update successful. Returns the full, updated profile object.
          content:
            application/json:
              schema:
                $ref: '#/paths/~1users~1me~1profile/get/responses/200/content/application~1json/schema'
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }

  # Economy
  /catalog:
    get:
      tags: [Economy]
      summary: Get Rewards Catalog
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  featured_rewards: { type: array, items: { $ref: '#/components/schemas/RewardProduct' } }
                  all_rewards: { type: array, items: { $ref: '#/components/schemas/RewardProduct' } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }

  # Actions
  /actions/claim:
    post:
      tags: [Actions]
      summary: Process a Product Scan
      description: Initiates the core 'product_scanned' event. The response reflects only the immediate economic outcome.
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code: { type: string, example: "SKU123-ABCDEF9876" }
      responses:
        '200':
          description: Scan processed successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          message: { type: string, example: "You earned 400 points!" }
                          points_earned: { type: integer, example: 400 }
                          new_points_balance: { type: integer, example: 1650 }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '404': { $ref: '#/components/responses/NotFoundError' }

  /actions/redeem:
    post:
      tags: [Actions]
      summary: Redeem a Reward
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [productId]
              properties:
                productId: { type: integer, example: 82 }
                shippingDetails: { $ref: '#/components/schemas/ShippingAddress', nullable: true }
      responses:
        '200':
          description: Redemption successful.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          order_id: { type: integer, example: 12345 }
                          new_points_balance: { type: integer, example: 800 }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '402': { description: Insufficient points. }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  
  /unauthenticated/claim:
    post:
      tags: [Actions]
      summary: Process an Unauthenticated Product Scan
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code: { type: string }
      responses:
        '200':
          description: Code is valid, registration is required.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          status: { type: string, example: 'registration_required' }
                          registration_token: { type: string }
                          reward_preview:
                            type: object
                            properties:
                              id: { type: integer }
                              name: { type: string }
                              image: { type: string, format: uri }

  # Pages
  /pages/{slug}:
    get:
      tags: [Pages]
      summary: Get Page Content
      parameters: [ { name: slug, in: path, required: true, schema: { type: string, example: "terms-and-conditions" } } ]
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  title: { type: string }
                  content: { type: string, description: "HTML content of the page." }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '404': { $ref: '#/components/responses/NotFoundError' }

  # Authentication
  /auth/register:
    post:
      tags: [Authentication]
      summary: Register User
      description: Creates a new user account. Returns a success message and user ID. The client should typically proceed to log the user in to get a token.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201': { $ref: '#/components/responses/CreatedSuccess' }
        '409': { $ref: '#/components/responses/ConflictError' }
        '400': { $ref: '#/components/responses/BadRequestError' }

  /auth/register-with-token:
    post:
      tags: [Authentication]
      summary: Register user with a claim token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
                password: { type: string }
                firstName: { type: string }
                lastName: { type: string }
                agreedToTerms: { type: boolean }
                registration_token: { type: string }
      responses:
        '200':
          description: Registration successful, JWT returned.
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string }
                  user_email: { type: string, format: email }
                  user_display_name: { type: string }
                  user_nicename: { type: string }

  /auth/login:
    post:
      tags: [Authentication]
      summary: Login with Password
      description: Authenticates a user with email/password and returns a JWT for subsequent authenticated requests.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authentication successful, JWT returned.
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string, example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." }
                  user_email: { type: string, format: email }
                  user_display_name: { type: string }
        '403': { $ref: '#/components/responses/ForbiddenError' }
</file>

<file path="includes/CannaRewards/Admin/AchievementMetabox.php">
<?php
namespace CannaRewards\Admin;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Defines the metabox for the CannaRewards Achievement Custom Post Type.
 * Now includes a JavaScript-powered rule builder UI.
 */
class AchievementMetabox {

    public function __construct() {
        add_action('add_meta_boxes', [$this, 'add_achievement_metabox']);
        add_action('save_post_canna_achievement', [$this, 'save_metabox_data']);
        add_action('admin_enqueue_scripts', [$this, 'enqueue_scripts']);
    }
    
    // We need to enqueue a dummy script to use wp_localize_script
    public function enqueue_scripts($hook) {
        if ('post.php' !== $hook && 'post-new.php' !== $hook) {
            return;
        }
        wp_enqueue_script('canna-rule-builder', plugin_dir_url(CANNA_PLUGIN_FILE) . 'assets/js/noop.js', [], '1.0.0', true);
    }

    public function add_achievement_metabox() {
        add_meta_box(
            'canna_achievement_details',
            __('Achievement Details & Rules', 'canna-rewards'),
            [$this, 'render_metabox'],
            'canna_achievement',
            'normal',
            'high'
        );
    }

    public function render_metabox($post) {
        wp_nonce_field('canna_save_achievement_metabox_data', 'canna_achievement_metabox_nonce');

        // Get existing data
        $points_reward   = get_post_meta($post->ID, 'points_reward', true);
        $rarity          = get_post_meta($post->ID, 'rarity', true);
        $trigger_event   = get_post_meta($post->ID, 'trigger_event', true);
        $trigger_count   = get_post_meta($post->ID, 'trigger_count', true) ?: 1;
        $conditions_json = get_post_meta($post->ID, 'conditions', true) ?: '[]';
        
        // Pass data to our JavaScript rule builder
        wp_localize_script('canna-rule-builder', 'cannaRuleBuilderSettings', [
            'apiUrl' => esc_url_raw(rest_url('rewards/v2/rules/conditions')),
            'nonce' => wp_create_nonce('wp_rest'),
            'savedConditions' => json_decode($conditions_json)
        ]);

        ?>
        <table class="form-table">
            <tbody>
                <tr>
                    <th scope="row"><label for="points_reward"><?php _e('Points Reward', 'canna-rewards'); ?></label></th>
                    <td><input type="number" id="points_reward" name="points_reward" value="<?php echo esc_attr($points_reward); ?>" class="small-text" min="0" /></td>
                </tr>
                <tr>
                    <th scope="row"><label for="rarity"><?php _e('Rarity', 'canna-rewards'); ?></label></th>
                    <td>
                        <select id="rarity" name="rarity">
                            <option value="common" <?php selected($rarity, 'common'); ?>>Common</option>
                            <option value="uncommon" <?php selected($rarity, 'uncommon'); ?>>Uncommon</option>
                            <option value="rare" <?php selected($rarity, 'rare'); ?>>Rare</option>
                            <option value="epic" <?php selected($rarity, 'epic'); ?>>Epic</option>
                            <option value="legendary" <?php selected($rarity, 'legendary'); ?>>Legendary</option>
                        </select>
                    </td>
                </tr>
                <tr style="border-top: 1px solid #ddd;">
                    <th scope="row" colspan="2"><h4><?php _e('Rule Engine', 'canna-rewards'); ?></h4></th>
                </tr>
                <tr>
                    <th scope="row"><label for="trigger_event"><?php _e('Triggered When', 'canna-rewards'); ?></label></th>
                    <td>
                        <select id="trigger_event" name="trigger_event" style="width: 200px;">
                            <option value="product_scanned" <?php selected($trigger_event, 'product_scanned'); ?>>Product Scanned</option>
                            <option value="reward_redeemed" <?php selected($trigger_event, 'reward_redeemed'); ?>>Reward Redeemed</option>
                            <option value="user_rank_changed" <?php selected($trigger_event, 'user_rank_changed'); ?>>User Rank Changed</option>
                        </select>
                        <input type="number" id="trigger_count" name="trigger_count" value="<?php echo esc_attr($trigger_count); ?>" class="small-text" min="1" />
                        <label for="trigger_count">time(s)</label>
                    </td>
                </tr>
                <tr>
                    <th scope="row"><?php _e('Conditions', 'canna-rewards'); ?></th>
                    <td>
                        <div id="rule-builder-container"></div>
                        <button type="button" class="button" id="add-rule-btn"><?php _e('+ Add Condition', 'canna-rewards'); ?></button>
                        <p class="description">All conditions must be true for the achievement to be awarded.</p>
                        <input type="hidden" name="conditions" id="conditions-hidden-input" />
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Rule Row Template -->
        <template id="rule-row-template">
            <div class="rule-row" style="margin-bottom: 10px; display: flex; gap: 5px; align-items: center;">
                <select class="rule-field" style="width: 200px;"></select>
                <select class="rule-operator" style="width: 150px;"></select>
                <div class="rule-value-wrapper" style="display: inline-block;"></div>
                <button type="button" class="button button-link-delete remove-rule-btn">&times;</button>
            </div>
        </template>
        
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CONFIG ---
            const container = document.getElementById('rule-builder-container');
            const addBtn = document.getElementById('add-rule-btn');
            const template = document.getElementById('rule-row-template');
            const form = document.querySelector('form#post');
            const hiddenInput = document.getElementById('conditions-hidden-input');
            let availableConditions = [];

            // --- INITIALIZATION ---
            async function init() {
                try {
                    const response = await fetch(cannaRuleBuilderSettings.apiUrl, {
                        headers: { 'X-WP-Nonce': cannaRuleBuilderSettings.nonce }
                    });
                    if (!response.ok) throw new Error('Failed to fetch rule conditions.');
                    
                    availableConditions = await response.json();
                    
                    // Render existing saved conditions
                    cannaRuleBuilderSettings.savedConditions.forEach(condition => addRuleRow(condition));

                } catch (error) {
                    container.innerHTML = `<p style="color: red;"><strong>Error:</strong> Could not load rule builder. ${error.message}</p>`;
                    console.error(error);
                }
            }

            // --- UI FUNCTIONS ---
            function addRuleRow(condition = {}) {
                const clone = template.content.cloneNode(true);
                const row = clone.querySelector('.rule-row');
                const fieldSelect = clone.querySelector('.rule-field');
                const operatorSelect = clone.querySelector('.rule-operator');
                const valueWrapper = clone.querySelector('.rule-value-wrapper');

                // Populate Field dropdown
                availableConditions.forEach(opt => {
                    fieldSelect.add(new Option(opt.label, opt.key));
                });

                // Event listener to update operator and value when field changes
                fieldSelect.addEventListener('change', () => updateRow(row, fieldSelect.value));
                
                // Set initial value and trigger change to populate the rest
                if (condition.field) {
                    fieldSelect.value = condition.field;
                }
                updateRow(row, fieldSelect.value, condition);

                container.appendChild(clone);
            }

            function updateRow(row, selectedFieldKey, existingCondition = {}) {
                const operatorSelect = row.querySelector('.rule-operator');
                const valueWrapper = row.querySelector('.rule-value-wrapper');
                const selectedCondition = availableConditions.find(c => c.key === selectedFieldKey);

                // Update operators
                operatorSelect.innerHTML = '';
                selectedCondition.operators.forEach(op => operatorSelect.add(new Option(op, op)));
                if (existingCondition.operator) {
                    operatorSelect.value = existingCondition.operator;
                }

                // Update value input
                valueWrapper.innerHTML = '';
                let valueInput;
                if (selectedCondition.inputType === 'select') {
                    valueInput = document.createElement('select');
                    valueInput.style.width = '200px';
                    const options = Array.isArray(selectedCondition.options) 
                        ? selectedCondition.options.map(o => ({ value: o, text: o }))
                        : Object.entries(selectedCondition.options).map(([val, txt]) => ({ value: val, text: txt }));
                    
                    options.forEach(opt => valueInput.add(new Option(opt.text, opt.value)));

                } else {
                    valueInput = document.createElement('input');
                    valueInput.type = selectedCondition.inputType;
                    valueInput.style.width = '194px';
                }
                valueInput.className = 'rule-value';
                if (existingCondition.value) {
                    valueInput.value = existingCondition.value;
                }
                valueWrapper.appendChild(valueInput);
            }

            // --- EVENT LISTENERS ---
            addBtn.addEventListener('click', () => addRuleRow());

            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-rule-btn')) {
                    e.target.closest('.rule-row').remove();
                }
            });

            form.addEventListener('submit', function() {
                const conditions = [];
                container.querySelectorAll('.rule-row').forEach(row => {
                    conditions.push({
                        field: row.querySelector('.rule-field').value,
                        operator: row.querySelector('.rule-operator').value,
                        value: row.querySelector('.rule-value').value
                    });
                });
                hiddenInput.value = JSON.stringify(conditions);
            });

            init();
        });
        </script>
        <?php
    }

    public function save_metabox_data($post_id) {
        if (!isset($_POST['canna_achievement_metabox_nonce']) || !wp_verify_nonce($_POST['canna_achievement_metabox_nonce'], 'canna_save_achievement_metabox_data')) {
            return;
        }
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
            return;
        }
        if (!current_user_can('edit_post', $post_id)) {
            return;
        }
        
        // --- THIS IS THE FIX ---
        // We now get the JSON from our hidden input, which is populated by the JavaScript.
        // We also no longer save `achievement_key` or `is_active` as they are not in the new form.
        // These can be moved to their own dedicated metaboxes if needed.
        update_post_meta($post_id, 'points_reward', isset($_POST['points_reward']) ? absint($_POST['points_reward']) : 0);
        update_post_meta($post_id, 'rarity', isset($_POST['rarity']) ? sanitize_text_field($_POST['rarity']) : 'common');
        update_post_meta($post_id, 'trigger_event', isset($_POST['trigger_event']) ? sanitize_text_field($_POST['trigger_event']) : '');
        update_post_meta($post_id, 'trigger_count', isset($_POST['trigger_count']) ? absint($_POST['trigger_count']) : 1);

        if (isset($_POST['conditions'])) {
            $conditions_json = wp_unslash($_POST['conditions']);
            // Basic JSON validation before saving
            if (json_decode($conditions_json) !== null) {
                update_post_meta($post_id, 'conditions', $conditions_json);
            }
        }
    }
}
</file>

<file path="includes/CannaRewards/Admin/AdminMenu.php">
<?php
namespace CannaRewards\Admin;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Handles the Brand Settings admin menu page.
 */
class AdminMenu {

    const PARENT_SLUG = 'canna_rewards_settings';

    public static function init() {
        add_action('admin_menu', [self::class, 'add_admin_menu']);
        add_action('admin_init', [self::class, 'settings_init']);
        add_action('admin_post_canna_generate_codes', [self::class, 'handle_code_generation']);
    }

    public static function add_admin_menu() {
        add_menu_page(
            'Brand Settings',
            'Brand Settings',
            'manage_options',
            self::PARENT_SLUG,
            [self::class, 'settings_page_html'],
            'dashicons-store',
            20
        );
        add_submenu_page(
            self::PARENT_SLUG,
            'Brand Settings',
            'Brand Settings',
            'manage_options',
            self::PARENT_SLUG, // Points back to the parent page render function
            [self::class, 'settings_page_html']
        );
        add_submenu_page(
            self::PARENT_SLUG,
            'QR Code Generator',
            'QR Code Generator',
            'manage_options',
            'canna_qr_generator',
            [self::class, 'qr_generator_page_html']
        );
    }

    public static function settings_init() {
        register_setting('canna_rewards_group', 'canna_rewards_options');
        
        // General Section
        add_settings_section('canna_settings_section_general', 'General Brand Configuration', null, self::PARENT_SLUG);
        add_settings_field('frontend_url', 'PWA Frontend URL', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_general', ['id' => 'frontend_url', 'type' => 'url', 'description' => 'The base URL of your PWA for password resets and QR code links.']);
        add_settings_field('support_email', 'Support Email Address', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_general', ['id' => 'support_email', 'type' => 'email', 'description' => 'Email for all support form submissions.']);
        add_settings_field('welcome_reward_product', 'First Scan Reward Product', [self::class, 'field_select_product_callback'], self::PARENT_SLUG, 'canna_settings_section_general', ['id' => 'welcome_reward_product', 'description' => "Select the product offered for a user's first scan."]);
        add_settings_field('referral_signup_gift', 'Referral Sign-up Gift', [self::class, 'field_select_product_callback'], self::PARENT_SLUG, 'canna_settings_section_general', ['id' => 'referral_signup_gift', 'description' => 'Select the gift for new users who sign up via referral.']);
        add_settings_field('referral_banner_text', 'Referral Banner Text', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_general', ['id' => 'referral_banner_text', 'type' => 'text', 'description' => 'e.g., "üéÅ Earn More By Inviting Your Friends"']);
        
        // Brand Personality Section
        add_settings_section('canna_settings_section_personality', 'Brand Personality Engine', [self::class, 'personality_section_callback'], self::PARENT_SLUG);
        add_settings_field('points_name', 'Name for "Points"', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_personality', ['id' => 'points_name', 'type' => 'text', 'placeholder' => 'Points', 'description' => 'What do you call your loyalty currency? e.g., Buds, Tokens, Karma.']);
        add_settings_field('rank_name', 'Name for "Rank"', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_personality', ['id' => 'rank_name', 'type' => 'text', 'placeholder' => 'Rank', 'description' => 'What do you call your loyalty tiers? e.g., Status, Level, Tier.']);
        add_settings_field('welcome_header', 'Welcome Header Text', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_personality', ['id' => 'welcome_header', 'type' => 'text', 'placeholder' => 'Welcome, {firstName}', 'description' => 'Personalize the dashboard greeting. Use {firstName} as a placeholder.']);
        add_settings_field('scan_cta', 'Scan Button CTA', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_personality', ['id' => 'scan_cta', 'type' => 'text', 'placeholder' => 'Scan Product', 'description' => 'The primary call-to-action text on the scan button.']);
        
        // Advanced Theming Section
        add_settings_section('canna_settings_section_theme', 'Advanced Theming (Shadcn)', [self::class, 'theme_section_callback'], self::PARENT_SLUG);
        add_settings_field('theme_primary_font', 'Primary Font (Google Fonts)', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_theme', ['id' => 'theme_primary_font', 'type' => 'text', 'description' => 'e.g., "Inter", "Montserrat", "Roboto Mono"']);
        add_settings_field('theme_radius', 'Border Radius', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_theme', ['id' => 'theme_radius', 'type' => 'text', 'description' => 'Base corner radius for elements. e.g., "0.5rem", "1rem"']);
        add_settings_field('theme_background', 'Background (Light)', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_theme', ['id' => 'theme_background', 'type' => 'text', 'description' => 'HSL format: 0 0% 100%']);
        add_settings_field('theme_foreground', 'Foreground (Light)', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_theme', ['id' => 'theme_foreground', 'type' => 'text', 'description' => 'HSL format: 222.2 84% 4.9%']);
        add_settings_field('theme_card', 'Card (Light)', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_theme', ['id' => 'theme_card', 'type' => 'text', 'description' => 'HSL format: 0 0% 100%']);
        add_settings_field('theme_primary', 'Primary (Light)', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_theme', ['id' => 'theme_primary', 'type' => 'text', 'description' => 'HSL format: 222.2 47.4% 11.2%']);
        add_settings_field('theme_primary_foreground', 'Primary Foreground (Light)', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_theme', ['id' => 'theme_primary_foreground', 'type' => 'text', 'description' => 'HSL format: 210 40% 98%']);
        add_settings_field('theme_secondary', 'Secondary (Light)', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_theme', ['id' => 'theme_secondary', 'type' => 'text', 'description' => 'HSL format: 210 40% 96.1%']);
        add_settings_field('theme_destructive', 'Destructive (Light)', [self::class, 'field_html_callback'], self::PARENT_SLUG, 'canna_settings_section_theme', ['id' => 'theme_destructive', 'type' => 'text', 'description' => 'HSL format: 0 84.2% 60.2%']);
    }

    public static function personality_section_callback() {
        echo '<p>Define the core language and feel of your rewards program to match your brand\'s voice.</p>';
    }
    
    public static function theme_section_callback() {
        echo '<p>Control the PWA\'s visual appearance. Use HSL values (e.g., "222.2 47.4% 11.2%") for colors, as defined in <code>globals.css</code>. Leave fields blank to use the PWA\'s default styling.</p>';
    }

    public static function field_html_callback($args) {
        $options = get_option('canna_rewards_options');
        $value = $options[$args['id']] ?? '';
        printf(
            '<input type="%s" id="%s" name="canna_rewards_options[%s]" value="%s" class="regular-text" placeholder="%s" /><p class="description">%s</p>',
            esc_attr($args['type']),
            esc_attr($args['id']),
            esc_attr($args['id']),
            esc_attr($value),
            esc_attr($args['placeholder'] ?? ''),
            esc_html($args['description'] ?? '')
        );
    }

    public static function field_select_product_callback($args) {
        if (!function_exists('wc_get_products')) {
            echo '<p>WooCommerce is not active.</p>';
            return;
        }
        $options = get_option('canna_rewards_options');
        $value = $options[$args['id']] ?? '';
        $products = wc_get_products(['status' => 'publish', 'limit' => -1]);
        echo '<select id="' . esc_attr($args['id']) . '" name="canna_rewards_options[' . esc_attr($args['id']) . ']">';
        echo '<option value="">-- Select a Reward --</option>';
        foreach ($products as $product) {
            printf(
                '<option value="%s"%s>%s</option>',
                esc_attr($product->get_id()),
                selected($value, $product->get_id(), false),
                esc_html($product->get_name())
            );
        }
        echo '</select>';
        echo '<p class="description">' . esc_html($args['description']) . '</p>';
    }

    public static function settings_page_html() {
        if (!current_user_can('manage_options')) {
            return;
        }
        ?>
        <div class="wrap">
            <h1><?php echo esc_html(get_admin_page_title()); ?></h1>
            <form action="options.php" method="post">
                <?php
                settings_fields('canna_rewards_group');
                do_settings_sections(self::PARENT_SLUG);
                submit_button('Save Settings');
                ?>
            </form>
        </div>
        <?php
    }

    public static function qr_generator_page_html() {
        if (!current_user_can('manage_options')) {
            return;
        }
        if (!function_exists('wc_get_products')) {
            echo '<div class="wrap"><h1>QR Code Generator</h1><p>WooCommerce must be active to use this feature.</p></div>';
            return;
        }
        $products = wc_get_products(['status' => 'publish', 'limit' => -1]);
        ?>
        <div class="wrap">
            <h1><?php echo esc_html(get_admin_page_title()); ?></h1>
            <p>Generate a batch of unique QR codes for a specific product. A CSV file will be downloaded containing the codes and the full URLs for printing.</p>
            <form action="<?php echo esc_url(admin_url('admin-post.php')); ?>" method="post">
                <input type="hidden" name="action" value="canna_generate_codes">
                <?php wp_nonce_field('canna_generate_codes_nonce', '_wpnonce'); ?>
                <table class="form-table">
                    <tbody>
                        <tr>
                            <th scope="row"><label for="product_id">Select Product</label></th>
                            <td>
                                <select id="product_id" name="product_id" required>
                                    <option value="">‚Äî Select a Product ‚Äî</option>
                                    <?php foreach ($products as $product) : ?>
                                        <option value="<?php echo esc_attr($product->get_id()); ?>">
                                            <?php echo esc_html($product->get_name()); ?> (SKU: <?php echo esc_html($product->get_sku()); ?>)
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                                <p class="description">Choose the product these codes will be associated with.</p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="quantity">Quantity to Generate</label></th>
                            <td>
                                <input name="quantity" type="number" id="quantity" value="100" class="short-text" required min="1" max="10000" />
                                <p class="description">How many unique codes to generate (max 10,000 per batch).</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <?php submit_button('Generate Codes and Download CSV'); ?>
            </form>
        </div>
        <?php
    }

    public static function handle_code_generation() {
        if (!current_user_can('manage_options') || !isset($_POST['_wpnonce']) || !wp_verify_nonce($_POST['_wpnonce'], 'canna_generate_codes_nonce')) {
            wp_die('You are not authorized to perform this action.');
        }

        global $wpdb;
        $product_id = isset($_POST['product_id']) ? absint($_POST['product_id']) : 0;
        $quantity = isset($_POST['quantity']) ? absint($_POST['quantity']) : 0;

        if ($quantity <= 0 || $quantity > 10000 || $product_id <= 0) {
            wp_die('Invalid input. Please check quantity and product selection.');
        }

        $product = wc_get_product($product_id);
        if (!$product) {
            wp_die('Invalid product selected.');
        }

        $sku = $product->get_sku() ?: 'NOSKU';
        $batch_id = uniqid('batch_' . sanitize_key($sku) . '_');
        $table_name = $wpdb->prefix . 'canna_reward_codes';

        $options = get_option('canna_rewards_options', []);
        $frontend_url = !empty($options['frontend_url']) ? rtrim($options['frontend_url'], '/') : home_url();
        if (empty($frontend_url)) {
            wp_die('PWA Frontend URL is not set in Brand Settings. Please configure it before generating codes.');
        }

        header('Content-Type: text/csv');
        header('Content-Disposition: attachment; filename="cannarewards-codes-' . $batch_id . '.csv"');
        $output = fopen('php://output', 'w');
        fputcsv($output, ['unique_code', 'full_url']);

        for ($i = 0; $i < $quantity; $i++) {
            $unique_part = bin2hex(random_bytes(8));
            $new_code = strtoupper($sku) . '-' . $unique_part;
            
            $wpdb->insert($table_name, [
                'code' => $new_code,
                'sku' => $sku,
                'batch_id' => $batch_id,
                'is_used' => 0
            ]);
            
            $full_url = $frontend_url . '/claim?code=' . urlencode($new_code);
            fputcsv($output, [$new_code, $full_url]);
        }
        
        fclose($output);
        exit;
    }
}
</file>

<file path="includes/CannaRewards/Api/CatalogController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Catalog Service Controller (V2)
 * Acts as a secure proxy to WooCommerce product data.
 */
class CatalogController {

    /**
     * Callback for GET /v2/catalog/products
     * Fetches a list of all reward products.
     *
     * @param WP_REST_Request $request The incoming API request.
     * @return WP_REST_Response|WP_Error The API response.
     */
    public function get_products( WP_REST_Request $request ) {
        if ( ! function_exists('wc_get_products') ) {
            return new WP_Error( 'woocommerce_inactive', 'WooCommerce is not active.', [ 'status' => 503 ] );
        }

        $products = wc_get_products([
            'status' => 'publish',
            'limit'  => -1, // Retrieve all products
        ]);

        $formatted_products = [];
        foreach ( $products as $product ) {
            // Only include products that can be redeemed (i.e., have a points_cost).
            $points_cost = $product->get_meta('points_cost');
            if ( ! empty($points_cost) ) {
                $formatted_products[] = $this->format_product_for_api($product);
            }
        }

        return new WP_REST_Response( $formatted_products, 200 );
    }

    /**
     * Callback for GET /v2/catalog/products/{id}
     * Fetches a single reward product and adds eligibility context for the current user.
     *
     * @param WP_REST_Request $request The incoming API request.
     * @return WP_REST_Response|WP_Error The API response.
     */
    public function get_product( WP_REST_Request $request ) {
        $product_id = (int) $request->get_param('id');
        if ( empty($product_id) ) {
            return new WP_Error( 'bad_request', 'Product ID is required.', [ 'status' => 400 ] );
        }

        $product = wc_get_product($product_id);
        if ( ! $product ) {
            return new WP_Error( 'not_found', 'Product not found.', [ 'status' => 404 ] );
        }

        $formatted_product = $this->format_product_for_api($product);

        $user_id = get_current_user_id();
        $is_eligible_for_free_claim = false;

        if ($user_id > 0) {
            $options = get_option('canna_rewards_options', []);
            $welcome_reward_id = (int) ($options['welcome_reward_product'] ?? 0);
            $referral_gift_id = (int) ($options['referral_signup_gift'] ?? 0);

            if ($product_id === $welcome_reward_id || $product_id === $referral_gift_id) {
                global $wpdb;
                $log_table = $wpdb->prefix . 'canna_user_action_log';
                $scan_count = (int) $wpdb->get_var($wpdb->prepare(
                    "SELECT COUNT(log_id) FROM {$log_table} WHERE user_id = %d AND action_type = 'scan'",
                    $user_id
                ));
                
                // --- THIS IS THE FIX ---
                // The user is eligible if their scan count is 1 (from the scan they just made) or 0.
                // Changing from `=== 0` to `<= 1` makes this consistent with the redemption handler.
                if ($scan_count <= 1) {
                    $is_eligible_for_free_claim = true;
                }
            }
        }
        $formatted_product['is_eligible_for_free_claim'] = $is_eligible_for_free_claim;

        return new WP_REST_Response( $formatted_product, 200 );
    }

    /**
     * A helper function to consistently format product data for the API response.
     * This ensures the frontend receives data in the exact structure it expects.
     *
     * @param \WC_Product $product The WooCommerce product object.
     * @return array The formatted product data.
     */
    private function format_product_for_api( $product ): array {
        $image_id = $product->get_image_id();
        $image_url = $image_id ? wp_get_attachment_image_url($image_id, 'woocommerce_thumbnail') : wc_placeholder_img_src();

        return [
            'id'          => $product->get_id(),
            'name'        => $product->get_name(),
            'description' => $product->get_description(),
            'images'      => [
                ['src' => $image_url]
            ],
            'meta_data'   => [
                [
                    'key'   => 'points_cost',
                    'value' => $product->get_meta('points_cost'),
                ],
                [
                    'key'   => '_required_rank',
                    'value' => $product->get_meta('_required_rank'),
                ],
            ],
        ];
    }
}
</file>

<file path="includes/CannaRewards/Api/HistoryController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use CannaRewards\Services\ActionLogService;
use Exception;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * History Service Controller (V2)
 */
class HistoryController {
    private $action_log_service;

    public function __construct(ActionLogService $action_log_service) {
        $this->action_log_service = $action_log_service;
    }

    /**
     * Callback for GET /v2/users/me/history.
     */
    public function get_history( WP_REST_Request $request ) {
        $user_id = get_current_user_id();
        $limit   = (int) $request->get_param('limit') ?: 50;

        try {
            $history_data = $this->action_log_service->get_user_points_history( $user_id, $limit );
            return ApiResponse::success(['history' => $history_data]);
        } catch ( Exception $e ) {
            return ApiResponse::error('Could not retrieve user history.', 'history_error', 500);
        }
    }
}
</file>

<file path="includes/CannaRewards/Api/ProfileController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use CannaRewards\Services\UserService;
use CannaRewards\Commands\UpdateProfileCommand;
use Exception;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

class ProfileController {
    private $user_service;

    public function __construct(UserService $user_service) {
        $this->user_service = $user_service;
    }

    public function get_profile( WP_REST_Request $request ) {
        $user_id = get_current_user_id();
        $profile_data = $this->user_service->get_full_profile_data( $user_id );

        if ( empty( $profile_data ) ) {
            return ApiResponse::not_found('User profile not found.');
        }

        return ApiResponse::success(['profile' => $profile_data]);
    }

    public function update_profile( WP_REST_Request $request ) {
        $user_id = get_current_user_id();
        $data    = $request->get_json_params();

        if ( empty( $data ) ) {
            return ApiResponse::bad_request('No data provided for update.');
        }

        try {
            $command = new UpdateProfileCommand($user_id, $data);
            $this->user_service->handle($command);
            
            // After updating, get the fresh profile data to return
            $updated_profile = $this->user_service->get_full_profile_data( $user_id );
            return ApiResponse::success(['profile' => $updated_profile]);
        } catch ( Exception $e ) {
            return ApiResponse::error($e->getMessage(), 'update_failed', 500);
        }
    }
}
</file>

<file path="includes/CannaRewards/Api/ReferralController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use CannaRewards\Services\ReferralService;
use Exception;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Referral Controller (V2)
 * Handles fetching referral data for the authenticated user.
 */
class ReferralController {
    private $referral_service;

    public function __construct(ReferralService $referral_service) {
        $this->referral_service = $referral_service;
    }

    /**
     * Callback for GET /v2/users/me/referrals
     */
    public function get_my_referrals( WP_REST_Request $request ) {
        try {
            $user_id = get_current_user_id();
            $referrals = $this->referral_service->get_user_referrals( $user_id );
            return ApiResponse::success(['referrals' => $referrals]);
        } catch (Exception $e) {
            return ApiResponse::error($e->getMessage(), 'referral_fetch_failed', 500);
        }
    }

    /**
     * Callback for POST /v2/users/me/referrals/nudge
     */
    public function get_nudge_options( WP_REST_Request $request ) {
        $user_id = get_current_user_id();
        $referee_email = sanitize_email( $request->get_param('email') );

        if ( empty($referee_email) ) {
            return ApiResponse::bad_request('Referee email is required.');
        }

        try {
            $options = $this->referral_service->get_nudge_options_for_referee( $user_id, $referee_email );
            return ApiResponse::success($options);
        } catch (Exception $e) {
            return ApiResponse::error($e->getMessage(), 'nudge_failed', 403);
        }
    }
}
</file>

<file path="includes/CannaRewards/Commands/CreateUserCommand.php">
<?php
namespace CannaRewards\Commands;

use CannaRewards\Domain\ValueObjects\EmailAddress;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Command DTO for creating a new user.
 * It now requires a validated EmailAddress Value Object.
 */
final class CreateUserCommand {
    public EmailAddress $email; // <-- Type-hinted to the Value Object
    public string $password;
    public string $first_name;
    public string $last_name;
    public string $phone;
    public bool $agreed_to_terms;
    public bool $agreed_to_marketing;
    public ?string $referral_code;

    public function __construct(
        EmailAddress $email, // <-- The constructor demands the Value Object
        string $password,
        string $first_name,
        string $last_name,
        string $phone,
        bool $agreed_to_terms,
        bool $agreed_to_marketing,
        ?string $referral_code
    ) {
        $this->email = $email;
        $this->password = $password;
        $this->first_name = $first_name;
        $this->last_name = $last_name;
        $this->phone = $phone;
        $this->agreed_to_terms = $agreed_to_terms;
        $this->agreed_to_marketing = $agreed_to_marketing;
        $this->referral_code = $referral_code;
    }
}
</file>

<file path="includes/CannaRewards/Commands/RegisterWithTokenCommand.php">
<?php
namespace CannaRewards\Commands;

use CannaRewards\Domain\ValueObjects\EmailAddress;

final class RegisterWithTokenCommand {
    public EmailAddress $email;
    public string $password;
    public string $first_name;
    public string $last_name;
    public string $phone;
    public bool $agreed_to_terms;
    public bool $agreed_to_marketing;
    public ?string $referral_code;
    public string $registration_token;

    public function __construct(
        EmailAddress $email,
        string $password,
        string $first_name,
        string $last_name,
        string $phone,
        bool $agreed_to_terms,
        bool $agreed_to_marketing,
        ?string $referral_code,
        string $registration_token
    ) {
        $this->email = $email;
        $this->password = $password;
        $this->first_name = $first_name;
        $this->last_name = $last_name;
        $this->phone = $phone;
        $this->agreed_to_terms = $agreed_to_terms;
        $this->agreed_to_marketing = $agreed_to_marketing;
        $this->referral_code = $referral_code;
        $this->registration_token = $registration_token;
    }
}
</file>

<file path="includes/CannaRewards/Includes/DB.php">
<?php
namespace CannaRewards\Includes;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Handles database-related functionality, like table creation on activation.
 */
class DB {

    /**
     * Plugin activation hook. Creates/Updates custom database tables.
     */
    public static function activate() {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');

        // Table for reward codes
        $table_name = $wpdb->prefix . 'canna_reward_codes';
        $sql = "CREATE TABLE $table_name (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            code varchar(100) NOT NULL,
            sku varchar(100) DEFAULT '' NOT NULL,
            batch_id varchar(255) DEFAULT '' NOT NULL,
            is_used tinyint(1) DEFAULT 0 NOT NULL,
            user_id bigint(20) unsigned,
            claimed_at datetime,
            PRIMARY KEY  (id),
            UNIQUE KEY code (code)
        ) $charset_collate;";
        dbDelta($sql);

        // Table for achievements
        $achievements_table_name = $wpdb->prefix . 'canna_achievements';
        $achievements_sql = "CREATE TABLE `{$achievements_table_name}` (
            `achievement_key` varchar(100) NOT NULL,
            `type` varchar(50) NOT NULL DEFAULT '' COMMENT 'Categorization for UI filtering',
            `title` varchar(255) NOT NULL,
            `description` text NOT NULL,
            `points_reward` int(11) DEFAULT 0 NOT NULL,
            `rarity` varchar(50) DEFAULT 'common' NOT NULL,
            `icon_url` varchar(255) DEFAULT '' NOT NULL,
            `is_active` tinyint(1) DEFAULT 1 NOT NULL,
            `trigger_event` varchar(100) NOT NULL DEFAULT '' COMMENT 'e.g., product_scanned',
            `trigger_count` int(11) NOT NULL DEFAULT 1,
            `conditions` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL COMMENT 'JSON-encoded array of conditions',
            PRIMARY KEY  (`achievement_key`),
            KEY `is_active` (`is_active`),
            KEY `trigger_event` (`trigger_event`)
        ) {$charset_collate};";
        dbDelta($achievements_sql);

        // Table for user unlocked achievements
        $user_achievements_table_name = $wpdb->prefix . 'canna_user_achievements';
        $user_achievements_sql = "CREATE TABLE `{$user_achievements_table_name}` (
            `id` bigint(20) NOT NULL AUTO_INCREMENT,
            `user_id` bigint(20) unsigned NOT NULL,
            `achievement_key` varchar(100) NOT NULL,
            `unlocked_at` datetime NOT NULL,
            PRIMARY KEY  (`id`),
            UNIQUE KEY `user_achievement` (`user_id`, `achievement_key`)
        ) {$charset_collate};";
        dbDelta($user_achievements_sql);

        // Table for user action log
        $action_log_table_name = $wpdb->prefix . 'canna_user_action_log';
        $action_log_sql = "CREATE TABLE `{$action_log_table_name}` (
            `log_id` bigint(20) NOT NULL AUTO_INCREMENT,
            `user_id` bigint(20) unsigned NOT NULL,
            `action_type` varchar(50) NOT NULL,
            `object_id` bigint(20) unsigned DEFAULT 0,
            `meta_data` longtext,
            `created_at` datetime NOT NULL,
            PRIMARY KEY (`log_id`),
            KEY `user_action` (`user_id`, `action_type`)
        ) {$charset_collate};";
        dbDelta($action_log_sql);
    }
}
</file>

<file path="includes/CannaRewards/Includes/Event.php">
<?php
namespace CannaRewards\Includes;
class Event {
    private static $listeners = [];
    public static function listen( string $event_name, callable $callback, int $priority = 10 ) {
        self::$listeners[ $event_name ][ $priority ][] = $callback;
    }
    public static function broadcast( string $event_name, array $payload = [] ) {
        $listeners_for_event = self::$listeners[ $event_name ] ?? [];
        if ( empty( $listeners_for_event ) ) return;
        ksort( $listeners_for_event );
        foreach ( $listeners_for_event as $priority_group ) {
            foreach ( $priority_group as $callback ) {
                call_user_func( $callback, $payload, $event_name );
            }
        }
    }
}
</file>

<file path="includes/CannaRewards/Repositories/UserRepository.php">
<?php
namespace CannaRewards\Repositories;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * User Repository
 *
 * Handles all data access logic for users. This is the single source of truth
 * for fetching and persisting user data, abstracting away the underlying
 * WordPress user and usermeta table implementation.
 */
class UserRepository {
    
    /**
     * Gets the current points balance for a given user.
     */
    public function getPointsBalance(int $user_id): int {
        $balance = get_user_meta($user_id, '_canna_points_balance', true);
        return empty($balance) ? 0 : (int) $balance;
    }

    /**
     * Gets the total lifetime points accumulated by a user.
     */
    public function getLifetimePoints(int $user_id): int {
        $lifetime_points = get_user_meta($user_id, '_canna_lifetime_points', true);
        return empty($lifetime_points) ? 0 : (int) $lifetime_points;
    }

    /**
     * Gets the current rank key for a user.
     */
    public function getCurrentRankKey(int $user_id): string {
        $rank_key = get_user_meta($user_id, '_canna_current_rank_key', true);
        return empty($rank_key) ? 'member' : $rank_key;
    }
    
    /**
     * Gets the user's referral code.
     */
    public function getReferralCode(int $user_id): ?string {
        $code = get_user_meta($user_id, '_canna_referral_code', true);
        return empty($code) ? null : $code;
    }

    /**
     * Finds the user ID of the referrer given a referral code.
     */
    public function findUserIdByReferralCode(string $referral_code): ?int {
        $users = get_users([
            'meta_key'   => '_canna_referral_code',
            'meta_value' => sanitize_text_field($referral_code),
            'number'     => 1,
            'fields'     => 'ID',
        ]);
        return !empty($users) ? (int) $users[0] : null;
    }

    /**
     * Gets the ID of the user who referred the given user.
     */
    public function getReferringUserId(int $user_id): ?int {
        $referrer_id = get_user_meta($user_id, '_canna_referred_by_user_id', true);
        return !empty($referrer_id) ? (int) $referrer_id : null;
    }

    /**
     * Persists all points and rank data for a user.
     */
    public function savePointsAndRank(int $user_id, int $new_balance, int $new_lifetime_points, string $new_rank_key): void {
        update_user_meta($user_id, '_canna_points_balance', $new_balance);
        update_user_meta($user_id, '_canna_lifetime_points', $new_lifetime_points);
        update_user_meta($user_id, '_canna_current_rank_key', $new_rank_key);
    }
    
    /**
     * Persists a user's referral code.
     */
    public function saveReferralCode(int $user_id, string $code): void {
        update_user_meta($user_id, '_canna_referral_code', $code);
    }
    
    /**
     * Links a new user to the user who referred them.
     */
    public function setReferredBy(int $new_user_id, int $referrer_user_id): void {
        update_user_meta($new_user_id, '_canna_referred_by_user_id', $referrer_user_id);
    }
    
    /**
     * Updates a user's shipping address.
     */
    public function saveShippingAddress(int $user_id, array $shipping_details): void {
        if (empty($shipping_details) || !isset($shipping_details['firstName'])) {
            return;
        }

        // --- THIS IS THE FIX ---
        // Map the incoming camelCase keys to the correct snake_case meta keys.
        $meta_map = [
            'firstName' => 'shipping_first_name',
            'lastName'  => 'shipping_last_name',
            'address1'  => 'shipping_address_1',
            'city'      => 'shipping_city',
            'state'     => 'shipping_state',
            'zip'       => 'shipping_postcode',
        ];

        foreach ($meta_map as $frontend_key => $meta_key) {
            if (isset($shipping_details[$frontend_key])) {
                update_user_meta($user_id, $meta_key, sanitize_text_field($shipping_details[$frontend_key]));
            }
        }
        
        // Also save to the primary billing fields for better WC compatibility
        update_user_meta( $user_id, 'billing_first_name', sanitize_text_field( $shipping_details['firstName'] ?? '' ) );
        update_user_meta( $user_id, 'billing_last_name', sanitize_text_field( $shipping_details['lastName'] ?? '' ) );
    }
}
</file>

<file path="includes/CannaRewards/Services/ActionLogService.php">
<?php
namespace CannaRewards\Services;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Action Log Service
 */
class ActionLogService {
    /**
     * Records a user action to the log.
     */
    public function record(int $user_id, string $action_type, int $object_id = 0, array $meta_data = []): bool {
        global $wpdb;
        $table_name = $wpdb->prefix . 'canna_user_action_log';

        $result = $wpdb->insert(
            $table_name,
            [
                'user_id'     => $user_id,
                'action_type' => $action_type,
                'object_id'   => $object_id,
                'meta_data'   => wp_json_encode($meta_data),
                'created_at'  => current_time('mysql', 1),
            ]
        );
        return (bool) $result;
    }

    /**
     * Fetches a user's point transaction history.
     */
    public function get_user_points_history( int $user_id, int $limit = 50 ): array {
        global $wpdb;
        $table_name = $wpdb->prefix . 'canna_user_action_log';

        // --- START FIX ---
        // Changed the query to filter by specific action types instead of a JSON key.
        // This is more reliable and explicit.
        $results = $wpdb->get_results(
            $wpdb->prepare(
                "SELECT meta_data, created_at FROM {$table_name} 
                 WHERE user_id = %d 
                 AND action_type IN ('points_granted', 'redeem')
                 ORDER BY log_id DESC 
                 LIMIT %d",
                $user_id,
                $limit
            )
        );
        // --- END FIX ---

        $history = [];
        if ( empty( $results ) ) {
            return $history;
        }

        foreach ( $results as $row ) {
            $meta = json_decode( $row->meta_data, true );
            if ( ! is_array( $meta ) || ! isset( $meta['points_change'] ) || ! isset( $meta['description'] ) ) {
                continue;
            }
            $history[] = [
                'points'      => (int) $meta['points_change'],
                'description' => $meta['description'],
                'log_date'    => $row->created_at,
            ];
        }
        return $history;
    }
}
</file>

<file path="includes/CannaRewards/Services/CDPService.php">
<?php
namespace CannaRewards\Services;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * CDP Service
 *
 * The single, centralized gateway for all communication to the Customer Data Platform.
 */
class CDPService {

    private RankService $rankService;

    public function __construct(RankService $rankService) {
        $this->rankService = $rankService;
    }

    /**
     * The single entry point for tracking all events.
     */
    public function track( int $user_id, string $event_name, array $properties = [] ) {
        $user_snapshot = $this->build_user_snapshot( $user_id );
        $final_payload = array_merge( $properties, [ 'user_snapshot' => $user_snapshot ] );

        error_log( '[CDP TRACK]: ' . $event_name . ' | ' . wp_json_encode( $final_payload ) );
    }

    /**
     * Builds the rich user snapshot object that is attached to every event.
     */
    private function build_user_snapshot( int $user_id ): array {
        $user = get_userdata( $user_id );
        if ( ! $user ) {
            return [];
        }

        $rank_dto = $this->rankService->getUserRank($user_id);

        return [
            'identity' => [
                'user_id'    => $user_id,
                'email'      => $user->user_email,
                'first_name' => $user->first_name,
                'created_at' => $user->user_registered . 'Z',
            ],
            'economy'  => [
                'points_balance' => get_user_points_balance( $user_id ),
                'lifetime_points' => get_user_lifetime_points( $user_id ),
            ],
            'status' => [
                'rank_key' => $rank_dto->key,
                'rank_name' => $rank_dto->name,
            ]
        ];
    }
}
</file>

<file path="includes/CannaRewards/Services/ConfigService.php">
<?php
namespace CannaRewards\Services;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Config Service
 *
 * Gathers all static, global configuration data for the application.
 */
class ConfigService {

    private RankService $rankService;

    public function __construct(RankService $rankService) {
        $this->rankService = $rankService;
    }

    /**
     * Assembles the complete application configuration object.
     */
    public function get_app_config(): array {
        return [
            'settings'         => $this->get_settings(),
            'all_ranks'        => $this->get_all_ranks(),
            'all_achievements' => $this->get_all_achievements(),
        ];
    }

    /**
     * Fetches and formats the brand personality and theme settings.
     */
    private function get_settings(): array {
        $options = get_option( 'canna_rewards_options', [] );
        return [
            'brand_personality' => [
                'points_name'    => $options['points_name'] ?? 'Points',
                'rank_name'      => $options['rank_name'] ?? 'Rank',
                'welcome_header' => $options['welcome_header'] ?? 'Welcome, {firstName}',
                'scan_cta'       => $options['scan_cta'] ?? 'Scan Product',
            ],
            'theme'             => [
                'primaryFont'        => $options['theme_primary_font'] ?? null,
                'radius'             => $options['theme_radius'] ?? null,
                'background'         => $options['theme_background'] ?? null,
                'foreground'         => $options['theme_foreground'] ?? null,
                'card'               => $options['theme_card'] ?? null,
                'primary'            => $options['theme_primary'] ?? null,
                'primary-foreground' => $options['theme_primary_foreground'] ?? null,
                'secondary'          => $options['theme_secondary'] ?? null,
                'destructive'        => $options['theme_destructive'] ?? null,
            ],
        ];
    }

    /**
     * Fetches and formats all defined Rank CPTs.
     */
    private function get_all_ranks(): array {
        $rank_dtos = $this->rankService->getRankStructure();
        // The API contract expects an associative array, keyed by the rank's machine-name.
        $ranks_for_api = [];
        foreach ($rank_dtos as $dto) {
            // The OpenAPI spec benefits property is currently not in the RankDTO,
            // so we will have to add it or fetch it here. For now, we will add a placeholder.
            // This is something we can clean up in the next refactor.
            $rank_array = (array) $dto;
            $rank_array['benefits'] = []; // Add placeholder for benefits
            $ranks_for_api[$dto->key] = $rank_array;
        }
        return $ranks_for_api;
    }

    /**
     * Fetches and formats all defined Achievement CPTs from our custom table.
     */
    private function get_all_achievements(): array {
        $cached_achievements = get_transient('canna_all_achievements_v2');
        if ( is_array($cached_achievements) ) {
            return $cached_achievements;
        }

        global $wpdb;
        $table_name = $wpdb->prefix . 'canna_achievements';
        $results    = $wpdb->get_results( "SELECT achievement_key, title, description, rarity, icon_url FROM `{$table_name}` WHERE is_active = 1" );

        $achievements = [];
        if ( ! empty($results) ) {
            foreach ( $results as $ach ) {
                $achievements[ $ach->achievement_key ] = [
                    'title'       => $ach->title,
                    'description' => $ach->description,
                    'rarity'      => $ach->rarity,
                    'icon_url'    => $ach->icon_url,
                ];
            }
        }
        
        set_transient('canna_all_achievements_v2', $achievements, 12 * HOUR_IN_SECONDS);
        return $achievements;
    }
}
</file>

<file path="includes/CannaRewards/Services/RulesEngineService.php">
<?php
namespace CannaRewards\Services;

final class RulesEngineService {
    /**
     * Evaluates a set of conditions against a context payload.
     *
     * @param array $conditions The array of rule conditions from the database.
     * @param array $context The live event data payload.
     * @return bool True if all conditions pass, false otherwise.
     */
    public function evaluate(array $conditions, array $context): bool {
        if (empty($conditions)) {
            return true; // No conditions means the rule always passes.
        }

        foreach ($conditions as $condition) {
            if (!$this->evaluateSingleCondition($condition, $context)) {
                return false; // If any single condition fails, the whole set fails.
            }
        }

        return true; // All conditions passed.
    }

    private function evaluateSingleCondition(array $condition, array $context): bool {
        if (!isset($condition['field'], $condition['operator'], $condition['value'])) {
            return false; // Malformed condition.
        }

        $actualValue = $this->getValueFromContext($condition['field'], $context);
        $expectedValue = $condition['value'];

        // If the data doesn't exist in the context, the condition automatically fails.
        if ($actualValue === null) {
            return false;
        }

        switch ($condition['operator']) {
            case 'is':
                return $actualValue == $expectedValue;
            case 'is_not':
                return $actualValue != $expectedValue;
            case '>':
                return (float)$actualValue > (float)$expectedValue;
            case '<':
                return (float)$actualValue < (float)$expectedValue;
            default:
                return false;
        }
    }

    /**
     * Safely gets a nested value from the context array using dot notation.
     * Example: 'user_snapshot.economy.points_balance'
     */
    private function getValueFromContext(string $fieldPath, array $context) {
        $keys = explode('.', $fieldPath);
        $value = $context;

        foreach ($keys as $key) {
            if (!is_array($value) || !array_key_exists($key, $value)) {
                return null;
            }
            $value = $value[$key];
        }

        return $value;
    }
}
</file>

<file path="includes/container.php">
<?php

use CannaRewards\Commands;
use CannaRewards\Policies;
use CannaRewards\Services;
use Psr\Container\ContainerInterface;
use DI\ContainerBuilder;

$containerBuilder = new ContainerBuilder();
$containerBuilder->useAutowiring(true);

$containerBuilder->addDefinitions([
    'economy_policy_map' => [
        Commands\RedeemRewardCommand::class => [ Policies\UserCanAffordRedemptionPolicy::class, ],
    ],
    'user_policy_map' => [
        Commands\CreateUserCommand::class => [ Policies\UserAccountIsUniquePolicy::class, ],
    ],
    
    // Explicitly define how to build the Command Buses with their policy maps
    Services\UserService::class => DI\autowire()
        ->constructorParameter('policy_map', DI\get('user_policy_map')),
    
    Services\EconomyService::class => DI\autowire()
        ->constructorParameter('policy_map', DI\get('economy_policy_map')),

    // Allow the container to inject itself
    ContainerInterface::class => function (ContainerInterface $c) {
        return $c;
    },
]);

// STAGE 1: Build the container with all the service definitions.
$container = $containerBuilder->build();

// --- THIS IS THE FIX ---
// STAGE 2: Get the services and manually configure them.
// This is the correct way to handle circular dependencies and handler registration.
// We are NO LONGER trying to get the handlers from the container itself.
$userService = $container->get(Services\UserService::class);
$economyService = $container->get(Services\EconomyService::class);
$referralService = $container->get(Services\ReferralService::class);

// Resolve circular dependencies
$userService->set_referral_service($referralService);
$economyService->set_user_service($userService);

// Manually build and register the handlers. The container will autowire their dependencies.
$userService->registerCommandHandler(
    Commands\CreateUserCommand::class, 
    $container->get(Commands\CreateUserCommandHandler::class)
);
$userService->registerCommandHandler(
    Commands\UpdateProfileCommand::class, 
    $container->get(Commands\UpdateProfileCommandHandler::class)
);
$userService->registerCommandHandler(
    Commands\RegisterWithTokenCommand::class, 
    $container->get(Commands\RegisterWithTokenCommandHandler::class)
);

$economyService->registerCommandHandler(
    Commands\GrantPointsCommand::class, 
    $container->get(Commands\GrantPointsCommandHandler::class)
);
$economyService->registerCommandHandler(
    Commands\RedeemRewardCommand::class, 
    $container->get(Commands\RedeemRewardCommandHandler::class)
);
$economyService->registerCommandHandler(
    Commands\ProcessProductScanCommand::class, 
    $container->get(Commands\ProcessProductScanCommandHandler::class)
);
$economyService->registerCommandHandler(
    Commands\ProcessUnauthenticatedClaimCommand::class, 
    $container->get(Commands\ProcessUnauthenticatedClaimCommandHandler::class)
);

// Manually resolve the final circular dependency for the GrantPointsCommandHandler
$container->get(Commands\GrantPointsCommandHandler::class)->setEconomyService($economyService);

// Return the fully built and configured container.
return $container;
</file>

<file path="tests-api/economy.spec.js">
import { test, expect } from '@playwright/test';
import { validateApiContract } from './api-contract-validator.js';

// Helper function to create a new user with a UNIQUE email.
async function createTestUser(request) {
  const uniqueEmail = `economy_user_${Date.now()}@example.com`;
  
  // First, ensure the user doesn't exist from a previous failed run.
  await request.post('/wp-content/plugins/cannarewards-engine/tests-api/test-helper.php', {
      form: { action: 'reset_user_by_email', email: uniqueEmail }
  });

  const registerResponse = await request.post('/wp-json/rewards/v2/auth/register', {
    data: {
      email: uniqueEmail,
      password: 'test-password',
      firstName: 'Economy',
      lastName: 'Test',
      agreedToTerms: true,
    }
  });
  expect(registerResponse.ok(), `Failed to register user ${uniqueEmail}. Body: ${await registerResponse.text()}`).toBeTruthy();

  const loginResponse = await request.post('/wp-json/jwt-auth/v1/token', {
    data: {
      username: uniqueEmail,
      password: 'test-password',
    }
  });
  expect(loginResponse.ok()).toBeTruthy();
  const loginData = await loginResponse.json();
  return { authToken: loginData.token, userEmail: uniqueEmail };
}

// A helper to reset our test user's state before each test.
async function resetTestUserState(request, email) {
    const resetResponse = await request.post('/wp-content/plugins/cannarewards-engine/tests-api/test-helper.php', {
        form: {
            action: 'reset_user_by_email',
            email: email,
            points_balance: 10000 // Give them 10k points to start
        }
    });
    expect(resetResponse.ok()).toBeTruthy();
}


test.describe('Economy & Redemption Flow', () => {

  let authToken;
  let testUserEmail;

  // Before all tests in this file, create our unique test user once.
  test.beforeAll(async ({ request }) => {
    const { authToken: token, userEmail } = await createTestUser(request);
    authToken = token;
    testUserEmail = userEmail;
  });

  // Before each individual test, reset the user's state.
  test.beforeEach(async ({ request }) => {
    await resetTestUserState(request, testUserEmail);
  });

  test('A user with sufficient points can redeem a product', async ({ request }) => {

    const productIdToRedeem = 204; // IMPORTANT: Product ID 2 MUST exist and have points_cost=5000

    const redeemResponse = await request.post('/wp-json/rewards/v2/actions/redeem', {
      headers: {
        'Authorization': `Bearer ${authToken}`,
      },
      data: {
        productId: productIdToRedeem,
        shippingDetails: {
          firstName: "Test",
          lastName: "User",
          address1: "123 Main St",
          city: "Anytown",
          state: "CA",
          zip: "90210"
        }
      }
    });
    
    // --- CONTRACT ENFORCEMENT ---
    await expect(async () => await validateApiContract(redeemResponse, '/actions/redeem', 'post')).toPass();

    expect(redeemResponse.ok()).toBeTruthy();
    const redeemData = await redeemResponse.json();
    expect(redeemData.data.success).toBe(true);
    expect(redeemData.data.new_points_balance).toBe(5000);

    const sessionResponse = await request.get('/wp-json/rewards/v2/users/me/session', {
        headers: {
            'Authorization': `Bearer ${authToken}`,
        }
    });

    // --- CONTRACT ENFORCEMENT ---
    await expect(async () => await validateApiContract(sessionResponse, '/users/me/session', 'get')).toPass();

    const sessionData = await sessionResponse.json();
    expect(sessionData.data.points_balance).toBe(5000);
  });

});
</file>

<file path="tests-api/onboarding.spec.js">
import { test, expect } from '@playwright/test';
import { validateApiContract } from './api-contract-validator.js';

const TEST_CODE = 'PWT-001-C03C2878'; // Replace with a real code from your CSV

test.describe('User Onboarding Golden Path', () => {

  test.beforeEach(async ({ request }) => {
    const reset = await request.post('/wp-content/plugins/cannarewards-engine/tests-api/test-helper.php', {
      form: { action: 'reset_qr_code', code: TEST_CODE }
    });
    expect(reset.ok()).toBeTruthy();
  });

  test('A new user scanning a valid code should register and receive a welcome gift', async ({ request }) => {
    
    const unauthenticatedClaim = await request.post('/wp-json/rewards/v2/unauthenticated/claim', {
      data: { code: TEST_CODE }
    });
    await expect(async () => await validateApiContract(unauthenticatedClaim, '/unauthenticated/claim', 'post')).toPass();
    expect(unauthenticatedClaim.ok(), `Unauthenticated claim failed. Body: ${await unauthenticatedClaim.text()}`).toBeTruthy();
    const claimData = await unauthenticatedClaim.json();
    expect(claimData.data.status).toBe('registration_required');

    const registrationToken = claimData.data.registration_token;

    const registration = await request.post('/wp-json/rewards/v2/auth/register-with-token', {
      data: {
        email: `goldenpath_${Date.now()}@example.com`,
        password: 'a-secure-password',
        firstName: 'Golden',
        lastName: 'Path',
        agreedToTerms: true,
        registration_token: registrationToken
      }
    });
    await expect(async () => await validateApiContract(registration, '/auth/register-with-token', 'post')).toPass();
    expect(registration.ok(), `Registration with token failed. Body: ${await registration.text()}`).toBeTruthy();
    const registrationData = await registration.json();
    const authToken = registrationData.token;

    const ordersResponse = await request.get('/wp-json/rewards/v2/users/me/orders', {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    await expect(async () => await validateApiContract(ordersResponse, '/users/me/orders', 'get')).toPass();
    expect(ordersResponse.ok(), `Fetching orders failed. Body: ${await ordersResponse.text()}`).toBeTruthy();
    const ordersData = await ordersResponse.json();
    
    expect(ordersData.data.orders).toHaveLength(1);
    expect(ordersData.data.orders[0].items).toContain('Playwright Welcome Gift');
  });
});
</file>

<file path="includes/CannaRewards/Api/ClaimController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use CannaRewards\Services\EconomyService;
use CannaRewards\Commands\ProcessProductScanCommand;
use CannaRewards\Commands\ProcessUnauthenticatedClaimCommand;
use Exception;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

class ClaimController {
    private $economy_service;

    public function __construct(EconomyService $economy_service) {
        $this->economy_service = $economy_service;
    }

    public function process_claim( WP_REST_Request $request ) {
        $user_id       = get_current_user_id();
        $code_to_claim = sanitize_text_field( $request->get_param( 'code' ) );

        if ( empty( $code_to_claim ) ) {
            return ApiResponse::bad_request('A code must be provided.');
        }

        try {
            $command = new ProcessProductScanCommand($user_id, $code_to_claim);
            $result = $this->economy_service->handle($command);
            return ApiResponse::success($result);
        } catch ( Exception $e ) {
            return ApiResponse::error($e->getMessage(), 'claim_failed', 409);
        }
    }

    public function process_unauthenticated_claim( WP_REST_Request $request ) {
        $code_to_claim = sanitize_text_field( $request->get_param( 'code' ) );

        if ( empty( $code_to_claim ) ) {
            return ApiResponse::bad_request('A code must be provided.');
        }

        try {
            $command = new ProcessUnauthenticatedClaimCommand($code_to_claim);
            $result = $this->economy_service->handle($command);
            return ApiResponse::success($result);
        } catch ( Exception $e ) {
            return ApiResponse::error($e->getMessage(), 'unauthenticated_claim_failed', 409);
        }
    }
}
</file>

<file path="includes/CannaRewards/Api/OrdersController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use CannaRewards\Repositories\OrderRepository;
use Exception;

class OrdersController {
    private $order_repository;

    public function __construct(OrderRepository $order_repository) {
        $this->order_repository = $order_repository;
    }

    public function get_orders(WP_REST_Request $request) {
        $user_id = get_current_user_id();
        $limit   = (int) $request->get_param('limit') ?: 50;

        try {
            $order_dtos = $this->order_repository->getUserOrders($user_id, $limit);
            // Cast each DTO in the array to an array for the final response.
            $orders_data = array_map(fn($dto) => (array) $dto, $order_dtos);
            return ApiResponse::success(['orders' => $orders_data]);
        } catch (Exception $e) {
            return ApiResponse::error('Could not retrieve user orders.', 'orders_error', 500);
        }
    }
}
</file>

<file path="includes/CannaRewards/Api/RedeemController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use CannaRewards\Services\EconomyService;
use CannaRewards\Commands\RedeemRewardCommand;
use Exception;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

class RedeemController {
    private $economy_service;

    public function __construct(EconomyService $economy_service) {
        $this->economy_service = $economy_service;
    }

    public function process_redemption( WP_REST_Request $request ) {
        $user_id          = get_current_user_id();
        $product_id       = (int) $request->get_param('productId');
        $shipping_details = (array) $request->get_param('shippingDetails');

        if ( empty( $product_id ) ) {
            return ApiResponse::bad_request('Product ID is required.');
        }

        try {
            $command = new RedeemRewardCommand($user_id, $product_id, $shipping_details);
            $result = $this->economy_service->handle($command);
            return ApiResponse::success($result);
        } catch ( Exception $e ) {
            $status_code = 400; // Default
            if ($e->getCode() === 1) $status_code = 402; // Insufficient points
            if ($e->getCode() === 2) $status_code = 403; // Rank required
            return ApiResponse::error($e->getMessage(), 'redemption_failed', $status_code);
        }
    }
}
</file>

<file path="includes/CannaRewards/Commands/CreateUserCommandHandler.php">
<?php
namespace CannaRewards\Commands;

use CannaRewards\Commands\CreateUserCommand;
use CannaRewards\Repositories\UserRepository;
use CannaRewards\Services\ReferralService;
use CannaRewards\Services\CDPService;
use CannaRewards\Includes\Event;
use Exception;

final class CreateUserCommandHandler {
    private $user_repository;
    private $cdp_service;
    private $referral_service;

    public function __construct(UserRepository $user_repository, CDPService $cdp_service) {
        $this->user_repository = $user_repository;
        $this->cdp_service = $cdp_service;
    }

    public function setReferralService(ReferralService $referral_service): void {
        $this->referral_service = $referral_service;
    }

    public function handle(CreateUserCommand $command): array {
        if (!get_option('users_can_register')) {
            throw new Exception('User registration is currently disabled.', 503);
        }

        // --- THE PAYOFF ---
        // The Policy Layer now handles the email existence check.
        // This handler is now dumber, cleaner, and only knows the "happy path".
        $email_string = (string) $command->email;

        if (empty($command->password)) {
            throw new Exception('A password is required.', 400);
        }

        $user_id = wp_insert_user([
            'user_login' => $email_string,
            'user_email' => $email_string,
            'user_pass'  => $command->password,
            'first_name' => $command->first_name,
            'last_name'  => $command->last_name,
            'role' => 'subscriber'
        ]);

        if (is_wp_error($user_id)) {
            throw new Exception($user_id->get_error_message(), 500);
        }

        update_user_meta($user_id, 'phone_number', $command->phone);
        update_user_meta($user_id, 'marketing_consent', $command->agreed_to_marketing);
        update_user_meta($user_id, '_age_gate_confirmed_at', current_time('mysql', 1));
        $this->user_repository->savePointsAndRank($user_id, 0, 0, 'member');
        
        $this->referral_service->generate_code_for_new_user($user_id, $command->first_name);

        if ($command->referral_code) {
            $this->referral_service->process_new_user_referral($user_id, $command->referral_code);
        }
        
        Event::broadcast('user_created', ['user_id' => $user_id, 'referral_code' => $command->referral_code]);
        $this->cdp_service->track($user_id, 'user_created', ['signup_method' => 'password', 'referral_code_used' => $command->referral_code]);

        return ['success' => true, 'message' => 'Registration successful.', 'userId' => $user_id];
    }
}
</file>

<file path="includes/CannaRewards/Commands/ProcessProductScanCommandHandler.php">
<?php
namespace CannaRewards\Commands;

use CannaRewards\Repositories\RewardCodeRepository;
use CannaRewards\Repositories\ProductRepository;
use CannaRewards\Repositories\ActionLogRepository;
use CannaRewards\Repositories\UserRepository; // <-- IMPORT THE CORRECT REPOSITORY
use CannaRewards\Services\EconomyService;
use CannaRewards\Services\ActionLogService;
use CannaRewards\Services\EventFactory;
use CannaRewards\Includes\Event;
use Exception;

final class ProcessProductScanCommandHandler {
    private RewardCodeRepository $reward_code_repository;
    private ProductRepository $product_repository;
    private EconomyService $economy_service;
    private ActionLogService $action_log_service;
    private ActionLogRepository $action_log_repository;
    private RedeemRewardCommandHandler $redeem_reward_handler;
    private EventFactory $event_factory;
    private UserRepository $userRepository; // <-- ADD THE PROPERTY

    public function __construct(
        RewardCodeRepository $reward_code_repository,
        ProductRepository $product_repository,
        EconomyService $economy_service,
        ActionLogService $action_log_service,
        ActionLogRepository $action_log_repository,
        RedeemRewardCommandHandler $redeem_reward_handler,
        EventFactory $event_factory,
        UserRepository $userRepository // <-- ADD THE DEPENDENCY
    ) {
        $this->reward_code_repository = $reward_code_repository;
        $this->product_repository = $product_repository;
        $this->economy_service = $economy_service;
        $this->action_log_service = $action_log_service;
        $this->action_log_repository = $action_log_repository;
        $this->redeem_reward_handler = $redeem_reward_handler;
        $this->event_factory = $event_factory;
        $this->userRepository = $userRepository; // <-- ASSIGN THE PROPERTY
    }

    public function handle(ProcessProductScanCommand $command): array {
        $code_data = $this->reward_code_repository->findValidCode($command->code);
        if (!$code_data) {
            throw new Exception('This code is invalid or has already been used.');
        }

        $product_id = $this->product_repository->findIdBySku($code_data->sku);
        if (!$product_id) {
            throw new Exception('The product associated with this code could not be found.');
        }
        
        $scan_count = $this->action_log_repository->countUserActions($command->user_id, 'scan');
        $is_first_scan = ($scan_count === 0);

        $this->action_log_service->record($command->user_id, 'scan', $product_id);
        
        $product_post = get_post($product_id);
        $product_name = $product_post->post_title;
        $points_result = [];
        $message = '';

        if ($is_first_scan) {
            $options = get_option('canna_rewards_options', []);
            $welcome_reward_id = !empty($options['welcome_reward_product']) ? (int) $options['welcome_reward_product'] : 0;
            
            if ($welcome_reward_id > 0) {
                $redeem_command = new RedeemRewardCommand($command->user_id, $welcome_reward_id, []);
                $this->redeem_reward_handler->handle($redeem_command);
            }

            // --- THIS IS THE FIX ---
            // The method is on UserRepository, which we now have.
            $points_result['points_earned'] = 0;
            $points_result['new_points_balance'] = $this->userRepository->getPointsBalance($command->user_id);
            $message = 'Welcome! You have unlocked a special reward for your first scan.';

        } else {
            $base_points = $this->product_repository->getPointsAward($product_id);
            $grant_command = new GrantPointsCommand(
                $command->user_id,
                $base_points,
                'Product Scan: ' . $product_name
            );
            $points_result = $this->economy_service->handle($grant_command);
            $message = sprintf('You earned %d points for scanning %s!', $points_result['points_earned'], $product_name);
        }

        $this->reward_code_repository->markCodeAsUsed($code_data->id, $command->user_id);

        try {
            $event_payload = $this->event_factory->createProductScannedEvent($command->user_id, $product_post, $is_first_scan);
            Event::broadcast('product_scanned', $event_payload);
        } catch (Exception $e) {
            error_log("FATAL: Could not generate valid 'product_scanned' event: " . $e->getMessage());
        }

        return [
            'success'            => true,
            'message'            => $message,
            'points_earned'      => $points_result['points_earned'],
            'new_points_balance' => $points_result['new_points_balance'],
            'triggered_events'   => [],
        ];
    }
}
</file>

<file path="includes/CannaRewards/Commands/RedeemRewardCommandHandler.php">
<?php
namespace CannaRewards\Commands;

use CannaRewards\Commands\RedeemRewardCommand;
use CannaRewards\Repositories\ProductRepository;
use CannaRewards\Repositories\UserRepository;
use CannaRewards\Repositories\OrderRepository;
use CannaRewards\Repositories\ActionLogRepository;
use CannaRewards\Services\ActionLogService;
use CannaRewards\Services\ContextBuilderService;
use CannaRewards\Includes\Event;
use Exception;

final class RedeemRewardCommandHandler {
    private $product_repository;
    private $user_repository;
    private $order_repository;
    private $action_log_repository;
    private $action_log_service;
    private $context_builder;

    public function __construct(
        ProductRepository $product_repository,
        UserRepository $user_repository,
        OrderRepository $order_repository,
        ActionLogService $action_log_service,
        ContextBuilderService $context_builder,
        ActionLogRepository $action_log_repository
    ) {
        $this->product_repository = $product_repository;
        $this->user_repository = $user_repository;
        $this->order_repository = $order_repository;
        $this->action_log_repository = $action_log_repository;
        $this->action_log_service = $action_log_service;
        $this->context_builder = $context_builder;
    }

    public function handle(RedeemRewardCommand $command): array {
        $user_id = $command->user_id;
        $product_id = $command->product_id;
        
        // --- THE PAYOFF ---
        // The policy layer has already guaranteed the user can afford this.
        // This handler now only contains the "happy path" logic.

        $points_cost = $this->product_repository->getPointsCost($product_id);
        $current_balance = $this->user_repository->getPointsBalance($user_id);
        $new_balance = $current_balance - $points_cost;

        $user_data = get_userdata($user_id);
        $address_for_order = [];
        if (!empty($command->shipping_details)) {
            $address_for_order = [
                'first_name' => $command->shipping_details['firstName'] ?? '',
                'last_name'  => $command->shipping_details['lastName'] ?? '',
                'address_1'  => $command->shipping_details['address1'] ?? '',
                'city'       => $command->shipping_details['city'] ?? '',
                'state'      => $command->shipping_details['state'] ?? '',
                'postcode'   => $command->shipping_details['zip'] ?? '',
                'country'    => 'US',
                'email'      => $user_data->user_email,
            ];
        }

        $order_id = $this->order_repository->createFromRedemption($user_id, $product_id, $address_for_order);
        if (!$order_id) throw new Exception('Failed to create order for redemption.');

        if (!empty($command->shipping_details)) {
            $this->user_repository->saveShippingAddress($user_id, $command->shipping_details);
        }

        $this->user_repository->savePointsAndRank($user_id, $new_balance, $this->user_repository->getLifetimePoints($user_id), $this->user_repository->getCurrentRankKey($user_id));

        $product = get_post($product_id);
        $product_name = $product ? $product->post_title : 'reward';
        $log_meta_data = ['description' => 'Redeemed: ' . $product_name, 'points_change' => -$points_cost, 'new_balance' => $new_balance, 'order_id' => $order_id];
        $this->action_log_service->record($user_id, 'redeem', $product_id, $log_meta_data);
        
        $full_context = $this->context_builder->build_event_context($user_id, $product);
        Event::broadcast('reward_redeemed', $full_context);
        
        return ['success' => true, 'order_id' => $order_id, 'new_points_balance' => $new_balance];
    }
}
</file>

<file path="includes/CannaRewards/Commands/RegisterWithTokenCommandHandler.php">
<?php
namespace CannaRewards\Commands;

use CannaRewards\Services\EconomyService;
use CannaRewards\Services\UserService;
use Exception;

final class RegisterWithTokenCommandHandler {
    private $user_service;
    private $economy_service;

    public function __construct(UserService $user_service, EconomyService $economy_service) {
        $this->user_service = $user_service;
        $this->economy_service = $economy_service;
    }

    /**
     * @throws Exception on failure
     */
    public function handle(RegisterWithTokenCommand $command): array {
        $claim_code = get_transient('reg_token_' . $command->registration_token);
        if (false === $claim_code) {
            throw new Exception('Invalid or expired registration token.', 403);
        }

        // 1. Create the user first.
        // --- FIX: We now receive a trusted EmailAddress object from the command ---
        $create_user_command = new \CannaRewards\Commands\CreateUserCommand(
            $command->email, // This is now an EmailAddress object
            $command->password,
            $command->first_name,
            $command->last_name,
            $command->phone,
            $command->agreed_to_terms,
            $command->agreed_to_marketing,
            $command->referral_code
        );

        $create_user_result = $this->user_service->handle($create_user_command);
        $new_user_id = $create_user_result['userId'];

        if (!$new_user_id) {
            throw new Exception('Failed to create user during token registration.');
        }

        // 2. Now that the user exists, dispatch the standard ProcessProductScanCommand.
        $process_scan_command = new ProcessProductScanCommand($new_user_id, $claim_code);
        $this->economy_service->handle($process_scan_command);

        // 3. All successful, delete the token so it can't be reused.
        delete_transient('reg_token_' . $command->registration_token);
        
        // 4. Log the user in by calling the official JWT endpoint internally.
        $request = new \WP_REST_Request('POST', '/jwt-auth/v1/token');
        $request->set_body_params([
            'username' => (string) $command->email, // Cast to string for the JWT plugin
            'password' => $command->password
        ]);

        $response = rest_do_request($request);

        if ($response->is_error()) {
            throw new Exception('Could not generate authentication token after registration.');
        }

        return $response->get_data();
    }
}
</file>

<file path="includes/CannaRewards/Includes/Integrations.php">
<?php
namespace CannaRewards\Includes;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Handles third-party integrations, CORS headers, and compatibility fixes.
 */
class Integrations {

    public static function init() {
        // This is the most important part. We add the headers directly.
        add_action('init', [self::class, 'handle_preflight_and_cors_headers']);
        
        // Remove default WordPress handlers to avoid conflicts.
        remove_filter('rest_pre_serve_request', 'rest_send_cors_headers');
        add_filter('rest_pre_serve_request', function ($value) {
            self::add_cors_headers();
            return $value;
        });
    }

    /**
     * Central function to add all required CORS headers.
     */
    private static function add_cors_headers() {
        $origin = get_http_origin();
        $allowed_origins = ['http://localhost:3000', 'https://cannarewards-pwa.vercel.app'];

        if ($origin && in_array($origin, $allowed_origins, true)) {
            header('Access-Control-Allow-Origin: ' . esc_url_raw($origin));
            header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
            header('Access-Control-Allow-Headers: Content-Type, Authorization, X-WP-Nonce');
            header('Access-Control-Allow-Credentials: true');
        }
    }

    /**
     * Handles the pre-flight OPTIONS request aggressively.
     */
    public static function handle_preflight_and_cors_headers() {
        // Always add headers on every request.
        self::add_cors_headers();

        // If it's a pre-flight request, kill the script after sending headers.
        if ('OPTIONS' === $_SERVER['REQUEST_METHOD']) {
            status_header(204); // 204 No Content is appropriate for pre-flight
            exit();
        }
    }
}
</file>

<file path="includes/CannaRewards/Services/ContextBuilderService.php">
<?php
namespace CannaRewards\Services;

use WP_Post;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Context Builder Service
 */
class ContextBuilderService {

    private RankService $rankService;

    public function __construct(RankService $rankService) {
        $this->rankService = $rankService;
    }

    /**
     * Builds the complete, enriched context for a given event.
     */
    public function build_event_context( int $user_id, ?WP_Post $product_post = null ): array {
        return [
            'user_snapshot'    => $this->build_user_snapshot( $user_id ),
            'product_snapshot' => $product_post ? $this->build_product_snapshot( $product_post ) : null,
            'event_context'    => $this->build_event_context_snapshot(),
        ];
    }

    /**
     * Assembles the complete user_snapshot object according to the Data Taxonomy.
     */
    private function build_user_snapshot( int $user_id ): array {
        $user = get_userdata( $user_id );
        if ( ! $user ) {
            return [];
        }

        global $wpdb;
        $log_table = $wpdb->prefix . 'canna_user_action_log';
        $total_scans = (int) $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(log_id) FROM {$log_table} WHERE user_id = %d AND action_type = 'scan'",
            $user_id
        ));
        
        // --- THIS IS THE FIX ---
        // We now use the injected RankService instead of the dead global function.
        $rank_dto = $this->rankService->getUserRank($user_id);

        return [
            'identity' => [
                'user_id'    => $user_id,
                'email'      => $user->user_email,
                'first_name' => $user->first_name,
                'created_at' => $user->user_registered . 'Z',
            ],
            'economy'  => [
                'points_balance' => get_user_points_balance( $user_id ),
                'lifetime_points' => get_user_lifetime_points( $user_id ),
            ],
            'status' => [
                'rank_key' => $rank_dto->key,
                'rank_name' => $rank_dto->name,
            ],
            'engagement' => [
                'total_scans' => $total_scans
            ]
        ];
    }

    /**
     * Assembles the complete product_snapshot object from a post object.
     */
    private function build_product_snapshot( WP_Post $product_post ): array {
        $product = wc_get_product( $product_post->ID );
        if ( ! $product ) {
            return [];
        }

        return [
            'identity' => [
                'product_id'   => $product->get_id(),
                'sku'          => $product->get_sku(),
                'product_name' => $product->get_name(),
            ],
            'economy' => [
                'points_award' => (int) $product->get_meta('points_award'),
                'points_cost'  => (int) $product->get_meta('points_cost'),
            ],
            'taxonomy' => [
                'product_form' => 'Vape', // Placeholder
                'strain_type'  => 'Sativa', // Placeholder
            ],
        ];
    }

    /**
     * Assembles the event_context snapshot from server variables.
     */
    private function build_event_context_snapshot(): array {
        return [
            'time'     => [
                'timestamp_utc' => gmdate('Y-m-d\TH:i:s\Z'),
            ],
            'location' => [
                'ip_address' => $_SERVER['REMOTE_ADDR'] ?? '127.0.0.1',
            ],
            'device'   => [
                'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? 'unknown',
            ],
        ];
    }
}
</file>

<file path="package.json">
{
  "name": "cannarewards-engine",
  "version": "1.0.0",
  "private": true,
  "devDependencies": {
    "@playwright/test": "^1.41.2",
    "ajv": "^8.12.0",
    "ajv-formats": "^2.1.1",
    "js-yaml": "^4.1.0"
  },
  "scripts": {
    "test": "npx playwright test"
  }
}
</file>

<file path="includes/CannaRewards/Repositories/OrderRepository.php">
<?php
namespace CannaRewards\Repositories;

use CannaRewards\DTO\OrderDTO;
use Exception;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Order Repository
 */
class OrderRepository {
    
    public function createFromRedemption(int $user_id, int $product_id, array $shipping_details = []): ?int {
        if (!function_exists('wc_get_product') || !function_exists('wc_create_order')) {
            throw new Exception('WooCommerce functions not available in OrderRepository.');
        }

        $product = wc_get_product($product_id);
        if (!$product) {
            throw new Exception("Could not find product with ID {$product_id} for redemption.");
        }
        
        try {
            $order = wc_create_order(['customer_id' => $user_id]);
            
            if (is_wp_error($order)) {
                throw new Exception('wc_create_order() failed. WooCommerce said: ' . $order->get_error_message());
            }

            if (!empty($shipping_details)) {
                $order->set_address($shipping_details, 'shipping');
                $order->set_address($shipping_details, 'billing');
            }
            
            $order->add_product($product, 1);
            
            $order->set_shipping_total(0);
            $order->set_discount_total(0);
            $order->set_discount_tax(0);
            $order->set_cart_tax(0);
            $order->set_shipping_tax(0);
            $order->set_total(0);

            $order->update_meta_data('_is_canna_redemption', true);
            $order->update_status('processing', 'Redeemed with CannaRewards points.');
            
            $order_id = $order->save();

            if ($order_id === 0) {
                 throw new Exception('$order->save() returned 0, indicating a silent failure.');
            }

            return $order_id;

        } catch (Exception $e) {
            throw new Exception('Exception during order creation process: ' . $e->getMessage());
        }
    }

    /**
     * @return OrderDTO[]
     */
    public function getUserOrders(int $user_id, int $limit = 50): array {
        if (!function_exists('wc_get_orders')) {
            return [];
        }

        $orders = wc_get_orders([
            'customer_id' => $user_id,
            'limit'       => $limit,
            'orderby'     => 'date',
            'order'       => 'DESC',
            'meta_key'    => '_is_canna_redemption',
            'meta_value'  => true,
        ]);

        $formatted_orders = [];
        foreach ($orders as $order) {
            $items = [];
            $image_url = wc_placeholder_img_src();
            $line_items = $order->get_items();
            
            if (!empty($line_items)) {
                $first_item = reset($line_items);
                $product_id = $first_item->get_product_id();
                if ($product_id) {
                    $product = wc_get_product($product_id);
                    $image_id = $product ? $product->get_image_id() : 0;
                    if ($image_id) {
                        $image_url = wp_get_attachment_image_url($image_id, 'thumbnail');
                    }
                }
            }
            
            foreach ($line_items as $item) {
                $items[] = $item->get_name();
            }

            $dto = new OrderDTO();
            $dto->orderId = $order->get_id();
            $dto->date = $order->get_date_created()->date('Y-m-d');
            $dto->status = ucfirst($order->get_status());
            $dto->items = implode(', ', $items);
            $dto->imageUrl = $image_url;

            $formatted_orders[] = $dto;
        }

        return $formatted_orders;
    }
}
</file>

<file path="includes/CannaRewards/Services/ReferralService.php">
<?php
namespace CannaRewards\Services;

use CannaRewards\Includes\Event;
use CannaRewards\Repositories\UserRepository;
use CannaRewards\Repositories\ActionLogRepository;

class ReferralService {
    private CDPService $cdp_service;
    private UserRepository $user_repository;
    private ActionLogRepository $action_log_repository;

    public function __construct(
        CDPService $cdp_service,
        UserRepository $user_repository,
        ActionLogRepository $action_log_repository
    ) {
        $this->cdp_service = $cdp_service;
        $this->user_repository = $user_repository;
        $this->action_log_repository = $action_log_repository;
        
        Event::listen('product_scanned', [$this, 'handle_referral_conversion']);
    }

    public function process_new_user_referral(int $new_user_id, string $referral_code) {
        if (empty($new_user_id) || empty($referral_code)) {
            return;
        }

        $referrer_user_id = $this->user_repository->findUserIdByReferralCode($referral_code);

        if ($referrer_user_id) {
            $this->user_repository->setReferredBy($new_user_id, $referrer_user_id);
            $this->execute_triggers('referral_invitee_signed_up', $new_user_id, ['referrer_id' => $referrer_user_id]);
        }
    }

    public function handle_referral_conversion(array $payload) {
        $user_id = $payload['user_snapshot']['identity']['user_id'] ?? 0;
        if (empty($user_id)) { 
            return; 
        }

        if (1 === $this->action_log_repository->countUserActions($user_id, 'scan')) {
            $referrer_user_id = $this->user_repository->getReferringUserId($user_id);
            
            if ($referrer_user_id) {
                $this->execute_triggers('referral_converted', $referrer_user_id, ['invitee_id' => $user_id]);
            }
        }
    }
    
    private function execute_triggers(string $event_key, int $user_id, array $context = []) {
        $triggers_to_run = get_posts([
            'post_type'      => 'canna_trigger',
            'posts_per_page' => -1,
            'meta_key'       => 'event_key',
            'meta_value'     => $event_key,
        ]);

        if (empty($triggers_to_run)) {
            return;
        }

        foreach ($triggers_to_run as $trigger_post) {
            $action_type = get_post_meta($trigger_post->ID, 'action_type', true);
            $action_value = get_post_meta($trigger_post->ID, 'action_value', true);
            
            if ($action_type === 'grant_points') {
                $points_to_grant = (int) $action_value;
                if ($points_to_grant > 0) {
                    Event::broadcast('points_to_be_granted', [
                        'user_id'     => $user_id,
                        'points'      => $points_to_grant,
                        'description' => $trigger_post->post_title
                    ]);
                }
            }
        }

        $this->cdp_service->track($user_id, $event_key, $context);
    }
    
    public function generate_code_for_new_user(int $user_id, string $first_name = ''): string {
        $base_code_name = !empty($first_name) ? $first_name : 'USER';
        $base_code      = strtoupper(substr(preg_replace('/[^a-zA-Z0-9]/', '', $base_code_name), 0, 8));
        do {
            $unique_part = strtoupper(wp_generate_password(4, false, false));
            $new_code    = $base_code . $unique_part;
            $exists = $this->user_repository->findUserIdByReferralCode($new_code);
        } while (!is_null($exists));
        
        $this->user_repository->saveReferralCode($user_id, $new_code);
        return $new_code;
    }
    
    public function get_user_referrals(int $user_id): array { return []; }
    public function get_nudge_options_for_referee(int $user_id, string $email): array { return []; }
}
</file>

<file path="includes/CannaRewards/Api/AuthController.php">
<?php
namespace CannaRewards\Api;

use WP_REST_Request;
use CannaRewards\Services\UserService;
use CannaRewards\Commands\CreateUserCommand;
use CannaRewards\Commands\RegisterWithTokenCommand;
use CannaRewards\Domain\ValueObjects\EmailAddress;
use Exception;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

class AuthController {
    private $user_service;

    public function __construct(UserService $user_service) {
        $this->user_service = $user_service;
    }

    public function register_user( WP_REST_Request $request ) {
        try {
            $params = $request->get_json_params();

            $email_vo = new EmailAddress($params['email'] ?? '');

            $command = new CreateUserCommand(
                $email_vo,
                $params['password'] ?? '',
                sanitize_text_field($params['firstName'] ?? ''),
                sanitize_text_field($params['lastName'] ?? ''),
                sanitize_text_field($params['phone'] ?? ''),
                (bool) ($params['agreedToTerms'] ?? false),
                (bool) ($params['agreedToMarketing'] ?? false),
                sanitize_text_field($params['referralCode'] ?? null)
            );

            $result = $this->user_service->handle($command);
            return ApiResponse::success($result, 201);
        } catch ( Exception $e ) {
            return ApiResponse::error($e->getMessage(), 'registration_failed', $e->getCode() ?: 400);
        }
    }
    
    public function register_with_token( WP_REST_Request $request ) {
        try {
            $params = $request->get_json_params();

            $email_vo = new EmailAddress($params['email'] ?? '');
            
            $command = new RegisterWithTokenCommand(
                $email_vo, // <-- FIX: Pass the validated object, not a string
                $params['password'] ?? '',
                sanitize_text_field($params['firstName'] ?? ''),
                sanitize_text_field($params['lastName'] ?? ''),
                sanitize_text_field($params['phone'] ?? ''),
                (bool) ($params['agreedToTerms'] ?? false),
                (bool) ($params['agreedToMarketing'] ?? false),
                sanitize_text_field($params['referralCode'] ?? null),
                sanitize_text_field($params['registration_token'] ?? '')
            );

            $result = $this->user_service->handle($command);
            
            return new \WP_REST_Response($result, 200);

        } catch ( Exception $e ) {
            return ApiResponse::error($e->getMessage(), 'token_registration_failed', $e->getCode() ?: 400);
        }
    }

    public function login_user( WP_REST_Request $request ) {
        $params = $request->get_json_params();
        $email = $params['email'] ?? '';
        $password = $params['password'] ?? '';

        if ( empty( $email ) || empty( $password ) ) {
            return ApiResponse::bad_request('Email and password are required.');
        }

        $internal_request = new \WP_REST_Request('POST', '/jwt-auth/v1/token');
        $internal_request->set_body_params(['username' => $email, 'password' => $password]);
        $response = rest_do_request($internal_request);

        if ( $response->is_error() ) {
            return ApiResponse::forbidden('Invalid username or password.');
        }
        
        return new \WP_REST_Response( $response->get_data(), 200 );
    }

    public function request_password_reset(WP_REST_Request $request) {
        $params = $request->get_json_params();
        $email = sanitize_email($params['email'] ?? '');
        $success_response = new \WP_REST_Response(['success' => true, 'message' => 'If an account with that email exists, a reset link has been sent.'], 200);
        if (!is_email($email) || !email_exists($email)) {
            return $success_response;
        }
        $user = get_user_by('email', $email);
        $token = get_password_reset_key($user);
        if (is_wp_error($token)) {
            return ApiResponse::error('Could not generate reset token.', 'token_generation_failed', 500);
        }
        $options = get_option('canna_rewards_options');
        $base_url = !empty($options['frontend_url']) ? rtrim($options['frontend_url'], '/') : home_url();
        $reset_link = "$base_url/reset-password?token=$token&email=" . rawurlencode($email);
        wp_mail($email, 'Your Password Reset Request', "Click to reset: $reset_link \n\nThis link expires in 1 hour.");
        return $success_response;
    }

    public function perform_password_reset(WP_REST_Request $request) {
        $params = $request->get_json_params();
        $token = sanitize_text_field($params['token'] ?? '');
        $email = sanitize_email($params['email'] ?? '');
        $password = $params['password'] ?? '';
        
        $user = check_password_reset_key($token, $email);
        if (is_wp_error($user)) {
             return ApiResponse::error('Your password reset token is invalid or has expired.', 'invalid_token', 400);
        }

        reset_password($user, $password);
        
        return new \WP_REST_Response(['success' => true, 'message' => 'Password has been reset successfully. You can now log in.'], 200);
    }
}
</file>

<file path="includes/CannaRewards/Services/GamificationService.php">
<?php
namespace CannaRewards\Services;

use CannaRewards\Commands\GrantPointsCommand;
use CannaRewards\Includes\Event;
use CannaRewards\Repositories\AchievementRepository;
use CannaRewards\Repositories\ActionLogRepository;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

class GamificationService {
    private EconomyService $economy_service;
    private ActionLogService $action_log_service;
    private AchievementRepository $achievement_repository;
    private ActionLogRepository $action_log_repository;
    private RulesEngineService $rules_engine;

    public function __construct(
        EconomyService $economy_service,
        ActionLogService $action_log_service,
        AchievementRepository $achievement_repository,
        ActionLogRepository $action_log_repository,
        RulesEngineService $rules_engine
    ) {
        $this->economy_service = $economy_service;
        $this->action_log_service = $action_log_service;
        $this->achievement_repository = $achievement_repository;
        $this->action_log_repository = $action_log_repository;
        $this->rules_engine = $rules_engine;

        $events_to_listen_for = ['product_scanned', 'user_rank_changed', 'reward_redeemed'];
        foreach ($events_to_listen_for as $event_name) {
            Event::listen($event_name, [$this, 'handle_event']);
        }
    }

    public function handle_event(array $payload, string $event_name) {
        $user_id = $payload['user_snapshot']['identity']['user_id'] ?? 0;
        if (empty($user_id)) {
            return;
        }
        $this->check_and_process_event($user_id, $event_name, $payload);
    }

    private function check_and_process_event(int $user_id, string $event_name, array $context = []) {
        $achievements_to_check = $this->achievement_repository->findByTriggerEvent($event_name);
        $user_unlocked_keys = $this->achievement_repository->getUnlockedKeysForUser($user_id);

        foreach ($achievements_to_check as $achievement) {
            if (in_array($achievement->achievement_key, $user_unlocked_keys, true)) {
                continue;
            }

            if ($this->evaluate_conditions($achievement, $user_id, $context)) {
                $this->unlock_achievement($user_id, $achievement);
            }
        }
    }
    
    private function evaluate_conditions(object $achievement, int $user_id, array $context): bool {
        $action_count = $this->action_log_repository->countUserActions($user_id, $achievement->trigger_event);
        if ($action_count < (int) $achievement->trigger_count) {
            return false;
        }

        $json_conditions = json_decode($achievement->conditions ?: '[]', true);
        if (!is_array($json_conditions)) {
            error_log("CannaRewards: Malformed JSON condition for achievement key: {$achievement->achievement_key}");
            return false;
        }

        return $this->rules_engine->evaluate($json_conditions, $context);
    }

    private function unlock_achievement(int $user_id, object $achievement) {
        $this->achievement_repository->saveUnlockedAchievement($user_id, $achievement->achievement_key);
        
        $points_reward = (int) $achievement->points_reward;
        if ($points_reward > 0) {
            // --- THIS IS THE FIX ---
            // Dispatch a command instead of calling the insecure public method.
            $command = new GrantPointsCommand(
                $user_id,
                $points_reward,
                'Achievement Unlocked: ' . $achievement->title
            );
            $this->economy_service->handle($command);
        }

        $achievement_details = ['key' => $achievement->achievement_key, 'name' => $achievement->title, 'points_rewarded' => $points_reward];
        $this->action_log_service->record($user_id, 'achievement_unlocked', 0, $achievement_details);
    }
}
</file>

<file path="composer.json">
{
    "name": "cannarewards/engine",
    "description": "The all-in-one, self-reliant engine for the CannaRewards PWA.",
    "type": "wordpress-plugin",
    "license": "GPL-2.0-or-later",
    "require": {
        "php-di/php-di": "^7.0",
        "justinrainbow/json-schema": "^5.2"
    },
    "require-dev": {
        "wp-coding-standards/wpcs": "^3.0",
        "phpcompatibility/phpcompatibility-wp": "^2.1"
    },
    "autoload": {
        "psr-4": {
            "CannaRewards\\": "includes/CannaRewards/"
        },
        "files": [
            "includes/canna-core-functions.php"
        ]
    },
    "scripts": {
        "lint": "./vendor/bin/phpcs"
    },
    "config": {
        "allow-plugins": {
            "dealerdirect/phpcodesniffer-composer-installer": true
        }
    }
}
</file>

<file path="includes/canna-core-functions.php">
<?php
/**
 * Core Procedural Functions
 *
 * This file contains essential, non-class-based helper functions used throughout
 * the CannaRewards plugin. It includes functions for retrieving user data,
 * accessing the rank structure, and registering custom post types.
 *
 * @package CannaRewards
 */

// Exit if accessed directly.
if (!defined('WPINC')) {
    die;
}

/**
 * Gets the current points balance for a given user.
 *
 * @since 5.0.0
 *
 * @param int $user_id The ID of the user.
 * @return int The user's point balance, defaulting to 0.
 */
function get_user_points_balance($user_id) {
    $balance = get_user_meta($user_id, '_canna_points_balance', true);
    return empty($balance) ? 0 : (int) $balance;
}

/**
 * Gets the total lifetime points accumulated by a user.
 * This value is used to determine a user's rank.
 *
 * @since 5.0.0
 *
 * @param int $user_id The ID of the user.
 * @return int The user's lifetime points, defaulting to 0.
 */
function get_user_lifetime_points($user_id) {
    $lifetime_points = get_user_meta($user_id, '_canna_lifetime_points', true);
    return empty($lifetime_points) ? 0 : (int) $lifetime_points;
}

/**
 * @deprecated 2.1.0 Use CannaRewards\Services\RankService->getRankStructure() instead.
 */
function canna_get_rank_structure() {
    trigger_error('canna_get_rank_structure() is deprecated. Use RankService->getRankStructure() instead.', E_USER_DEPRECATED);
    // Return a default empty array to avoid breaking anything that might still call this.
    return [];
}

/**
 * @deprecated 2.1.0 Use CannaRewards\Services\RankService->getUserRank() instead.
 */
function get_user_current_rank($user_id) {
    trigger_error('get_user_current_rank() is deprecated. Use RankService->getUserRank() instead.', E_USER_DEPRECATED);
    // Return a default member rank to avoid breaking anything that might still call this.
    return ['key' => 'member', 'name' => 'Member'];
}


/**
 * Registers the 'canna_rank' Custom Post Type.
 * @since 5.0.0
 */
function canna_register_rank_post_type() {
    $labels = [ 'name' => _x('Ranks', 'Post Type General Name', 'canna-rewards'), /* ... other labels ... */ ];
    $args = [ 'label' => __('Rank', 'canna-rewards'), 'labels' => $labels, 'supports' => ['title', 'custom-fields'], 'hierarchical' => false, 'public' => false, 'show_ui' => true, 'show_in_menu' => 'canna_rewards_settings', 'menu_icon' => 'dashicons-star-filled', 'capability_type' => 'page' ];
    register_post_type('canna_rank', $args);
}

/**
 * Registers the 'canna_achievement' Custom Post Type.
 * @since 5.0.0
 */
function canna_register_achievement_post_type() {
    $labels = [ 'name' => _x('Achievements', 'Post Type General Name', 'canna-rewards'), /* ... other labels ... */ ];
    $args = [ 'label' => __('Achievement', 'canna-rewards'), 'labels' => $labels, 'supports' => ['title', 'editor', 'custom-fields'], 'hierarchical' => false, 'public' => false, 'show_ui' => true, 'show_in_menu' => 'canna_rewards_settings', 'menu_icon' => 'dashicons-awards', 'capability_type' => 'post' ];
    register_post_type('canna_achievement', $args);
}

/**
 * Synchronizes data from the 'canna_achievement' CPT to the 'canna_achievements' database table.
 * @since 5.0.0
 * @param int $post_id The ID of the post being saved.
 */
function canna_sync_achievement_cpt_to_table($post_id) {
    // ... (This function can be removed if the DB table is synced from the metabox save action directly)
}
// add_action('save_post_canna_achievement', 'canna_sync_achievement_cpt_to_table');

/**
 * Registers the 'canna_custom_field' Custom Post Type.
 * @since 2.0.0
 */
function canna_register_custom_field_post_type() {
    $labels = [ 'name' => _x('Custom Fields', 'Post Type General Name', 'canna-rewards'), /* ... other labels ... */ ];
    $args = [ 'label' => __('Custom Field', 'canna-rewards'), 'labels' => $labels, 'supports' => ['title'], 'hierarchical' => false, 'public' => false, 'show_ui' => true, 'show_in_menu' => 'canna_rewards_settings', 'capability_type' => 'page' ];
    register_post_type('canna_custom_field', $args);
}

/**
 * A helper function to invalidate the custom fields cache.
 * @since 2.0.0
 */
function canna_clear_custom_fields_cache() {
    delete_transient('canna_custom_fields_definition');
}

/**
 * Registers the 'canna_trigger' Custom Post Type.
 *
 * This CPT is the heart of the "If This, Then That" rules engine.
 * @since 2.0.0
 */
function canna_register_trigger_post_type() {
    $labels = [
        'name'          => _x('Triggers', 'Post Type General Name', 'canna-rewards'),
        'singular_name' => _x('Trigger', 'Post Type Singular Name', 'canna-rewards'),
        'menu_name'     => __('Triggers', 'canna-rewards'),
        'all_items'     => __('All Triggers', 'canna-rewards'),
        'add_new_item'  => __('Add New Trigger', 'canna-rewards'),
    ];
    $args = [
        'label'         => __('Trigger', 'canna-rewards'),
        'description'   => __('Defines automated actions based on user events.', 'canna-rewards'),
        'labels'        => $labels,
        'supports'      => ['title'],
        'hierarchical'  => false,
        'public'        => false,
        'show_ui'       => true,
        'show_in_menu'  => 'canna_rewards_settings',
        'capability_type' => 'page',
        'show_in_rest'  => false,
    ];
    register_post_type('canna_trigger', $args);
}

/**
 * A helper function to invalidate the triggers cache.
 * @since 2.0.0
 */
function canna_clear_triggers_cache() {
    delete_transient('canna_all_triggers');
}

/**
 * Retrieves all custom field definitions, with caching.
 * @since 2.1.0
 */
function canna_get_custom_fields_definitions(): array {
    $cached_fields = get_transient('canna_custom_fields_definition');
    if (is_array($cached_fields)) {
        return $cached_fields;
    }

    $fields = [];
    $args = [
        'post_type'      => 'canna_custom_field',
        'posts_per_page' => -1,
        'post_status'    => 'publish',
    ];
    $field_posts = get_posts($args);

    foreach ($field_posts as $post) {
        $options_raw = get_post_meta($post->ID, 'options', true);
        $fields[] = [
            'key'       => get_post_meta($post->ID, 'meta_key', true),
            'label'     => get_the_title($post->ID),
            'type'      => get_post_meta($post->ID, 'field_type', true),
            'options'   => !empty($options_raw) ? preg_split('/\\r\\n|\\r|\\n/', $options_raw) : [],
            'display'   => (array) get_post_meta($post->ID, 'display_location', true),
        ];
    }

    set_transient('canna_custom_fields_definition', $fields, 12 * HOUR_IN_SECONDS);
    return $fields;
}
</file>

<file path="includes/CannaRewards/CannaRewardsEngine.php">
<?php
namespace CannaRewards;

use CannaRewards\Admin\AdminMenu;
use CannaRewards\Admin\AchievementMetabox;
use CannaRewards\Admin\CustomFieldMetabox;
use CannaRewards\Admin\ProductMetabox;
use CannaRewards\Admin\TriggerMetabox;
use CannaRewards\Admin\UserProfile;
use CannaRewards\Api;
use CannaRewards\Services;
use CannaRewards\Includes\DB;
use CannaRewards\Includes\Integrations;
use Psr\Container\ContainerInterface;

final class CannaRewardsEngine {
    private static $instance;
    private ContainerInterface $container;

    public static function instance(ContainerInterface $container = null) {
        if (is_null(self::$instance)) {
            if (is_null($container)) {
                throw new \Exception("Container not provided to CannaRewardsEngine");
            }
            self::$instance = new self($container);
        }
        return self::$instance;
    }

    public function __construct(ContainerInterface $container) {
        $this->container = $container;
        add_action('plugins_loaded', [$this, 'init']);
    }
    
    public function init() {
        Integrations::init();

        if (!class_exists('WooCommerce')) {
            add_action('admin_notices', function() {
                echo '<div class="error"><p><strong>CannaRewards Engine Warning:</strong> WooCommerce is not installed or active.</p></div>';
            });
            return;
        }

        $this->init_wordpress_components();
        // "Wake up" the GamificationService to ensure its event listeners are registered.
        $this->container->get(Services\GamificationService::class);
    }
    
    private function init_wordpress_components() {
        AdminMenu::init();
        UserProfile::init();
        ProductMetabox::init();
        new AchievementMetabox();
        new CustomFieldMetabox();
        new TriggerMetabox();
        
        add_action('init', 'canna_register_rank_post_type', 0);
        add_action('init', 'canna_register_achievement_post_type', 0);
        add_action('init', 'canna_register_custom_field_post_type', 0);
        add_action('init', 'canna_register_trigger_post_type', 0);
        
        add_action('rest_api_init', [$this, 'register_rest_routes']);
        
        register_activation_hook(CANNA_PLUGIN_FILE, [DB::class, 'activate']);
    }

    public function register_rest_routes() {
        $v2_namespace = 'rewards/v2';
        $v1_namespace = 'rewards/v1';
        $permission_public = '__return_true';
        $permission_auth   = fn() => is_user_logged_in();
        $permission_admin  = function(\WP_REST_Request $request) {
            $nonce = $request->get_header('X-WP-Nonce');
            return wp_verify_nonce($nonce, 'wp_rest') && current_user_can('manage_options');
        };

        // --- ADMIN-ONLY ENDPOINTS ---
        register_rest_route($v2_namespace, '/rules/conditions', [
            'methods' => 'GET',
            'callback' => [$this->container->get(Api\RulesController::class), 'get_conditions'],
            'permission_callback' => $permission_admin
        ]);

        // --- PUBLIC & AUTHENTICATED ENDPOINTS ---
        register_rest_route($v2_namespace, '/unauthenticated/welcome-reward-preview', ['methods' => 'GET', 'callback' => [$this->container->get(Api\UnauthenticatedDataController::class), 'get_welcome_reward_preview'], 'permission_callback' => $permission_public]);
        register_rest_route($v2_namespace, '/unauthenticated/claim', ['methods' => 'POST', 'callback' => [$this->container->get(Api\ClaimController::class), 'process_unauthenticated_claim'], 'permission_callback' => $permission_public]);
        register_rest_route($v2_namespace, '/auth/register-with-token', ['methods' => 'POST', 'callback' => [$this->container->get(Api\AuthController::class), 'register_with_token'], 'permission_callback' => $permission_public]);
        register_rest_route($v2_namespace, '/auth/register', ['methods' => 'POST', 'callback' => [$this->container->get(Api\AuthController::class), 'register_user'], 'permission_callback' => $permission_public]);
        register_rest_route($v2_namespace, '/auth/login', ['methods' => 'POST', 'callback' => [$this->container->get(Api\AuthController::class), 'login_user'], 'permission_callback' => $permission_public]);
        register_rest_route($v1_namespace, '/password/request', ['methods' => 'POST', 'callback' => [$this->container->get(Api\AuthController::class), 'request_password_reset'], 'permission_callback' => $permission_public]);
        register_rest_route($v1_namespace, '/password/reset', ['methods' => 'POST', 'callback' => [$this->container->get(Api\AuthController::class), 'perform_password_reset'], 'permission_callback' => $permission_public]);
        register_rest_route($v2_namespace, '/app/config', ['methods' => 'GET', 'callback' => [$this->container->get(Services\ConfigService::class), 'get_app_config'], 'permission_callback' => $permission_auth]);
        
        register_rest_route($v2_namespace, '/users/me/session', ['methods' => 'GET', 'callback' => function() { 
            $user_service = $this->container->get(Services\UserService::class);
            $session_dto = $user_service->get_user_session_data(get_current_user_id());
            return Api\ApiResponse::success((array) $session_dto);
        }, 'permission_callback' => $permission_auth]);
        
        register_rest_route($v2_namespace, '/actions/claim', ['methods' => 'POST', 'callback' => [$this->container->get(Api\ClaimController::class), 'process_claim'], 'permission_callback' => $permission_auth]);
        register_rest_route($v2_namespace, '/actions/redeem', ['methods' => 'POST', 'callback' => [$this->container->get(Api\RedeemController::class), 'process_redemption'], 'permission_callback' => $permission_auth]);
        
        register_rest_route($v2_namespace, '/users/me/profile', [
            ['methods' => 'GET', 'callback' => [$this->container->get(Api\ProfileController::class), 'get_profile'], 'permission_callback' => $permission_auth], 
            ['methods' => 'POST', 'callback' => [$this->container->get(Api\ProfileController::class), 'update_profile'], 'permission_callback' => $permission_auth]
        ]);
        
        register_rest_route($v2_namespace, '/users/me/history', ['methods' => 'GET', 'callback' => [$this->container->get(Api\HistoryController::class), 'get_history'], 'permission_callback' => $permission_auth]);
        register_rest_route($v2_namespace, '/users/me/orders', ['methods' => 'GET', 'callback' => [$this->container->get(Api\OrdersController::class), 'get_orders'], 'permission_callback' => $permission_auth]);
        register_rest_route($v2_namespace, '/users/me/referrals', ['methods' => 'GET', 'callback' => [$this->container->get(Api\ReferralController::class), 'get_my_referrals'], 'permission_callback' => $permission_auth]);
        register_rest_route($v2_namespace, '/catalog/products', ['methods' => 'GET', 'callback' => [$this->container->get(Api\CatalogController::class), 'get_products'], 'permission_callback' => $permission_auth]);
        register_rest_route($v2_namespace, '/catalog/products/(?P<id>[\d]+)', ['methods' => 'GET', 'callback' => [$this->container->get(Api\CatalogController::class), 'get_product'], 'permission_callback' => $permission_auth]);
        register_rest_route($v2_namespace, '/pages/(?P<slug>[a-zA-Z0-9-]+)', ['methods' => 'GET', 'callback' => [$this->container->get(Api\PageController::class), 'get_page'], 'permission_callback' => $permission_auth]);
    }
}
</file>

<file path="includes/CannaRewards/Services/EconomyService.php">
<?php
namespace CannaRewards\Services;

use CannaRewards\Includes\Event;
use CannaRewards\Repositories\RewardCodeRepository;
use CannaRewards\Repositories\ProductRepository;
use Exception;
use Psr\Container\ContainerInterface;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * Economy Service (A Pure Command Bus)
 */
class EconomyService {
    private ActionLogService $action_log_service;
    private ContextBuilderService $context_builder;
    private ?UserService $user_service = null;
    private array $command_map = [];
    private RewardCodeRepository $reward_code_repository;
    private ProductRepository $product_repository;
    private array $policy_map = [];
    private ContainerInterface $container;
    private RankService $rankService;

    public function __construct(
        ActionLogService $action_log_service,
        ContextBuilderService $context_builder,
        RewardCodeRepository $reward_code_repository,
        ProductRepository $product_repository,
        ContainerInterface $container,
        array $policy_map,
        RankService $rankService
    ) {
        $this->action_log_service = $action_log_service;
        $this->context_builder    = $context_builder;
        $this->reward_code_repository = $reward_code_repository;
        $this->product_repository = $product_repository;
        $this->container = $container;
        $this->policy_map = $policy_map;
        $this->rankService = $rankService;

        // Listen for the event broadcast by other services like ReferralService.
        Event::listen('points_to_be_granted', [$this, 'handle_grant_points_event']);
    }

    /**
     * Handles the event to grant points by dispatching the secure command.
     */
    public function handle_grant_points_event(array $payload) {
        if (isset($payload['user_id'], $payload['points'], $payload['description'])) {
            $command = new \CannaRewards\Commands\GrantPointsCommand(
                (int) $payload['user_id'],
                (int) $payload['points'],
                (string) $payload['description']
            );
            $this->handle($command);
        }
    }

    public function set_user_service(UserService $user_service) {
        $this->user_service = $user_service;
    }

    public function registerCommandHandler(string $command_class, object $handler_instance): void {
        $this->command_map[$command_class] = $handler_instance;
    }

    public function handle($command) {
        $command_class = get_class($command);

        $policies_for_command = $this->policy_map[$command_class] ?? [];
        foreach ($policies_for_command as $policy_class) {
            $policy = $this->container->get($policy_class);
            $policy->check($command);
        }

        if (!isset($this->command_map[$command_class])) {
            throw new Exception("No handler registered for command: {$command_class}");
        }
        $handler = $this->command_map[$command_class];

        if (method_exists($handler, 'setEconomyService')) {
            $handler->setEconomyService($this);
        }

        return $handler->handle($command);
    }

    /**
     * Checks for rank transitions. This method is public so the
     * GrantPointsCommandHandler can call it.
     */
    public function check_and_apply_rank_transition( int $user_id ) {
        $current_rank_key = get_user_meta( $user_id, '_canna_current_rank_key', true ) ?: 'member';
        
        $new_rank_dto = $this->rankService->getUserRank($user_id);
        $new_rank_key = $new_rank_dto->key;

        if ( $new_rank_key !== $current_rank_key ) {
            update_user_meta( $user_id, '_canna_current_rank_key', $new_rank_key );
            
            $all_ranks_dtos = $this->rankService->getRankStructure();
            $all_ranks = array_reduce($all_ranks_dtos, function ($carry, $item) {
                $carry[$item->key] = (array) $item;
                return $carry;
            }, []);
            
            $old_rank_object = $all_ranks[ $current_rank_key ] ?? null;
            $new_rank_object = $all_ranks[ $new_rank_key ] ?? null;
            
            $context = $this->context_builder->build_event_context($user_id);

            Event::broadcast('user_rank_changed', array_merge($context, [
                'old_rank' => $old_rank_object,
                'new_rank' => $new_rank_object,
            ]));
        }
    }
}
</file>

<file path="includes/CannaRewards/Services/UserService.php">
<?php
namespace CannaRewards\Services;

use CannaRewards\DTO\FullProfileDTO;
use CannaRewards\DTO\RankDTO;
use CannaRewards\DTO\SessionUserDTO;
use CannaRewards\DTO\ShippingAddressDTO;
use Exception;
use Psr\Container\ContainerInterface;

// Exit if accessed directly.
if ( ! defined( 'WPINC' ) ) {
    die;
}

/**
 * User Service (Command Bus & Data Fetcher)
 */
class UserService {
    private array $command_map = [];
    private CDPService $cdp_service;
    private ActionLogService $action_log_service;
    private ?ReferralService $referral_service = null;
    private array $policy_map = [];
    private ContainerInterface $container;
    private RankService $rankService;

    public function __construct(
        CDPService $cdp_service,
        ActionLogService $action_log_service,
        ContainerInterface $container,
        array $policy_map,
        RankService $rankService
    ) {
        $this->cdp_service = $cdp_service;
        $this->action_log_service = $action_log_service;
        $this->container = $container;
        $this->policy_map = $policy_map;
        $this->rankService = $rankService;
    }

    public function set_referral_service(ReferralService $referral_service): void {
        $this->referral_service = $referral_service;
    }
    
    public function registerCommandHandler(string $command_class, object $handler_instance): void {
        $this->command_map[$command_class] = $handler_instance;
    }

    public function handle($command) {
        $command_class = get_class($command);
        
        $policies_for_command = $this->policy_map[$command_class] ?? [];
        foreach ($policies_for_command as $policy_class) {
            $policy = $this->container->get($policy_class);
            $policy->check($command);
        }

        if (!isset($this->command_map[$command_class])) {
            throw new Exception("No handler registered for user command: {$command_class}");
        }
        $handler = $this->command_map[$command_class];

        if (method_exists($handler, 'setReferralService')) {
            $handler->setReferralService($this->referral_service);
        }

        return $handler->handle($command);
    }
    
    public function get_user_session_data( int $user_id ): SessionUserDTO {
        $user = get_userdata($user_id);
        if (!$user) {
            throw new Exception("User with ID {$user_id} not found.");
        }

        $rank_dto = $this->rankService->getUserRank($user_id);

        $shipping_address = [
            'shipping_first_name' => get_user_meta($user_id, 'shipping_first_name', true),
            'shipping_last_name'  => get_user_meta($user_id, 'shipping_last_name', true),
            'shipping_address_1'  => get_user_meta($user_id, 'shipping_address_1', true),
            'shipping_city'       => get_user_meta($user_id, 'shipping_city', true),
            'shipping_state'      => get_user_meta($user_id, 'shipping_state', true),
            'shipping_postcode'   => get_user_meta($user_id, 'shipping_postcode', true),
        ];

        $session_dto = new SessionUserDTO();
        $session_dto->id = $user_id;
        $session_dto->firstName = $user->first_name;
        $session_dto->lastName = $user->last_name;
        $session_dto->email = $user->user_email;
        $session_dto->points_balance = get_user_points_balance($user_id);
        $session_dto->rank = $rank_dto;
        $session_dto->shipping = $shipping_address;
        $session_dto->referral_code = get_user_meta($user_id, '_canna_referral_code', true) ?: null;
        $session_dto->onboarding_quest_step = (int) get_user_meta($user_id, '_onboarding_quest_step', true) ?: 1;
        $session_dto->feature_flags = new \stdClass();

        return $session_dto;
    }
    
    public function get_full_profile_data( int $user_id ): FullProfileDTO {
        $user = get_userdata($user_id);
        if (!$user) {
            throw new Exception("User with ID {$user_id} not found.");
        }

        $custom_fields_definitions = canna_get_custom_fields_definitions();
        $custom_fields_values      = [];
        foreach ($custom_fields_definitions as $field) {
            $value = get_user_meta($user_id, $field['key'], true);
            if (!empty($value)) {
                $custom_fields_values[$field['key']] = $value;
            }
        }
        
        $shipping_dto = new ShippingAddressDTO();
        $shipping_dto->first_name = get_user_meta($user_id, 'shipping_first_name', true);
        $shipping_dto->last_name = get_user_meta($user_id, 'shipping_last_name', true);
        $shipping_dto->address_1 = get_user_meta($user_id, 'shipping_address_1', true);
        $shipping_dto->city = get_user_meta($user_id, 'shipping_city', true);
        $shipping_dto->state = get_user_meta($user_id, 'shipping_state', true);
        $shipping_dto->postcode = get_user_meta($user_id, 'shipping_postcode', true);

        $profile_dto = new FullProfileDTO();
        $profile_dto->lastName = $user->last_name;
        $profile_dto->phone_number = get_user_meta($user_id, 'phone_number', true);
        $profile_dto->referral_code = get_user_meta($user_id, '_canna_referral_code', true);
        $profile_dto->shipping_address = $shipping_dto;
        $profile_dto->unlocked_achievement_keys = [];
        $profile_dto->custom_fields = (object) [
            'definitions' => $custom_fields_definitions,
            'values'      => (object) $custom_fields_values,
        ];

        return $profile_dto;
    }

    public function get_user_dashboard_data( int $user_id ): array {
        return [
            'lifetime_points' => get_user_lifetime_points( $user_id ),
        ];
    }
}
</file>

<file path="cannarewards-engine.php">
<?php
/**
 * Plugin Name:       CannaRewards Engine
 * Plugin URI:        https://yourwebsite.com/
 * Description:       The all-in-one, self-reliant engine for the CannaRewards PWA.
 * Version:           2.1.0
 * Author:            Anwar Isbased
 * Author URI:        https://yourwebsite.com/
 * Text Domain:       canna-rewards
 *
 * @package CannaRewards
 */

// Exit if accessed directly.
if (!defined('WPINC')) {
    die;
}

// Define plugin constants.
define('CANNA_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('CANNA_PLUGIN_FILE', __FILE__);

// 1. Include the Composer Autoloader.
require_once CANNA_PLUGIN_DIR . 'vendor/autoload.php';

// 2. Include the procedural functions file.
require_once CANNA_PLUGIN_DIR . 'includes/canna-core-functions.php';

/**
 * The main function for returning the CannaRewardsEngine instance.
 * It builds the DI container and boots the application.
 */
function CannaRewards() {
    // This is the new bootstrap process.
    // 1. Build the container from our new, smart bootstrap file.
    $container = require CANNA_PLUGIN_DIR . 'includes/container.php';
    
    // 2. Ask the container for the main engine instance.
    // The CannaRewardsEngine class itself is now managed by the container.
    return $container->get(CannaRewards\CannaRewardsEngine::class);
}

// Get the plugin running.
CannaRewards();
</file>

</files>
